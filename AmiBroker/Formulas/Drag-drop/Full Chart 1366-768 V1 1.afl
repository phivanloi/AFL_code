

_SECTION_BEGIN("Price");
SetChartOptions(0,chartShowArrows|chartShowDates);
_N(Title = StrFormat("{{NAME}} - {{INTERVAL}} {{DATE}} Open %g, Hi %g, Lo %g, Close %g (%.1f%%) {{VALUES}}", O, H, L, C, SelectedValue( ROC( C, 1 ) ) ));
Plot( C, "Close", ParamColor("Color", colorDefault ), styleNoTitle | ParamStyle("Style") | GetPriceStyle() ); 
_SECTION_END();


////////////////////
nbar = Param("Chon So Ngay",5,2,100,1); 
sr=ParamToggle("Plot Supp/Res lines","No|Yes" ,0);
//strength = Param("Strength",5,2,15,1);									// Best use: 3, 4, 5
strength = Param("BARS of each LINE",5,2,15,1);							// So luong bar cho moi duong XA, AB, BC, 
bu = ParamToggle("Bullish Pattern","Off|On",0);							// So bar/lines se quyet dinh. mo^ hinh` duoc ve the' nao`
be = ParamToggle("Bearish Pattern","Off|On",0);
// 01. MAU NEN
{
//_SECTION_BEGIN("Background_Setting");
//SetChartBkGradientFill( ParamColor("BgTop", colorDarkGrey),
//ParamColor("BgBottom", colorDarkGrey),ParamColor("titleblock",colorDarkGrey ));
//_SECTION_END();
}
_SECTION_BEGIN("Bollinger Bands");
P = ParamField("Price field",-1);
Periods = Param("Periods", 20, 2, 100, 1 );
Width = Param("Width", 2, 0, 10, 0.05 );
bbb = BBandBot( P, Periods, Width );
bbt = BBandTop( P, Periods, Width);


/////////////////////////////////////////Nen va thong tin
volAvg				=	MA(V,90);
volMean 			= 	StDev(volAvg,30); 
volUpBand3 		= 	volAvg + 3*volMean; 
volUpband2 		= 	volAvg + 2*volMean;; 
volUpBand1 		= 	volAvg + 1*volMean;; 
volDnBand1 		= 	volAvg -1*volMean; 
volDnBand2 		= 	volAvg -2*volMean; 
midprice			=	(H+L)/2;
spread				=	(H-L);
avgSpread			=	MA(spread,90);
wideRangeBar		=	spread>(1.5*avgSpread);
narrowRangeBar	=	spread<(0.7*avgSpread);
lowVolume			=	V<Ref(V,-1) AND V<Ref(V,-2);
upBar				=	C>Ref(C,-1); 
downBar			=	C<Ref(C,-1); 
highVolume			=	V>Ref(V,-1) AND Ref(V,-1)>Ref(V,-2);
closeFactor		=	C-L;
clsPosition		=	spread/closeFactor;
closePosition		=	IIf(closeFactor=0,avgSpread,clsPosition);
Vb					=	V>volAvg OR V>Ref(V,-1);
upClose			=	C>=((spread*0.7)+L);// close is above 70% of the Bar
downClose			=	C<=((spread*0.3)+L);// close is below the 30% of the bar
aboveClose			=	C>((spread*0.5)+L);// close is between 50% and 70% of the bar
belowClose			=	C<((spread*0.5)+L);// close is between 50% and 30% of the bar
midClose			=	C>((spread*0.3)+L) AND C<((spread*0.7)+L);// close is between 30% and 70% of the bar
veryLowClose		=	closePosition>4;//close is below 25% of the bar
veryHighClose		=	closePosition<1.35;// Close is above 80% of the bar
ClosePos			= 	IIf(C<=((spread*0.3)+L),1,IIf(C<=((spread*0.5)+L),2,IIf(C<=((spread*0.7)+L),3,4)));
                    // 1 = downclose, 2 = belowclose, 3 = aboveClose, 4 = Upclose
Volpos				=  	IIf(V>volAvg*2,1,IIf(V>volAvg*1.3,2,IIf(V>volAvg,3,IIf(V<volAvg AND V>volAvg*0.7,4,5))));
						// 1 = Very High, 2 = High, 3 = Above Average, 4 = Less than Average, 5 = Low
freshGndHi       =  C > HHV(H,5);
freshGndLo       =  C < LLV(L,5);

//========================Trend Estimation =========================
j=MA(C,5);
trendLongTerm     =  LinRegSlope(j,40) ;
trendMediumTerm   =  LinRegSlope(j,10) ;
trendShortTerm    =  LinRegSlope(j,3);
tls=LinRegSlope(j,3);

//=========================================================================|
//                    Trend Analysis Module                                |
//=========================================================================|
 minperiodsRWIst = Param ( "Short term Min Periods", 2, 1, 9, 1); 
 maxperiodsRWIst = Param ( "Short term Max Periods", 8, 1, 9, 1); 

 minperiodsRWIlt = Param ( "Long Term Min Periods", 10, 1, 32, 1); 
 maxperiodsRWIlt = Param ( "Long term Max Periods", 40, 1, 64, 1);  

 Ground = RWIHi (minperiodsRWIst, maxperiodsRWIst); 
 Sky    = RWILo (minperiodsRWIst, maxperiodsRWIst);  
 j      = RWI(minperiodsRWIlt, maxperiodsRWIlt);
 k      =  RWI(minperiodsRWIst, maxperiodsRWIst);
 j2     = RWIHi (minperiodsRWIlt, maxperiodsRWIlt); 
 k2     = RWILo (minperiodsRWIlt, maxperiodsRWIlt); 
 ja     = Cross(j,1); // The followign section check the diffeent condition of the RWi above and below zero
 jb     = Cross(1,j); // In oder to check which trend is doing what
 jc     = Cross(-1,j);
 jd     = Cross(j,-1);
 j2a    = Cross(j2,1);
 j2b    = Cross(1,j2);
 k2a    = Cross(k2,1);
 k2b    = Cross(1,k2);
//Define the Major, Minor and Immediate trend Sttatus
upmajoron   = j > 1 AND Ref(ja,-1);
upmajoroff  = j < 1 AND Ref(jb,-1);
upminoron   = j2 > 1 AND Ref(j2a,-1);
upminoroff  = j2 < 1 AND Ref(j2b,-1);
dnmajoron   = j < -1 AND Ref(jc,-1);
dnmajoroff  = j > -1 AND Ref(jd,-1);
dnminoron   = k2 > 1 AND Ref(k2a,-1);
dnminoroff  = k2 < 1 AND Ref(k2b,-1);
upimd       = IIf(ground > 1, 1,0);
dnimd       = IIf(sky > 1, 1, 0);
upmajor     = IIf(j>1,1,IIf(j<(-1),-1,0));
upminor     = IIf(j2>1,1,-1);
dnminor     = IIf(k2>1,1,-1);
//======================================================================|
//                      VSA Signal generation                           |
//======================================================================| 


upThrustBar		=	wideRangeBar AND downClose  AND trendShortTerm>0 AND H>Ref(H,-1);//WRB and UHS and Fresh Ground
nut              =   wideRangeBar AND downClose  AND freshGndHi AND HighVolume;// NEW SIGNAL
bc               =    wideRangeBar AND aboveclose AND V == HHV(V,60) AND upmajor==1;// NEW SIGNAL
upThrustBartrue	=	wideRangeBar AND downClose AND upmajor>0 AND H>Ref(H,-1);//occurs after a major uptrend
upThrustTHV		=	upThrustBartrue AND (VolPos == 2 OR VolPos == 1);
upThrustCond1		=	Ref(upThrustBar,-1) AND downBar ;
upThrustCond2		=	Ref(upThrustBar,-1) AND downBar AND VolPos == 2;
upThrustCond3		=	upThrustBar AND VolPos ==1;
topRevBar			=	Ref(V,-1)>volAvg  AND Ref(upBar,-1) AND Ref(wideRangeBar,-1) AND downBar AND downClose AND wideRangeBar AND trendLongTerm>0 AND H==HHV(H,10);
PseudoUpThrust	=	Ref(upBar,-1) AND Ref(V,-1)>1.5*volAvg AND downBar AND downClose AND  NOT upThrustBar;
pseudoUtCond		=	Ref(PseudoUpThrust,-1) AND downBar AND downClose AND NOT upThrustBar;
trendChange		=	Ref(upBar,-1) AND H==HHV(H,5)AND downBar AND (downClose OR midClose) AND V>volAvg AND NOT wideRangeBar AND NOT PseudoUpThrust ;
sellCond1			=	(upThrustCond1 OR upThrustCond2 OR upThrustCond3) ;
sellCond2			=	Ref(sellCond1,-1)==0;
sellCond			=	sellCond1 AND sellCond2;
strengthDown0		= 	trendLongTerm<0 AND V>Ref(V,-1) AND Ref(downBar,-1) AND upBar AND (upClose OR midClose) AND trendShortTerm<0 AND trendMediumTerm<0;// strength after a long down trend
strengthDown		= 	V>Ref(V,-1) AND Ref(downBar,-1) AND upBar AND (upclose OR midClose) AND trendShortTerm<0 AND trendMediumTerm<0;// Strength after a down trend
strengthDown1		= 	trendLongTerm<0 AND V>(volAvg*1.5) AND Ref(downBar,-1) AND upBar AND (upClose OR midClose)AND trendShortTerm<0 AND trendMediumTerm<0;//Strength after downtrend . High volume
strengthDown2		=	trendShortTerm<0 AND Ref(V,-1)<volAvg  AND upBar AND veryHighClose AND V>volAvg;
buyCond1			= 	strengthDown OR strengthDown1;
buyCond			= 	upBar  AND Ref(buyCond1,-1);
stopVolume			= 	L==LLV(L,5)  AND (upClose OR midClose) AND V>1.5*volAvg AND trendLongTerm<0;
bullBar			=	(V>volAvg OR V>Ref(V,-1)) AND closePosition <2 AND upBar ;
bearBar			=	vb  AND downClose AND downBar AND spread>avgSpread;
noDemandBar		=	upBar AND narrowRangeBar AND lowVolume  AND belowClose ;
strengthUp			= 	trendShortTerm>0 AND trendLongTerm<0 AND upBar AND V>Ref(V,-1) AND V>Ref(V,-2) AND upClose;
strengthBar		=	trendLongTerm>0 AND upBar AND V>Ref(V,-1) AND V>Ref(V,-2) AND upClose;
weakBar			=	trendLongTerm>0 AND trendShortTerm>0 AND spread>avgSpread AND veryLowClose;
weakUp				=	Ref(upBar,-1)AND Ref(wideRangeBar,-1)AND Ref(V,-1)>(2*volAvg) AND downBar AND V<Ref(V,-1) AND trendShortTerm>0;
noSupplyBar		=	downBar AND narrowRangeBar AND lowVolume  AND belowClose ;
revUpThrust		=	trendLongTerm<0 AND upBar AND upClose AND V>Ref(V,-1) AND V>volAvg AND  wideRangeBar AND Ref(downBar,-1) AND Ref(downClose,-1);
noBuyPress			= 	C>Ref(C,-1) AND lowVolume AND narrowRangeBar AND aboveClose;
ownerTransfer		=	wideRangeBar  AND V>(1.5*volAvg)AND midClose;
interSupport		=	trendShortTerm<0 AND trendLongTerm>0 AND upBar AND L<Ref(L,-1) AND L<Ref(L,-2) AND upClose;
confirmWeak		= 	Ref(topRevBar,-1) AND downBar AND V>Ref(V,-1) AND downClose;
testbar			=	L==LLV(L,5) AND upClose AND lowVolume;
testBar1			=	L==LLV(L,5) AND upClose AND wideRangeBar AND trendLongTerm<0 AND trendMediumTerm<0 AND lowVolume ;
lowVolTest    	=	lowVolume AND L<Ref(L,-1) AND upClose;
lowVolTest1		= 	V<volAvg AND L<Ref(L,-1) AND upClose AND trendLongTerm>0 AND trendMediumTerm>0 AND wideRangeBar;
lowVolTest2		= 	Ref(lowVolTest,-1) AND upBar AND upClose;
confirmStrength	= 	Ref(lowVolTest,-1) AND upBar AND V>Ref(V,-1) AND upClose AND trendShortTerm<0;
distributeBar		= 	V>2*volAvg AND downClose AND upBar AND trendShortTerm>0 AND trendMediumTerm>0 AND NOT sellCond1 AND NOT upThrustBar;
confirmWeak1		=	Ref(pseudoUtCond,-1) AND L<Ref(L,-1);
effortUp			=	H>Ref(H,-1) AND L>Ref(L,-1) AND C>Ref(C,-1) AND C>=((H-L)*0.7+L) AND spread>avgSpread AND V>Ref(V,-1);//AND O<=((H-L)*0.3+L) 
effortUpfail		=	Ref(effortUp,-1) AND (upThrustBar OR upThrustCond1 OR upThrustCond2 OR upThrustCond3);
effortDown			=	H<Ref(H,-1) AND L<Ref(L,-1) AND C<Ref(C,-1) AND  C<=((H-L)*0.25+L) AND spread>avgSpread AND V>Ref(V,-1);//O>=((H-L)*0.75+L) AND
PlotShapes(shapeSmallCircle*buyCond, colorCustom10, 0, L, -30 );
PlotShapes(shapeSmallCircle*strengthDown, colorLime, 0, L, -20 );
PlotShapes(shapeSmallCircle*strengthDown1, colorLime, 0, L, -20 );
PlotShapes(shapeSmallCircle*lowVolTest1, colorLime, 0, L, -20 );
PlotShapes(shapeSmallCircle*noDemandBar, ColorRGB(255,128,192), 0, H, 20);
PlotShapes(shapeSmallCircle*lowVolTest, ColorRGB(255,128,192), 0, L, -20);
PlotShapes(shapeSmallCircle*trendChange , colorOrange, 0, H, 20 );
PlotShapes(shapeSmallCircle*lowVolTest2, colorTeal, 0, L, -20 );
PlotShapes(shapeSmallCircle*(upThrustBar ) , colorRed, 0, H, 20 );
//////////
buyCondstatus=WriteIf(buyCond,"                                                                 - Nut vang da^.m: Dong cua lon hon dong cua (ngay truoc) va tin hieu manh sau downtrend [volume lon] (ngay truoc).\n","");
strengthDownstatus=WriteIf(strengthDown,"                                                                 - Nut colorLime: Tin hieu manh sau downtrend.\n","");
strengthDown1status=WriteIf(strengthDown1,"                                                                 - Nut colorLime: Tin hieu manh sau downtrend voi volume lon.\n","");
lowVolTest1status=WriteIf(lowVolTest1,"                                                                 - Nut colorLime: Nen bien do rong, nen dong cua lon hon 70% nen, day nen thap hon ngay truoc, V>MA(V,90) va trendLongTerm>0 AND trendMediumTerm>0.\n","");
noDemandBarstatus=WriteIf(noDemandBar, "                                                                 - Nut hong nhat:Dong cua lon hon dong cua (ngay truoc), nen bien range nho, V nho hon 2 ngay truoc, dong cua giua 30% va 50% nen.\n","");
lowVolTeststatus=WriteIf(lowVolTest,"                                                                 - Nut hong nhat: V nho hon 2 ngay truoc, day nen thap hon ngay truoc, nen dong cua lon hon 70% nen.\n","");
trendChangestatus=WriteIf(trendChange,"                                                                 - Nut mau cam: Gia dong cua duoi 30% nen ( giua 30 va70% nen), V>MA(V,90), khong phai nen bien do rong,...\n","");
lowVolTest2status=WriteIf(lowVolTest2,"                                                                 - Nut mau colorTeal: nen hien tai va truoc do dong cua lon hon 70% nen; nen tang gia so voi ngay truoc, \n ngay truoc: co Volume nho hon 2 ngay truoc do va co Day thap hon ngay truoc.\n","");
upThrustBarstatus=WriteIf(upThrustBar,"                                                                 - Nut mau colorred: Nen bien do rong, Gia dong cua duoi 30% nen, dinh cao hon ngay truoc,trendShortTerm>0.\n","");
///////////////
thongtinnen=
WriteIf (upThrustBartrue, " An Upthrust Bar after upmove. A Sure sign of weakness. ","")+
WriteIf (upThrustBar AND NOT upThrustBartrue, " An Upthrust Bar. A sign of weakness. ","")+
WriteIf (upThrustCond1, " A downbar after an Upthrust. Confirm weakness. ","")+
WriteIf (upThrustCond2 AND NOT upThrustCond1, " A High Volume downbar after an Upthrust. Confirm weakness.","")+
WriteIf (upThrustCond3, "This upthrust at very High Voume, Confirms weakness","")+
WriteIf (strengthDown1, "Strength seen returning after a down trend. High volume adds to strength. ","")+
WriteIf (strengthDown0 AND NOT strengthDown, "Strength seen returning after a down trend. ","")+
WriteIf (strengthDown AND NOT strengthDown1, "Strength seen returning after a down trend. ","")+
WriteIf (lowVolTest, "Test for supply. ","")+
WriteIf (lowVolTest2, "An upBar closing near High after a Test confirms strength. ","")+
WriteIf (buyCond, "An upBar closing near High. Confirms return of Strength. ","")+
WriteIf (distributeBar, "A High Volume Up Bar closing down in a uptrend shows Distribution. ","")+
WriteIf (PseudoUpThrust, "Psuedo UpThrust.   A Sign of Weakness. ","")+
WriteIf (pseudoUtCond, "A Down Bar closing down after a Pseudo Upthrust confirms weakness. ","")+
WriteIf (lowVolTest1, "Test for supply in a uptrend. Sign of Strength. ","")+
WriteIf (strengthDown2, "High volume upBar closing on the high indicates strength. ","")+
WriteIf (trendChange, "High volume Downbar after an upmove on high volume indicates weakness. ","")+
WriteIf (noDemandBar, "No Demand. A sign of Weakness. ","")+
WriteIf (noSupplyBar, "No Supply. A sign of Strength. ","")+
WriteIf (stopVolume, "Stopping volume. Normally indicates end of bearishness is nearing. ","")+
WriteIf (revUpThrust, "Reverse upthrust. Indicates strength. ","")+
WriteIf (effortUp, "Effort to Rise. Bullish sign ","")+
WriteIf (effortDown, "Effort to Fall. Bearish sign ","")+
WriteIf (effortUpfail, "Effort to Move up has failed. Bearish sign ","")+
WriteIf (bc,"Potential Buying climax","");
//////////////////Nen va thong tin
//====================================================================================|
//                       Support & Resistance  Lines                                  |
//====================================================================================|
//_SECTION_BEGIN("RS Lines");
// AFL By Karthikmarar
// RESISTANCE AND SUPPORT LINES AFL VERSION 2.00
// Provids upto total 20 lines. Two Adjustable Parameters. 1) Sensitivity and 2) Number of lines
// Depending on the Share Volatility, the Sensitivity Factor can be adjusted
// Support Lines are colored Blue and Resistance Line are colored Red.

Per=Param("Sensitivity",6,2,15,1);
g=Param("No.of Lines",5,1,10,1);
volAvg				=	MA(V,90);
j=MA(C,5);
trendLongTerm     =  LinRegSlope(j,40) ;
trendMediumTerm   =  LinRegSlope(j,10) ;
trendShortTerm    =  LinRegSlope(j,3);
tls=LinRegSlope(j,3);
x=Cum(1);
Pk1=PeakBars(H,per,1)== 0;
Tk1=TroughBars(L,per,1)== 0;
//peak detection
px1=LastValue(ValueWhen(pk1,x,1));
px2=LastValue(ValueWhen(Pk1,x,2));
px3=LastValue(ValueWhen(Pk1,x,3));
px4=LastValue(ValueWhen(pk1,x,4));
px5=LastValue(ValueWhen(Pk1,x,5));
px6=LastValue(ValueWhen(Pk1,x,6));
px7=LastValue(ValueWhen(pk1,x,7));
px8=LastValue(ValueWhen(Pk1,x,8));
px9=LastValue(ValueWhen(Pk1,x,9));
px10=LastValue(ValueWhen(Pk1,x,10));
//Trough  Detection
tx1=LastValue(ValueWhen(Tk1,x,1));
tx2=LastValue(ValueWhen(Tk1,x,2));
tx3=LastValue(ValueWhen(Tk1,x,3));
tx4=LastValue(ValueWhen(Tk1,x,4));
tx5=LastValue(ValueWhen(Tk1,x,5));
tx6=LastValue(ValueWhen(Tk1,x,6));
tx7=LastValue(ValueWhen(Tk1,x,7));
tx8=LastValue(ValueWhen(Tk1,x,8));
tx9=LastValue(ValueWhen(Tk1,x,9));
tx10=LastValue(ValueWhen(Pk1,x,10));
//values when Peaks occured
XT1 =LastValue(ValueWhen(pk1,H,1));
XT2 =LastValue(ValueWhen(Pk1,H,2));
XT3 =LastValue(ValueWhen(Pk1,H,3));
XT4 =LastValue(ValueWhen(pk1,H,4));
XT5 =LastValue(ValueWhen(Pk1,H,5));
XT6 =LastValue(ValueWhen(Pk1,H,6));
XT7 =LastValue(ValueWhen(pk1,H,7));
XT8 =LastValue(ValueWhen(Pk1,H,8));
XT9 =LastValue(ValueWhen(Pk1,H,10));
XT10 =LastValue(ValueWhen(Pk1,H,10));
//Value when troughs occured
YT1 =LastValue(ValueWhen(tk1,L,1));
YT2 =LastValue(ValueWhen(tk1,L,2));
YT3 =LastValue(ValueWhen(tk1,L,3));
YT4 =LastValue(ValueWhen(tk1,L,4));
YT5 =LastValue(ValueWhen(tk1,L,5));
YT6 =LastValue(ValueWhen(tk1,L,6));
YT7 =LastValue(ValueWhen(tk1,L,7));
YT8 =LastValue(ValueWhen(tk1,L,8));
YT9 =LastValue(ValueWhen(tk1,L,10));
YT10 =LastValue(ValueWhen(tk1,L,10));
LastBar = Cum(1) == LastValue(Cum(1));
//plot peak lines
Plot(IIf(x>px1 AND g>=1 AND sr,XT1,Null),"P1",IIf( LastValue(C)>XT1, colorPaleGreen, colorRed ));
Plot(IIf(x>px2 AND g>=2 AND sr,XT2,Null),"P2",IIf( LastValue(C)>XT2, colorPaleGreen, colorRed ));
Plot(IIf(x>px3 AND g>=3 AND sr,XT3,Null),"P3",IIf( LastValue(C)>XT3, colorPaleGreen, colorRed ));
Plot(IIf(x>px4 AND g>=4 AND sr,XT4,Null),"P4",IIf( LastValue(C)>XT4, colorPaleGreen, colorRed ));
Plot(IIf(x>px5 AND g>=5 AND sr,XT5,Null),"P5",IIf( LastValue(C)>XT5, colorPaleGreen, colorRed ));
Plot(IIf(x>px6 AND g>=6 AND sr,XT6,Null),"P6",IIf( LastValue(C)>XT6, colorPaleGreen, colorRed ));
Plot(IIf(x>px7 AND g>=7 AND sr,XT7,Null),"P7",IIf( LastValue(C)>XT7, colorPaleGreen, colorRed ));
Plot(IIf(x>px8 AND g>=8 AND sr,XT8,Null),"P8",IIf( LastValue(C)>XT8, colorPaleGreen, colorRed ));
Plot(IIf(x>px9 AND g>=9 AND sr,XT9,Null),"P9",IIf( LastValue(C)>XT9, colorPaleGreen, colorRed ));
Plot(IIf(x>px10 AND g>=10 AND sr,XT10,Null),"P10",IIf( LastValue(C)>XT10, colorPaleGreen, colorRed ));
//plot Trough lines
Plot(IIf(x>tx1 AND g>=1 AND sr,YT1,Null),"T1",IIf( LastValue(C)>YT1, colorPaleGreen, colorRed ));
Plot(IIf(x>tx2 AND g>=2 AND sr,YT2,Null),"T2",IIf( LastValue(C)>YT2, colorPaleGreen, colorRed ));
Plot(IIf(x>tx3 AND g>=3 AND sr,YT3,Null),"T3",IIf( LastValue(C)>YT3, colorPaleGreen, colorRed ));
Plot(IIf(x>tx4 AND g>=4 AND sr,YT4,Null),"T4",IIf( LastValue(C)>YT4, colorPaleGreen, colorRed ));
Plot(IIf(x>tx5 AND g>=5 AND sr,YT5,Null),"T5",IIf( LastValue(C)>YT5, colorPaleGreen, colorRed ));
Plot(IIf(x>tx6 AND g>=6 AND sr,YT6,Null),"T6",IIf( LastValue(C)>YT6, colorPaleGreen, colorRed ));
Plot(IIf(x>tx7 AND g>=7 AND sr,YT7,Null),"T7",IIf( LastValue(C)>YT7, colorPaleGreen, colorRed ));
Plot(IIf(x>tx8 AND g>=8 AND sr,YT8,Null),"T8",IIf( LastValue(C)>YT8, colorPaleGreen, colorRed ));
Plot(IIf(x>tx9 AND g>=9 AND sr,YT9,Null),"T9",IIf( LastValue(C)>YT9, colorPaleGreen, colorRed ));
Plot(IIf(x>tx10 AND g>=10 AND sr,YT10,Null),"T10",IIf( LastValue(C)>YT10, colorPaleGreen, colorRed ));
//Crossing Resistance Lines
xt1c=Cross(C,xt1);
xt2c=Cross(C,xt2);
xt3c=Cross(C,xt3);
xt4c=Cross(C,xt4);
xt5c=Cross(C,xt5);
xt6c=Cross(C,xt6);
xt7c=Cross(C,xt7);
xt8c=Cross(C,xt8);
xt9c=Cross(C,xt9);
xt10c=Cross(C,xt10);
//Breaking support Lines
yt1c=Cross(yt1,C);
yt2c=Cross(yt2,C);
yt3c=Cross(yt3,C);
yt4c=Cross(yt4,C);
yt5c=Cross(yt5,C);
yt6c=Cross(yt6,C);
yt7c=Cross(yt7,C);
yt8c=Cross(yt8,C);
yt9c=Cross(yt9,C);
yt10c=Cross(yt10,C);
//Resistance approaching 
ax1=C<xt1 AND C>xt1*0.97;
ax2=C<xt2 AND C>xt2*0.97;
ax3=C<xt3 AND C>xt3*0.97;
ax4=C<xt4 AND C>xt4*0.97;
ax5=C<xt5 AND C>xt5*0.97;
ax6=C<xt6 AND C>xt6*0.97;
ax7=C<xt7 AND C>xt7*0.97;
ax8=C<xt8 AND C>xt8*0.97;
ax9=C<xt9 AND C>xt9*0.97;
ax10=C<xt10 AND C>xt10*0.97;
//Support approaching
ay1=C>yt1 AND C<yt1*1.03;
ay2=C>yt2 AND C<yt2*1.03;
ay3=C>yt3 AND C<yt3*1.03;
ay4=C>yt4 AND C<yt4*1.03;
ay5=C>yt5 AND C<yt5*1.03;
ay6=C>yt6 AND C<yt6*1.03;
ay7=C>yt7 AND C<yt7*1.03;
ay8=C>yt8 AND C<yt8*1.03;
ay9=C>yt9 AND C<yt9*1.03;
ay10=C>yt10 AND C<yt10*1.03;
//Resistance lines commentary
src1x=xt1c OR xt2c OR xt3c OR xt4c OR xt5c OR xt6c OR xt7c OR xt8c OR xt9c OR xt10c;
src1y=yt1c OR yt2c OR yt3c OR yt4c OR yt5c OR yt6c OR yt7c OR yt8c OR yt9c OR yt10c;
src2x=ax1 OR ax2 OR ax3 OR ax4 OR ax5 OR ax6 OR ax7 OR ax8 OR ax9 OR ax10;
src2y=ay1 OR ay2 OR ay3 OR ay4 OR ay5 OR ay6 OR ay7 OR ay8 OR ay9 OR ay10;
khangcu=
WriteIf(xt1c AND V>volAvg,"                                                                 - Khang cu tai "+WriteVal(xt1,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt1c AND V<volAvg,"                                                                 - Khang cu tai "+WriteVal(xt1,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(xt2c AND V>volAvg,"                                                                 - Khang cu tai "+WriteVal(xt2,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt2c AND V<volAvg,"                                                                 - Khang cu tai "+WriteVal(xt2,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n","" ))+
WriteIf(xt3c AND V>volAvg,"                                                                 - Khang cu tai "+WriteVal(xt3,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt3c AND V<volAvg,"                                                                 - Khang cu tai "+WriteVal(xt3,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n","" ))+
WriteIf(xt4c AND V>volAvg,"                                                                 - Khang cu tai "+WriteVal(xt4,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt4c AND V<volAvg,"                                                                 - Khang cu tai "+WriteVal(xt4,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(xt5c AND V>volAvg,"                                                                 - Khang cu tai "+WriteVal(xt5,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt5c AND V<volAvg,"                                                                 - Khang cu tai "+WriteVal(xt5,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(xt6c AND V>volAvg,"                                                                 - Khang cu tai "+WriteVal(xt6,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt6c AND V<volAvg,"                                                                 - Khang cu tai "+WriteVal(xt6,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(xt7c AND V>volAvg,"                                                                 - Khang cu tai "+WriteVal(xt7,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt7c AND V<volAvg,"                                                                 - Khang cu tai "+WriteVal(xt7,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(xt8c AND V>volAvg,"                                                                 - Khang cu tai "+WriteVal(xt8,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt8c AND V<volAvg,"                                                                 - Khang cu tai "+WriteVal(xt8,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(xt9c AND V>volAvg,"                                                                 - Khang cu tai "+WriteVal(xt9,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt9c AND V<volAvg,"                                                                 - Khang cu tai "+WriteVal(xt9,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(xt10c AND V>volAvg,"                                                                 - Khang cu tai "+WriteVal(xt10,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt10c AND V<volAvg,"                                                                 - Khang cu tai "+WriteVal(xt10,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""));
//Support line breaks Commentary
hotro=
WriteIf(yt1c AND V>volAvg,"                                                                 - Ho tro tai "+WriteVal(yt1,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt1c AND V<volAvg,"                                                                 - Ho tro tai "+WriteVal(yt1,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(yt2c AND V>volAvg,"                                                                 - Ho tro tai "+WriteVal(yt2,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt2c AND V<volAvg,"                                                                 - Ho tro tai "+WriteVal(yt2,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(yt3c AND V>volAvg,"                                                                 - Ho tro tai "+WriteVal(yt3,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt3c AND V<volAvg,"                                                                 - Ho tro tai "+WriteVal(yt3,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(yt4c AND V>volAvg,"                                                                 - Ho tro tai "+WriteVal(yt4,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt4c AND V<volAvg,"                                                                 - Ho tro tai "+WriteVal(yt4,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(yt5c AND V>volAvg,"                                                                 - Ho tro tai "+WriteVal(yt5,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt5c AND V<volAvg,"                                                                 - Ho tro tai "+WriteVal(yt5,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(yt6c AND V>volAvg,"                                                                 - Ho tro tai "+WriteVal(yt6,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt6c AND V<volAvg,"                                                                 - Ho tro tai "+WriteVal(yt6,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(yt7c AND V>volAvg,"                                                                 - Ho tro tai "+WriteVal(yt7,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt7c AND V<volAvg,"                                                                 - Ho tro tai "+WriteVal(yt7,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(yt8c AND V>volAvg,"                                                                 - Ho tro tai "+WriteVal(yt8,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt8c AND V<volAvg,"                                                                 - Ho tro tai "+WriteVal(yt8,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(yt9c AND V>volAvg,"                                                                 - Ho tro tai "+WriteVal(yt9,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt9c AND V<volAvg,"                                                                 - Ho tro tai "+WriteVal(yt9,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(yt10c AND V>volAvg,"                                                                 - Ho tro tai "+WriteVal(yt10,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt10c AND V<volAvg,"                                                                 - Ho tro tai "+WriteVal(yt10,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""));
//Resistance approaching Commentary
kcu=
WriteIf(ax1 AND tls>0, "                                                                 - Gia gan den khang cu tai "+WriteVal(xt1,1.2)+  ". \n","")+
WriteIf(ax2 AND tls>0, "                                                                 - Gia gan den khang cu tai "+WriteVal(xt2,1.2)+  ". \n","")+
WriteIf(ax3 AND tls>0, "                                                                 - Gia gan den khang cu tai "+WriteVal(xt3,1.2)+  ". \n","")+
WriteIf(ax4 AND tls>0, "                                                                 - Gia gan den khang cu tai "+WriteVal(xt4,1.2)+  ". \n","")+
WriteIf(ax5 AND tls>0, "                                                                 - Gia gan den khang cu tai "+WriteVal(xt5,1.2)+  ". \n","")+
WriteIf(ax6 AND tls>0, "                                                                 - Gia gan den khang cu tai "+WriteVal(xt6,1.2)+  ". \n","")+
WriteIf(ax7 AND tls>0, "                                                                 - Gia gan den khang cu tai "+WriteVal(xt7,1.2)+  ". \n","")+
WriteIf(ax8 AND tls>0, "                                                                 - Gia gan den khang cu tai "+WriteVal(xt8,1.2)+  ". \n","")+
WriteIf(ax9 AND tls>0, "                                                                 - Gia gan den khang cu tai "+WriteVal(xt9,1.2)+  ". \n","")+
WriteIf(ax10 AND tls>0,"                                                                 - Gia gan den khang cu tai "+WriteVal(xt10,1.2)+ ". \n","");
htro=
WriteIf(ay1 AND tls<0, "                                                                 - Gia gan den ho tro tai "+WriteVal(yt1,1.2)+  ". \n","")+
WriteIf(ay2 AND tls<0, "                                                                 - Gia gan den ho tro tai "+WriteVal(yt2,1.2)+  ". \n","")+
WriteIf(ay3 AND tls<0, "                                                                 - Gia gan den ho tro tai "+WriteVal(yt3,1.2)+  ". \n","")+
WriteIf(ay4 AND tls<0, "                                                                 - Gia gan den ho tro tai "+WriteVal(yt4,1.2)+  ". \n","")+
WriteIf(ay5 AND tls<0, "                                                                 - Gia gan den ho tro tai "+WriteVal(yt5,1.2)+  ". \n","")+
WriteIf(ay6 AND tls<0, "                                                                 - Gia gan den ho tro tai "+WriteVal(yt6,1.2)+  ". \n","")+
WriteIf(ay7 AND tls<0, "                                                                 - Gia gan den ho tro tai "+WriteVal(yt7,1.2)+  ". \n","")+
WriteIf(ay8 AND tls<0, "                                                                 - Gia gan den ho tro tai "+WriteVal(yt8,1.2)+  ". \n","")+
WriteIf(ay9 AND tls<0, "                                                                 - Gia gan den ho tro tai "+WriteVal(yt9,1.2)+  ". \n","")+
WriteIf(ay10 AND tls<0,"                                                                 - Gia gan den ho tro tai "+WriteVal(yt10,1.2)+  ". \n","");
//_SECTION_END();

_SECTION_BEGIN("Phan tich dong tien");
SetBarsRequired(sbrAll,sbrAll);
BV = IIf( (H==L), 0, V*(C-L)/(H-L) );
SV = IIf( (H==L), 0, V*(H-C)/(H-L) );
tongbv=Sum(BV,nbar);////Trong nbar phien
tongsv=Sum(SV,nbar);////Trong nbar phien
tongvolume=(tongbv+tongsv);////Trong nbar phien
tyle=tongbv/tongsv;////Trong nbar phien
binhquangia=MA(C,nbar);////Trong nbar phien
GTGDTB=(binhquangia*tongvolume);////Trong nbar phien
///////////////
//****Ap luc mua ban//////////
sp = H-C;
bp = C-L;
bpavg = EMA(bp,80);
spavg = EMA(sp,80);
nbp = bp/bpavg;
nsp = sp/spavg;
Varg = EMA(V,80);
nv = V/Varg;
nbfraw = nbp * nv;
nsfraw = nsp * nv;
nbf = EMA(nbp * nv,20);
nsf = EMA(nsp * nv,20);
diffsucmanh = nbf-nsf;

//_SECTION_BEGIN(" Phan ky MACD");
	r1mapk = Param( "Fast avg", 12, 2, 200, 1 );
	r2mapk = Param( "Slow avg", 26, 2, 200, 1 );
	r3mapk = Param( "Signal avg", 9, 2, 200, 1 );
	r4mapk = Param( "Wk slow", 17, 2, 200, 1 );
	r5mapk = Param( "Wk fast", 8, 2, 200, 1 );
	m1mapk=MACD(r1mapk,r2mapk);
	s1mapk=Signal(r1mapk,r2mapk,r3mapk);
	Pmapk = Param("Phan Ky MACD", 14, 2, 14, 1);
	VMACDmapk = MACD(pmapk);
	Lengthmapk = 100; 
	Lapsemapk = 3; 
	fDownmapk = VMACDmapk < Ref(VMACDmapk, -1) & VMACDmapk < Ref(VMACDmapk, 1) & VMACDmapk < 45;
	Divmapk = 0;
for(i = Lengthmapk; i < BarCount; i++)
{
if(fDownmapk[i])
{
k = i-1;
do
{
if(VMACDmapk[k] < VMACDmapk[i] & fDownmapk[i] & fDownmapk[k])
{
if(C[k] > C[i] & i-k > Lapsemapk)
{
Divmapk[i] = -1;
}
k = i-Lengthmapk;
}
else
k = k-1;
} while( k > i-Lengthmapk );
}
}
Fonmapk = IIf(Divmapk == 0, 0, 1);
Buymapk = Fonmapk;

VMACD2mapk = Zig(MACD(Pmapk),4);
fUpmapk = VMACD2mapk > Ref(VMACD2mapk, -1) & VMACD2mapk > Ref(VMACD2mapk, 1) & VMACD2mapk <55 ;
Divmapk = 0;
for(i = Lengthmapk; i < BarCount; i++)
{
if(fupmapk[i])
{
k = i-1;
do
{
if(VMACD2mapk[k] > VMACD2mapk[i] & fupmapk[i] & fupmapk[k])
{
if(C[k] < C[i] & i-k > Lapsemapk)
{
Divmapk[i] = 1;
}
k = i-Lengthmapk;
}
else
k = k-1;
} while( k > i-Lengthmapk );
}

}
Conmapk = IIf(Divmapk == 0, 0, 1);
Sellmapk = Conmapk;
 distmapk = 1.9*ATR(1);
 for( i = 0; i < BarCount; i++ )
{
//if( Buymapk[i] ) PlotText( "Mua MACD ", i, L[ i ]-dist[i], colorCustom8 );
//if( Sellmapk[i] ) PlotText( "Ban MACD ", i, H[ i ]+dist[i], colorCustom8 );
}
//_SECTION_END();

//_SECTION_BEGIN("MACD HISTOGRAM Phan ky ");
	r1mahpk = Param( "Fast avg", 12, 2, 200, 1 );
	r2mahpk = Param( "Slow avg", 26, 2, 200, 1 );
	r3mahpk = Param( "Signal avg", 9, 2, 200, 1 );
	r4mahpk = Param( "Wk slow", 17, 2, 200, 1 );
	r5mahpk = Param( "Wk fast", 8, 2, 200, 1 );
	m1mahpk=MACD(r1mahpk,r2mahpk);
	s1=Signal(r1mahpk,r2mahpk,r3mahpk);
	Pmahpk = Param("Phan Ky MACD HISTOGRAM", 14, 2, 14, 1);
	m2mahpk = Zig(MACD(r1mahpk,r2mahpk),55);
	s2mahpk = Zig(Signal(r1mahpk,r2mahpk,r3mahpk),55);
	VMACDmahpk = m2mahpk-s2mahpk;
	Lengthmahpk = 100; 
	Lapsemahpk = 3; 
	fUpmahpk = VMACDmahpk > Ref(VMACDmahpk, -1) & VMACDmahpk > Ref(VMACDmahpk, 1) & VMACDmahpk >55;
	fDownmahpk = VMACDmahpk < Ref(VMACDmahpk, -1) & VMACDmahpk < Ref(VMACDmahpk, 1) & VMACDmahpk < 45;
	Divmahpk = 0;
for(i = Lengthmahpk; i < BarCount; i++)
{
// Bao ban phan ky MACD
if(fUpmahpk[i])
{
k = i-1;
do
{
if(VMACDmahpk[k] > VMACDmahpk[i] & fUpmahpk[i] & fUpmahpk[k])
{
if(C[k] < C[i] & i-k > Lapsemahpk)
{
Divmahpk[i] = 1;
}
k = i-Lengthmahpk;
}
else
k = k-1;
} while( k > i-Lengthmahpk );
}
Sellmahpk = fUpmahpk;
// Bao mua phan ky MACD

if(fDownmahpk[i])
{
k = i-1;
do
{
if(VMACDmahpk[k] < VMACDmahpk[i] & fDownmahpk[i] & fDownmahpk[k])
{
if(C[k] > C[i] & i-k > Lapsemahpk)
{
Divmahpk[i] = -1;
}
k = i-Lengthmahpk;
}
else
k = k-1;
} while( k > i-Lengthmahpk );
}

}
buyFonmahpk = IIf(Divmahpk == 0, 0, 1);
Buymahpk = buyFonmahpk;
VMACD2mahpk = m2mahpk-s2mahpk;
fUpmahpk = VMACD2mahpk > Ref(VMACD2mahpk, -1) & VMACD2mahpk > Ref(VMACD2mahpk, 1) & VMACD2mahpk <55 ;
Divmahpk = 0;
for(i = Lengthmahpk; i < BarCount; i++)
{
if(fupmahpk[i])
{
k = i-1;
do
{
if(VMACD2mahpk[k] > VMACD2mahpk[i] & fupmahpk[i] & fupmahpk[k])
{
if(C[k] < C[i] & i-k > Lapsemahpk)
{
Divmahpk[i] = 1;
}
k = i-Lengthmahpk;
}
else
k = k-1;
} while( k > i-Lengthmahpk );
}

}
sellConmahpk = IIf(Divmahpk == 0, 0, 1);
Sellmahpk = sellConmahpk;
 distmahpk = 1.9*ATR(1);
 for( i = 0; i < BarCount; i++ )
{
//if( Buymahpk[i] ) PlotText( "Mua HISTOGRAM ", i, L[ i ]-dist[i], colorcustom13,null );
//if( Sellmahpk[i] ) PlotText( "Ban HISTOGRAM ", i, H[ i ]+dist[i], colorcustom13, null );
}

////////////////////////////////////
PeriodFast = Param( "Fast avg", 12, 2, 200, 1 );
PeriodSlow = Param( "Slow avg", 26, 2, 200, 1 );
PeriodSignal = Param( "Signal avg", 9, 2, 200, 1 );
PeriodEMA = 13;
MACDIndicatorRange = 50;
VolumeFilter = Param( "Volume MA filter", 100000, 50000, 500000, 100000 );
Timeframe = Interval(2);

// Adjust for weekly if necessary
if( Timeframe == "5-day" || Timeframe == "Weekly" ) {
  VolumeFilter  = VolumeFilter * 5;
}
else if( Timeframe == "Monthly") {
  VolumeFilter = VolumeFilter * 20;
}
else if( Timeframe != "Daily" ) {
  VolumeFilter = 0;
}
// Minimum number of bars required to form a divergence pattern. For a
// positive divergence, this is the number of falling bars in the context
// of a rising MACD or MACD-H pattern. Vice versa for negative divergence
MACDDivMinWidth = Param("Divergence min width", 4, 1, 10, 1 ); 
// Minimum width of negative projecting wave between two positive MACD-H waves, 
// otherwise two positive waves will be considered as one single wave. This
// minimises invalid divergences, to ensure that "back of bears is broken".
// The same applies for a positive wave between two negative waves.
HistMinWidth = Param("Histogram min width", 4, 1, 10, 1 ); 
PeriodEMA = Optimize( "PeriodEMA ", 13, 5, 23, 1 );

// Other parameters
OpenPositions = 10;
ATRPeriod = 5;
InitialCapital = 100000;
MACDInd = MACD(PeriodFast, PeriodSlow );
SigInd = Signal(PeriodFast, PeriodSlow , PeriodSignal );
HistInd = MACDInd - SigInd ;
_N( macdStr = WriteVal( PeriodFast, 1.0 )+","+WriteVal( PeriodSlow , 1.0 ) );
_N( sigStr = macdStr + ","+WriteVal( PeriodSignal , 1.0 ) );

// Get displayed min and max value of MACD and MACD-H, to rescale it for better visibility
scMACDMax = LastValue(HHV(Max(MACDInd, sigInd), 
                  BarsSince( Status("barvisible") AND NOT Ref(Status("barvisible"),-1) ))); 
scMACDMin = LastValue(LLV(Min(MACDInd, sigInd), 
                  BarsSince( Status("barvisible") AND NOT Ref(Status("barvisible"),-1) ))); 
scaleMACD = Max( abs(scMACDMax), abs(scMACDMin) ); 

scHistMax = LastValue(HHV(HistInd, 
            BarsSince( Status("barvisible") AND NOT Ref(Status("barvisible"),-1) ))); 
scHistMin = LastValue(LLV(HistInd, 
            BarsSince( Status("barvisible") AND NOT Ref(Status("barvisible"),-1) ))); 
scaleHist = Max( abs(scHistMax), abs(scHistMin) ); 

GraphXSpace = 0;

VolumeMA = MA( V, 50 );
if( IsIndex() ) {
  VolumeMABool = True;
}
else {
  VolumeMABool = IsTrue( VolumeMA > VolumeFilter );
}


DayHist = MACD( PeriodFast, PeriodSlow ) - 
          Signal( PeriodFast, PeriodSlow, PeriodSignal );
DayEMA = EMA( Close, PeriodEMA );
DaySTO = StochK( 14 );
DayRSI = RSI( 14 );
DayBuyBool = IsTrue( 
                ( // DayEMA > Ref(DayEMA,-1)  // EMA rising
                  DaySTO < 70                 // STO not overbought
                  // AND DayRSI > Ref(DayRSI,-1) // RSI rising
                  AND MACD( PeriodFast, PeriodSlow ) < 0 )
                OR Timeframe == "5-day" OR Timeframe == "Weekly"
              );
DaySellBool = IsTrue( 
                ( // DayEMA < Ref(DayEMA,-1)  // EMA falling
                  DaySTO > 30                 // STO not oversold
                  // AND DayRSI < Ref(DayRSI,-1) // RSI falling
                  AND MACD( PeriodFast, PeriodSlow ) > 0 )
                OR Timeframe == "5-day" OR Timeframe == "Weekly"
              );
MACDLowBars = LLVBars( MACDInd, MACDDivMinWidth );

// Get array defining if the MACD's previous bar was the 
// minimum, AND if that MACD value < 0
MACDMinCond = MACDLowBars > 0 AND 
        Ref(MACDLowBars,-1) == 0 AND 
        Ref(MACDInd,-1) < 0;

// Get array containing MACD low bar values where lows
// occured, all other bars filled with 0
MACDLowVal = IIf( MACDMinCond , Ref(MACDInd,-1), 0 );

// Get array containing MACD low bar value at bar where MACD 
// low occured, all other bars filled with preceding MACD 
// low value (chandelier)
MACDLowSteps = ValueWhen( Ref(MACDMinCond,0), 
                          Ref(MACDInd,-1), 1 );

// Get array containing price low bar values where lows
// occured, all other bars filled with huge number
PriceMACDLowVal = IIf( MACDMinCond, 
                       Ref(LLV(L,MACDDivMinWidth ),-1), 
                       2000000 );

// Get array containing local price low bar value at bar 
// where MACD low occured, all other bars filled with preceding 
// price low value (chandelier)
PriceMACDLowSteps = ValueWhen( Ref(MACDMinCond ,0), 
                               LLV(L,MACDDivMinWidth ) );

// Get array containing differences in MACD low bar values
MACDLowDiffs = MACDLowSteps - Ref(MACDLowSteps,-1); 

// Get array containing differences in price low bar values
PriceMACDLowDiffs = PriceMACDLowSteps - Ref(PriceMACDLowSteps,-1);

// Get array defining positive divergences
MACDLowBarDiffs = Ref( BarsSince(MACDMinCond ), -1 );

// Divergence signal
MACDPosDivergence = // MACDLowDiffs > 0 AND 
         MACDLowVal < 0 
         AND MACDLowVal > LLV(MACDLowVal, MACDIndicatorRange ) 
         AND PriceMACDLowVal < LLV(Ref(PriceMACDLowVal,-1), MACDIndicatorRange ) 
         AND PriceMACDLowDiffs < 0 
         AND MACDLowBarDiffs < MACDIndicatorRange  
         AND VolumeMABool 
         AND C > 1.0
         // AND WeekBuyBool
         ;


//--------------------------
// Negative MACD divergences
//--------------------------

// Get array containing for each element, when the MACD's highest
// value occur, within the specified number of bars
MACDHighBars = HHVBars( MACDInd, MACDDivMinWidth );

// Get array defining if the MACD's previous bar was the 
// maximum, AND if that MACD value > 0
MACDMaxCond = MACDHighBars > 0 AND 
         Ref(MACDHighBars,-1) == 0 AND 
         Ref(MACDInd,-1) > 0;

// Get array containing MACD high bar values where highs
// occured, all other bars filled with 0
MACDHighVal = IIf( MACDMaxCond, 
                   Ref(MACDInd,-1), 0);

// Get array containing MACD high bar value at bar where MACD 
// high occured, all other bars filled with preceding MACD 
// high value (chandelier)
MACDHighSteps = ValueWhen( Ref(MACDMaxCond,0), 
                           Ref(MACDInd,-1), 1 );

// Get array containing MACD high bar values where highs
// occured, all other bars filled with 0
PriceMACDHighVal = IIf( MACDMaxCond, 
                        Ref(HHV(H,MACDDivMinWidth),-1), 
                        0);

// Get array containing local price high bar value at bar 
// where MACD high occured, all other bars filled with preceeding 
// price high value (chandelier)
PriceMACDHighSteps = ValueWhen( Ref(MACDMaxCond,0), 
                                HHV(H,MACDDivMinWidth) );

// Get array containing differences in MACD high bar values
MACDHighDiffs = MACDHighSteps - Ref(MACDHighSteps,-1);

// Get array containing differences in price high bar values
PriceMACDHighDiffs = PriceMACDHighSteps - Ref(PriceMACDHighSteps,-1);

// Get array defining negative divergences
MACDHighBarDiffs = Ref( BarsSince(MACDMaxCond), -1 );

// Divergence signal
MACDNegDivergence = // MACDHighDiffs < 0 AND 
         MACDHighVal > 0 
         AND PriceMACDHighVal > HHV( Ref(PriceMACDHighVal,-1), MACDIndicatorRange ) 
         AND MACDHighVal < HHV( MACDHighVal, MACDIndicatorRange ) 
         AND PriceMACDHighDiffs > 0 
         AND MACDHighBarDiffs < MACDIndicatorRange 
         AND VolumeMABool 
         AND C > 1.0
         // AND WeekBuyBool
         ;


//------------------------------------
// Positive MACD Histogram divergences
//------------------------------------

// Get array containing when positive and negative and positive 
// crossovers occured
HistPosCrossover = Cross( HistInd, 0 ) ;
HistNegCrossover = Cross( 0, HistInd ) ;
BarsSinceNegCross = BarsSince( HistNegCrossover );
BarsSincePosCross = BarsSince( HistPosCrossover );

// Get arrays containing for each element, when the MACD-H lowest
// values occur, within the specified number of bars
HistLowBars = LLVBars( HistInd, MACDDivMinWidth );

// Get array defining if the MACD-H previous bar was the minimum
// AND if that MACD-H value was < 0 or > 0
HistMinCond = HistLowBars > 0 AND 
        BarsSinceNegCross >= HistLowBars AND
        Ref(HistLowBars,-1) == 0 AND 
        Ref(HistInd,-1) < 0;

// Get array containing MACD-H  low bar values where lows
// occured, all other bars filled with 0
HistLowVal = IIf( HistMinCond , Ref(HistInd,-1), 0 );

// Get array containing MACD-H  low bar value at bar where MACD-H  
// low occured, all other bars filled with preceding MACD-H  
// low value (chandelier)
HistLowSteps =  ValueWhen( Ref(HistMinCond,0), Ref(HistInd,-1), 1 );

// Get array containing differences between MACD-H low bar value and the value
// at previous MACD-H zero positive crossing
// HistLowDiffs = HistLowSteps - ValueWhen( HistPosCrossover, HistLowSteps, 1 );
HistLowDiffs = HistLowSteps - Ref(HistLowSteps,-1); 

// Get array containing MACD-H min value when MACD-H < 0, all other
// bars filled with 0
BarsSincePrevNegCross = ValueWhen( HistNegCrossover, 
                                   Ref(BarsSinceNegCross ,-1), 1 );
BarsSinceWideNegCross = IIf( HistInd < 0 AND 
                             BarsSincePosCross - BarsSinceNegCross < 
                                 HistMinWidth,                             
                             BarsSincePrevNegCross + BarsSinceNegCross + 1,
                             BarsSinceNegCross  );
HistMinSteps = IIf( !BarsSinceWideNegCross,
                    HistInd, 
                    LLV( HistInd , BarsSinceWideNegCross + 1) );                   

// Get array containing differences in MACD-H max bar values
HistMinDiffs = IIf( HistInd < 0, 
                    HistMinSteps - Ref(HistMinSteps,-1),
                    0);

// Get minumum from previous MACD-H negative wave
// Plot( ValueWhen( HistNegCrossover, Ref(HistMinSteps,-1), 1 ),"PrevHistMinSteps-1", colorGreen );
// Plot( ValueWhen( HistNegCrossover, Ref(HistMinSteps,-1), 2 ),"PrevHistMinSteps-1", colorGreen );
PrevHistMinSteps = IIf( HistInd < 0 AND 
                        BarsSincePosCross - BarsSinceNegCross < 
                            HistMinWidth,
                        ValueWhen( HistNegCrossover, 
                                   Ref(HistMinSteps,-1), 2 ),
                        ValueWhen( HistNegCrossover, 
                                   Ref(HistMinSteps,-1), 1 ) );

// Get array containing price low bar values where lows
// occured, all other bars filled with huge number
PriceHistLowVal = IIf( HistMinCond, 
                       Ref(LLV(L,MACDDivMinWidth),-1), 
                       2000000 );

// Get array containing local price low bar value at bar 
// where MACD-H low occured, all other bars filled with preceding 
// price low value (chandelier)
PriceHistLowSteps = ValueWhen( Ref(HistMinCond ,0), 
                               LLV(L,MACDDivMinWidth) );

// Get array containing differences in price low bar values
PriceHistLowDiffs = PriceHistLowSteps - Ref(PriceHistLowSteps,-1);

// Get array containing price low minimum value when MACD-H < 0, 
// all other bars filled with 0
PriceHistMinSteps = IIf( !BarsSinceNegCross, 
                          L, 
                          LLV( L , BarsSinceNegCross) );

// Get minimum from previous MACD-H negative wave
PrevPriceHistMinSteps = IIf( BarsSincePosCross - BarsSinceNegCross < 
                                HistMinWidth,
                             ValueWhen( HistNegCrossover, 
                                        Ref(PriceHistMinSteps,-1), 2 ),
                             ValueWhen( HistNegCrossover, 
                                        Ref(PriceHistMinSteps,-1), 1 ) );

// Divergence signal
HistPosDivergence = // HistLowDiffs > 0 AND 
         // AND PriceHistLowDiffs < 0 
         HistMinSteps > PrevHistMinSteps 
         AND PriceHistMinSteps < PrevPriceHistMinSteps 
         AND HistLowVal < 0 
         AND VolumeMABool 
         AND C > 1.0
         ;


//------------------------------------
// Negative MACD Histogram divergences
//------------------------------------

// Get arrays containing for each element, when the MACD-H highest values 
// occur, within the specified number of bars
HistHighBars = HHVBars( HistInd, MACDDivMinWidth );

// Get array defining if the MACD-H previous bar was the maximum, 
// AND if that MACD-H value was < 0 OR > 0
HistMaxCond = HistHighBars > 0 
         AND BarsSincePosCross >=  HistHighBars 
         AND Ref(HistHighBars,-1) == 0 
         AND Ref(HistInd,-1) > 0
         ;

// Get array containing MACD-H high bar values where highs
// occured, all other bars filled with 0
HistHighVal = IIf( HistMaxCond, Ref(HistInd,-1), 0);

// Get array containing MACD-H high bar value at bar where MACD-H 
// high occured, all other bars filled with preceding MACD-H 
// high value (chandelier)
HistHighSteps = ValueWhen( Ref(HistMaxCond,0), 
                           Ref(HistInd,-1), 1 );

// Get array containing differences in MACD-H high bar values
HistHighDiffs = HistHighSteps - Ref(HistHighSteps,-1);

// Get array containing MACD-H max value when MACD-H > 0, all other
// bars filled with 0
BarsSincePrevPosCross = ValueWhen( HistPosCrossover, 
                                   Ref(BarsSincePosCross ,-1), 1 );
BarsSincePrevNegCross = ValueWhen( HistNegCrossover, 
                                   Ref(BarsSinceNegCross ,-1), 1 );
BarsSinceWidePosCross = IIf( HistInd > 0 AND 
                             BarsSinceNegCross - BarsSincePosCross < 
                                HistMinWidth,                             
                             BarsSincePrevPosCross + BarsSincePosCross + 1,
                             BarsSincePosCross  );
HistMaxSteps = IIf( !BarsSinceWidePosCross,
                    HistInd, 
                    HHV( HistInd , BarsSinceWidePosCross + 1) );

// Get array containing differences in MACD-H max bar values
HistMaxDiffs = IIf( HistInd > 0, 
                    HistMaxSteps - Ref(HistMaxSteps,-1),
                    0);

// Get high from pevious MACD-H positive wave
PrevHistMaxSteps = IIf( HistInd > 0 AND 
                        BarsSinceNegCross - BarsSincePosCross < 
                            HistMinWidth,
                        ValueWhen( HistPosCrossover, 
                                   Ref(HistMaxSteps,-1), 2 ),
                        ValueWhen( HistPosCrossover, 
                                   Ref(HistMaxSteps,-1), 1 ) );

// Get array containing MACD-H high bar values where highs
// occured, all other bars filled with 0
PriceHistHighVal = IIf( HistMaxCond, 
                        Ref(HHV(H,MACDDivMinWidth),-1), 
                        0);

// Get array containing local price high bar value at bar 
// where MACD-H high occured, all other bars filled with preceeding 
// price high value (chandelier)
PriceHistHighSteps = ValueWhen( Ref(HistMaxCond,0), 
                                HHV(H,MACDDivMinWidth) );

// Get array containing differences in price high bar values
PriceHistHighDiffs = PriceHistHighSteps - Ref(PriceHistHighSteps,-1);

// Get array containing MACD-H max value when MACD-H > 0, all other
// bars filled with 0
PriceHistMaxSteps = IIf( !BarsSincePosCross, 
                         H, 
                         HHV( H , BarsSincePosCross) );

// Get high from pevious MACD-H positive wave
PrevPriceHistMaxSteps = IIf( BarsSinceNegCross - BarsSincePosCross < 
                                 HistMinWidth,
                             ValueWhen( HistPosCrossover, 
                                        Ref(PriceHistMaxSteps,-1), 2 ),
                             ValueWhen( HistPosCrossover, 
                                        Ref(PriceHistMaxSteps,-1), 1 ) );

// Divergence signal
HistNegDivergence = // HistHighDiffs < 0 AND 
         // AND PriceHistHighDiffs > 0 
         HistMaxSteps < PrevHistMaxSteps 
         AND PriceHistMaxSteps > PrevPriceHistMaxSteps 
         AND HistHighVal > 0 
         AND VolumeMABool 
         AND C > 1.0
         ;

//_SECTION_END();

//****************RSI BUY SELL( Addition)**************************
{
nrsi1=42;
perrsi1 =13;
xrsi1 = Cum(1);
s1rsi1=IIf(RSIa(L,nrsi1)>Min(RSIa(C,nrsi1),RSIa(O,nrsi1)),Min(RSIa(C,nrsi1),RSIa(O,nrsi1)),RSIa(L,nrsi1));
s11rsi1=IIf(RSIa(H,nrsi1)<Max(RSIa(C,nrsi1),RSIa(O,nrsi1)),Max(RSIa(C,nrsi1),RSIa(O,nrsi1)),RSIa(H,nrsi1));
pSrsi1 = TroughBars( s1rsi1, perrsi1, 1 ) == 0;
endtrsi1= LastValue(ValueWhen( pSrsi1, xrsi1, 1 ));
starttrsi1=LastValue(ValueWhen( pSrsi1, xrsi1, 2 ));
dtSrsi1 =endtrsi1-starttrsi1;
endSrsi1 = LastValue(ValueWhen( pSrsi1, s1rsi1, 1 ) );
startSrsi1 = LastValue( ValueWhen( pSrsi1, s1rsi1, 2  ));
aSrsi1 = (endSrsi1-startSrsi1)/dtSrsi1;bSrsi1 = endSrsi1;
trendlineSrsi1 = aSrsi1 * ( xrsi1  -endtrsi1 ) + bSrsi1; 
pRrsi1 = PeakBars( s11rsi1, perrsi1, 1 ) == 0;
endt1rsi1= LastValue(ValueWhen( pRrsi1, xrsi1, 1 ));
startt1rsi1=LastValue(ValueWhen( pRrsi1, xrsi1, 2 ));
dtRrsi1 =endt1rsi1-startt1rsi1;
endRrsi1 = LastValue(ValueWhen( pRrsi1, s11rsi1, 1 ) );
startRrsi1 = LastValue( ValueWhen( pRrsi1, s11rsi1, 2  ));
aRrsi1 = (endRrsi1-startRrsi1)/dtRrsi1;
bRrsi1 = endRrsi1;
trendlineRrsi1 = aRrsi1 * ( xrsi1  -endt1rsi1 ) + bRrsi1; 

Buyrsi1 =  (S1rsi1==trendlineSrsi1 );//RSI  Buy
Sellrsi1 =  (S11rsi1==trendlineRrsi1 ); //RSI  Sell

nrsi2=260;
perrsi2 =12;
xrsi2 = Cum(1);
s1rsi2=IIf(RSIa(L,nrsi2)>Min(RSIa(C,nrsi2),RSIa(O,nrsi2)),Min(RSIa(C,nrsi2),RSIa(O,nrsi2)),RSIa(L,nrsi2));
s11rsi2=IIf(RSIa(H,nrsi2)<Max(RSIa(C,nrsi2),RSIa(O,nrsi2)),Max(RSIa(C,nrsi2),RSIa(O,nrsi2)),RSIa(H,nrsi2));
pSrsi2 = TroughBars( s1rsi2, perrsi2, 1 ) == 0;
endtrsi2= LastValue(ValueWhen( pSrsi2, xrsi2, 1 ));
starttrsi2=LastValue(ValueWhen( pSrsi2, xrsi2, 2 ));
dtSrsi2 =endtrsi2-starttrsi2;
endSrsi2 = LastValue(ValueWhen( pSrsi2, s1rsi2, 1 ) );
startSrsi2 = LastValue( ValueWhen( pSrsi2, s1rsi2, 2  ));
aSrsi2 = (endSrsi2-startSrsi2)/dtSrsi2;
bSrsi2 = endSrsi2;
trendlineSrsi2 = aSrsi2 * ( xrsi2  -endtrsi2 ) + bSrsi2; 
pRrsi2 = PeakBars( s11rsi2, perrsi2, 1 ) == 0;
endt1rsi2= LastValue(ValueWhen( pRrsi2, xrsi2, 1 ));
startt1rsi2=LastValue(ValueWhen( pRrsi2, xrsi2, 2 ));
dtRrsi2 =endt1rsi2-startt1rsi2;
endRrsi2 = LastValue(ValueWhen( pRrsi2, s11rsi2, 1 ) );
startRrsi2 = LastValue( ValueWhen( pRrsi2, s11rsi2, 2  ));
aRrsi2 = (endRrsi2-startRrsi2)/dtRrsi2;
bRrsi2 = endRrsi2;
trendlineRrsi2 = aRrsi2 * ( xrsi2  -endt1rsi2 ) + bRrsi2; 
Buyr2 =  S1rsi2==trendlineSrsi2 ; //RSI260 strong Buy
Sellr2 =  (S11rsi2==trendlineRrsi2 ); //RSI260 strong Sell


nrsi=150;
perrsi =12;
xrsi = Cum(1);
s1rsi=IIf(RSIa(L,nrsi)>Min(RSIa(C,nrsi),RSIa(O,nrsi)),Min(RSIa(C,nrsi),RSIa(O,nrsi)),RSIa(L,nrsi));
s11rsi=IIf(RSIa(H,nrsi)<Max(RSIa(C,nrsi),RSIa(O,nrsi)),Max(RSIa(C,nrsi),RSIa(O,nrsi)),RSIa(H,nrsi));
pSrsi = TroughBars( s1rsi, perrsi, 1 ) == 0;
endtrsi= LastValue(ValueWhen( pSrsi, xrsi, 1 ));
starttrsi=LastValue(ValueWhen( pSrsi, xrsi, 2 ));
dtSrsi =endtrsi-starttrsi;
endSrsi = LastValue(ValueWhen( pSrsi, s1rsi, 1 ) );
startSrsi = LastValue( ValueWhen( pSrsi, s1rsi, 2  ));
aSrsi = (endSrsi-startSrsi)/dtSrsi;bSrsi = endSrsi;
trendlineSrsi = aSrsi * ( xrsi  -endtrsi ) + bSrsi; 
pRrsi = PeakBars( s11rsi, perrsi, 1 ) == 0;
endt1rsi= LastValue(ValueWhen( pRrsi, xrsi, 1 ));
startt1rsi=LastValue(ValueWhen( pRrsi, xrsi, 2 ));
dtRrsi =endt1rsi-startt1rsi;
endRrsi = LastValue(ValueWhen( pRrsi, s11rsi, 1 ) );
startRrsi = LastValue( ValueWhen( pRrsi, s11rsi, 2  ));
aRrsi = (endRrsi-startRrsi)/dtRrsi;
bRrsi = endRrsi;
trendlineRrsi = aRrsi * ( xrsi  -endt1rsi ) + bRrsi; 
Buyrsi150 =  (S1rsi==trendlineSrsi );//Rsi150 strong Buy
Sellrsi150 =  (S11rsi==trendlineRrsi ); //Rsi150 strong Sell
////////////
n=130;
per =11.5;
x = Cum(1);
s1=IIf(RSIa(L,n)>Min(RSIa(C,n),RSIa(O,n)),Min(RSIa (C,n),RSIa(O,n)),RSIa(L,n));
s11=IIf(RSIa(H,n)<Max(RSIa(C,n),RSIa(O,n)),Max(RSIa(C,n),RSIa(O,n)),RSIa(H,n));
pS = TroughBars( s1, per, 1 ) == 0;
endt= LastValue(ValueWhen( pS, x, 1 ));
startt=LastValue(ValueWhen( pS, x, 2 ));
dtS =endt-startt;
endS = LastValue(ValueWhen( pS, s1, 1 ) );
startS = LastValue( ValueWhen( pS, s1, 2 ));
aS = (endS-startS)/dtS;bS = endS;
trendlineS = aS * ( x -endt ) + bS; 
pR = PeakBars( s11, per, 1 ) == 0;
endt1= LastValue(ValueWhen( pR, x, 1 ));
startt1=LastValue(ValueWhen( pR, x, 2 ));
dtR =endt1-startt1;
endR = LastValue(ValueWhen( pR, s11, 1 ) );
startR = LastValue( ValueWhen( pR, s11, 2 ));
aR = (endR-startR)/dtR;
bR = endR;
trendlineR = aR * ( x -endt1 ) + bR; 

Buyrsi130 = (S1==trendlineS );
Sellrsi130 = (S11==trendlineR ); 

}
//******************RSI BUY SELL( Addition)-----End************************


//_SECTION_BEGIN(" Phan Ky RSI-1");
GraphXSpace=15;
 npk1=Param("% Reverse ",20,0,100,1);
 Buypk1=Sellpk1=0;
Varpk1 = Zig(RSI(), npk1); 
 tpk1= Trough(RSI(), npk1, 1); 
 ppk1= Peak(RSI(), npk1, 1); 
 xpk1[0] =Varpk1[0];
 pricepk1[0] = C[0];
 j1=0;
// Bao phan ky vung dinh
 for ( i=0; i<BarCount; i++) 
 {
 if(Varpk1[i] == ppk1[i])
 {
 
j1++;
 xpk1[j1] =Varpk1[i];
 pricepk1[j1] =C[i];
 if(xpk1[j1] <xpk1[j1-1] && pricepk1[j1-1]< pricepk1[j1]) 
 Sellpk1[i] =1;
 }
 }
// Bao phan ky vung day
 for ( i=0; i<BarCount; i++) 
 {
 if(Varpk1[i] == tpk1[i])
 {
 j1++;
 xpk1[j1] =Varpk1[i];
 pricepk1[j1] =C[i];
 if(xpk1[j1] >xpk1[j1-1] && pricepk1[j1]<pricepk1[j1-1]) 
 Buypk1[i] =1;
 }
 }
 distpk1 = 1.9*ATR(1);
 for( i = 0; i < BarCount; i++ )
{
//if( Buypk1[i] ) PlotText( "Mua RSI ", i, L[ i ]-dist[i], colorWhite );
//if( Sellpk1[i] ) PlotText( "Ban RSI ", i, H[ i ]+dist[i], colorWhite );
}
 
//PlotShapes(IIf(Buypk1, shapeUpArrow, shapeNone),colorWhite, 0,L, Offset=-15);                     
//PlotShapes(IIf(Sellpk1, shapeDownArrow, shapeNone),colorWhite, 0,H, Offset=-15);
//_SECTION_END();

//_SECTION_BEGIN("RSI Phan ky 2");
npk2=Optimize("ZIG",9,5,50,1);
perpk2=Optimize("rsi",28,5,50,1);
Buypk2=Sellpk2=0;
Varpk2 = Zig(RSI(perpk2), npk2); 
tpk2= Trough(RSI(perpk2), npk2, 1); 
ppk2= Peak(RSI(perpk2), npk2, 1); 
xpk2[0] =Varpk2[0];
pricepk2[0] = C[0];
j2=0;
// Bao phan ky vung day
for ( i=0; i<BarCount; i++) 
{
if(Varpk2[i] == ppk2[i])
{

j2++;
xpk2[j2] =Varpk2[i];
pricepk2[j2] =C[i];
if(xpk2[j2] <xpk2[j2-1] && pricepk2[j2-1]< pricepk2[j2]) 
Sell[i] =1;
}
}
// Bao phan ky vung day
for ( i=0; i<BarCount; i++) 
{
if(Varpk2[i] == tpk2[i])
{
j2++;
xpk2[j2] =Varpk2[i];
pricepk2[j2] =C[i];
if(xpk2[j2] >xpk2[j2-1] && pricepk2[j2]<pricepk2[j2-1]) 
Buypk2[i] =1;
}
}

 distpk2 = 1.7*ATR(1);
 for( i = 0; i < BarCount; i++ )
{
//if( Buy[i] ) PlotText( "Mua RSI ", i, L[ i ]-dist[i], colorWhite);
//if( Sell[i] ) PlotText( "Ban RSI ", i, H[ i ]+dist[i], colorWhite );
}                 
//PlotShapes(IIf(Buy, shapeUpArrow, shapeNone),colorWhite, 0,L, Offset=-15);                     
//PlotShapes(IIf(Sell, shapeDownArrow, shapeNone),colorWhite, 0,H, Offset=-15);
//_SECTION_END();


//_SECTION_BEGIN( "Ichi" );
////9-26-26-26
TL   =(HHV(H,9)+LLV(L,9))/2;            // Tenkan-sen
SL    =(HHV(H,26)+LLV(L,26))/2;            // Kijun-sen  
SpanA =Ref((SL+TL)/2,-26);    // Senkou Span A / Up Kumo 
SpanB =Ref((HHV(H,2*26)+LLV(L,2*26))/2,-26);   // Senkou Span B  / Down Kumo 
DL = IIf( Cum( 1 ) <= LastValue( Cum( 1 ) ) - 26, Ref( C,  26 + 1 ), Null );
//Plot( DL, "DL", colorGrey50, styleLine );
KJ65 = ( HHV( H, 65 ) + LLV( L, 65) )/2;
KJ129 = ( HHV( H, 129 ) + LLV( L, 129) )/2;
///////////////////////////////
above = IIf(SL>SpanA AND TL>SpanB,1,0);
within = IIf(SL>SpanA AND TL<SpanB,1,0);
below = IIf(TL<SpanA AND TL<SpanB,1,0);
Buy0 = Cross(TL,SL) AND (DL>Close);
Sell0 = Cross(SL,TL) AND (DL<SL);
StrongBuy = Buy0 AND above;
MediumBuy = Buy0 AND within;
WeakBuy = Buy0 AND below;
StrongSell = Sell0 AND below;
MediumSell = Sell0 AND within;
WeakSell = Sell0 AND above;
////9-17-26-26/////
TL1   =(HHV(H,9)+LLV(L,9))/2;            // Tenkan-sen
SL1    =(HHV(H,17)+LLV(L,17))/2;            // Kijun-sen  
SpanA1 =Ref((SL1+TL1)/2,-26);    // Senkou Span A / Up Kumo
SpanB1 =Ref((HHV(H,2*17)+LLV(L,2*17))/2,-26);   // Senkou Span B  / Down Kumo 
DL1 = IIf( Cum( 1 ) <= LastValue( Cum( 1 ) ) - 26, Ref( C,  26 + 1 ), Null );
///////////////////////////////
above1 = IIf(SL>SpanA1 AND TL>SpanB1,1,0);
within1 = IIf(SL>SpanA1 AND TL<SpanB1,1,0);
below1 = IIf(TL<SpanA1 AND TL<SpanB1,1,0);
Buy1 = Cross(TL1,SL1) AND (DL1>Close);
Sell1 = Cross(SL1,TL1) AND (DL1<SL1);
StrongBuy1 = Buy1 AND above1;
MediumBuy1 = Buy1 AND within1;
WeakBuy1 = Buy1 AND below1;
StrongSell1 = Sell1 AND below1;
MediumSell1 = Sell1 AND within1;
WeakSell1 = Sell1 AND above1;



///_SECTION_BEGIN("Dynamic RSI");

Periody = Param("Periody", 14, 2, 30, 1);
Lby = Param("LookBack Periody",60,40,120,1);
RSILine = RSI(Periody);
jh = HHV(RSILine,Lby);
jl = LLV(RSILine,Lby);
jc = (WMA((jh-jl),Periody)*0.50)+WMA(jl,Periody); 
R = ( 4 * RSILine + 3 * Ref(RSILine,-1) + 2 * Ref(RSILine,-2) + Ref(RSILine,-3) ) / 10;
DynamicRSIbuy=Cross(R,jc);
DynamicRSIsell=Cross(jc,R);

//////momentum/////
mom= MA(Close - Ref(Close,-7),1); 
mom1= MA(mom,5);
dkbuymom=Cross(mom,mom1);
dkSellmom=Cross(mom1,mom);
//////////////////////


A1xx=SAR(0.02,0.2);
Cond3xx=Cross(C,A1xx);
Cond4xx=Cross(A1xx,C);
TimeFrameSet(inWeekly);
Axx=SAR(0.02,0.2);
TimeFrameRestore();
Kxx = TimeFrameExpand(Axx, inWeekly);
Cond1xx=Cross(C,Kxx);
Cond2xx=Cross(Kxx,C);
Buysarxx=Cond1xx AND Cond3xx;
Sellsarxx=Cond2xx AND Cond4xx;

//_SECTION_END();
// START CANDLESTICK FORMATION //CLICK DAU CONG DE MO RONG CODE
{
WhiteBody = C > O;
BigWhite = (Close - Open)/Open > 0.015 AND (Close - Open) * 2 > High - Low;
BlackBody = C < O;
BigBlack = (Open - Close)/Open > 0.015 AND (Open - Close) * 2 > High - Low;
Big = abs((Close - Open)/Open) > 0.014;
LongUpperShadow = H - Max(O,C) > (H - L)*0.67;
LongLowerShadow = Min(O,C) - L > (H - L)*0.67;
rng = abs((C-O)/O);
lowerShadow = Min(O,C) - L;
uppershadow = H - Max(O,C);
body = abs(O-C);
rngx = abs(H - L);
rngy = H-L;
shaven = lowerShadow < rngy*0.1;
ShavenBottom = L == Min(O,C);
ShavenHead = H == Max(O,C);
prevSize = abs(Ref(O,-1)-Ref(C,-1));
currentSize = abs(O-C);
fwh = Ref(H,-4);
fwl = Ref(L,-4);
isPrevLargeWhite = Ref(big,-1) AND Ref(whitebody,-1);
SmallRealBody = rng < 0.01 AND rng >0;
Diff = abs((prevSize - currentSize) / currentSize);
DownTrend = (H < Ref(H,-1) AND L < Ref(L,-1));
UpTrend = (H > Ref(H,-1) AND L > Ref(L,-1));
isPrevUpTrend = Ref(uptrend,-1);
RealBodyGapUp = Min(O,C) > Max(Ref(O,-1),Ref(C,-1));
RealBodyGapDown = Max(O,C) < Min(Ref(O,-1),Ref(C,-1));
FallingWindow = Ref(downtrend,-1) AND GapDown();
RisingWindow = Ref(uptrend,-1) AND GapUp();
isfalling = bigblack AND fallingwindow;
isrising = bigwhite AND risingwindow;
rwh = Ref(H,-4);
rwl = Ref(L,-4);
isFallingBlack = Ref(fallingwindow,-1) AND Ref(blackbody,-1);
horw = Ref(H,-2);
windowOpen = C < horw;
opensInside = O < Ref(O,-1) AND O > Ref(C,-1);
similarSize = diff <= 0.25;
GapUpFromWhite = realBodyGapUp AND isPrevLargeWhite AND isPrevUptrend;
isPrevLargeBlack = Ref(big,-1) AND Ref(blackbody,-1);
isPrevDownTrend = Ref(downtrend,-1);
GapDownFromBlack = realBodyGapDown AND isPrevLargeBlack AND isPrevDowntrend;
isRisingWhite = Ref(risingwindow,-1) AND Ref(whitebody,-1);
lorw = Ref(L,-2);
windowOpenx = C > lorw;
Doji = C == O AND V > 0;
LongLeggedDoji = doji AND (H - L)/L > 0.01;
StarUp = smallRealBody AND gapUpFromWhite;
DojiStarUp = doji AND gapUpFromWhite;
DojiStarDown = doji AND gapDownFromBlack;
StarDown = smallRealBody AND gapDownFromBlack;
isPrevDownTrendx = Ref(downtrend,-3);
firstDoji = Ref(doji,-2);
secDojiLower = Ref(doji,-1) AND Ref(realBodyGapDown,-1);
isPrevUpTrendx = Ref(uptrend,-3);
secDojiHigher = Ref(doji,-1) AND Ref(realBodyGapUp,-1);
BeltHold = shavenbottom AND shavenhead AND big;
Engulfing = Max(O,C) > Ref(Max(O,C),-1) AND Min(O,C) < Ref(Min(O,C),-1);
UmbrellaLine = uppershadow < rngx*0.1 AND lowershadow > body*2;
KBR = Ref(O,-1) < Ref(C,-1) AND O <= Ref(O,-1) AND C <= O;
EveningDojiStar = Ref(dojiStarUp,-1) AND blackbody AND big AND C < Ref((O + C)/2,-2);
EveningStar = Ref(starUp,-1) AND blackbody AND big AND C < Ref((O + C)/2,-2);
GraveStoneDoji = longleggeddoji AND L == C AND Ref(uptrend,-1);
Bear3Formation = bigblack AND C < Ref(C,-4) AND
Ref(H,-1) <= fwh AND Ref(L,-1) >= fwl AND
Ref(H,-2) <= fwh AND Ref(L,-2) >= fwl AND
Ref(H,-3) <= fwh AND Ref(L,-3) >= fwl AND
Ref(isfalling, -4);
BearishAbandonedBaby = EveningDojiStar AND Ref(GapUp(),-1) AND GapDown();
BearishBeltHold = belthold AND blackbody AND Ref(uptrend,-1);
BearishCounterAttack = Ref(big AND whitebody,-1) AND O > Ref(H,-1) AND C == Ref(C,-1) AND big AND blackbody AND Ref(uptrend,-1);
BearishHaramiCross = doji AND Ref(C,-1) > O AND Ref(O,-1) < O AND Ref(big AND whitebody,-1) AND Ref(uptrend,-1);
BearishHarami = Ref(big AND whitebody,-1) AND smallRealBody AND Min(O,C) > Ref(O,-1) AND Max(O,C) < Ref(C,-1) AND Ref(uptrend,-1);
BearishSeparatingLine = Ref(whitebody AND big,-1) AND blackbody AND big AND O == Ref(O,-1) AND Ref(downtrend,-1);
DarkCloudCover = Ref(bigwhite,-1) AND blackbody AND O > Ref(H,-1) AND C <= Ref((O+C)/2,-1) AND C > Ref(O,-1) AND Ref(uptrend,-1);
EngulfingBear = Ref(whitebody,-1) AND blackbody AND engulfing AND Ref(uptrend,-1);
HangingMan = umbrellaline AND uptrend AND Ref(uptrend,-1);
ShootingStar = smallRealBody AND shaven AND realBodyGapUp AND longuppershadow AND Ref(uptrend,-1);
ThreeBlackCrows = (big AND blackbody) AND Ref(big AND blackbody, -1) AND Ref(big AND blackbody, -2) AND O < Ref(O,-1) AND Ref(O,-1) < Ref(O,-2) AND Ref(uptrend,-4);
TriStarBottom = firstDoji AND secDojiLower AND doji AND realBodyGapUp AND isPrevDownTrendx;
TweezerTops = H == Ref(H,-1) AND Ref(big AND whitebody,-1) AND Ref(uptrend,-2);
UpsideGapTwoCrows = Ref(big AND whitebody,-2) AND Ref(realBodyGapUp,-1) AND Ref(smallRealBody,-1) AND Ref(blackbody,-1) AND engulfing AND blackbody AND C > Ref((O+C)/2,-2) AND Ref(uptrend,-2);
KBL = Ref(O,-1) > Ref(C,-1) AND O >= Ref(O,-1) AND C > O;
MorningStar = Ref(starDown,-1) AND whitebody AND big AND C > Ref((O + C)/2,-2);
MorningDojiStar = Ref(dojiStarDown,-1) AND whitebody AND big AND C > Ref((O + C)/2,-2);
Bull3Formation = bigwhite AND C > Ref(C,-4) AND
Ref(H,-1) <= rwh AND Ref(L,-1) >= rwl AND
Ref(H,-2) <= rwh AND Ref(L,-2) >= rwl AND
Ref(H,-3) <= rwh AND Ref(L,-3) >= rwl AND
Ref(isrising, -4);
BullishAbandonedBaby = morningdojistar AND Ref(GapDown(),-1) AND GapUp();
BullishBeltHold = belthold AND whitebody AND Ref(downtrend,-1);
BullishCounterAttack = Ref(big AND blackbody,-1) AND O < Ref(H,-1) AND C == Ref(C,-1) AND big AND whitebody AND Ref(downtrend,-1);
BullishHaramiCross = doji AND Ref(O,-1) > O AND Ref(C,-1) < O AND Ref(big AND blackbody,-1) AND Ref(downtrend,-1);
BullishHarami = Ref(big AND blackbody,-1) AND smallRealBody AND Min(O,C) > Ref(C,-1) AND Max(O,C) < Ref(O,-1) AND Ref(downtrend,-1);
BullishSeparatingLine = Ref(blackbody AND big,-1) AND whitebody AND big AND O == Ref(O,-1) AND Ref(uptrend,-1);
DragonflyDoji = longleggeddoji AND H==C AND Ref(downtrend,-1);
EngulfingBull = Ref(blackbody,-1) AND whitebody AND engulfing AND Ref(downtrend,-1);
Hammer = umbrellaline AND Ref(downtrend,-1);
InvertedHammer = smallRealBody AND shaven AND realBodyGapDown AND longuppershadow AND Ref(downtrend,-1);
PiercingLine = Ref(bigblack,-1) AND whitebody AND O < Ref(L,-1) AND C >= Ref((O+C)/2,-1) AND C < Ref(O,-1) AND Ref(downtrend,-1);
SeperatingLines = O == Ref(O,-1) AND (blackbody AND Ref(whitebody,-1) OR whitebody AND Ref(blackbody,-1));
ThreeWhiteSoldiers = (whitebody AND big) AND Ref(whitebody AND big,-1) AND Ref(whitebody AND big,-2) AND O > Ref(O,-1) AND Ref(O,-1) > Ref(O,-2);
TriStarTop = firstDoji AND secDojiHigher AND doji AND realBodyGapDown AND isPrevUpTrendx;
TweezerBottoms = L == Ref(L,-1) AND Ref(big AND blackbody,-1) AND Ref(downtrend,-2);
DownwardGappingTasuki = isFallingBlack AND whitebody AND opensInside AND C > Ref(O,-1) AND windowOpen AND similarSize;
UpwardGappingTasuki = isRisingWhite AND blackbody AND opensInside AND C < Ref(O,-1) AND windowOpenx AND similarSize;
InvertedBlackHammer = blackbody AND InvertedHammer;
Bearcandles = KBR + EveningDojiStar + EveningStar + GraveStoneDoji + Bear3Formation + BearishAbandonedBaby + BearishBeltHold + BearishCounterAttack + BearishHaramiCross +
				BearishHarami + BearishSeparatingLine + DarkCloudCover + EngulfingBear + HangingMan + ShootingStar + ThreeBlackCrows + TriStarBottom + TweezerTops + UpsideGapTwoCrows;
Bullcandles= KBL + MorningStar + MorningDojiStar + Bull3Formation + BullishAbandonedBaby + BullishBeltHold + 
BullishCounterAttack + BullishHaramiCross + BullishHarami +BullishSeparatingLine + DragonflyDoji + EngulfingBull + Hammer + InvertedHammer + PiercingLine + SeperatingLines + ThreeWhiteSoldiers + TriStarTop + TweezerBottoms;
Bears = /*Bears*/
WriteIf(KBR, "Bearish Kicker",
WriteIf(EveningDojiStar, "Evening Doji Star",
WriteIf(EveningStar, "Evening Star",
WriteIf(GraveStoneDoji, "Grave Stone Doji",
WriteIf(Bear3Formation, "Bear 3 Formation",
WriteIf(BearishAbandonedBaby, "Bearish Abandoned Baby",
WriteIf(BearishBeltHold, "Bearish Belt Hold",
WriteIf(BearishCounterAttack, "Bearish Counter Attack",
WriteIf(BearishHaramiCross, "Bearish Harami Cross",
WriteIf(BearishHarami, "Bearish Harami",
WriteIf(BearishSeparatingLine, "BearishSeparatingLine",
WriteIf(DarkCloudCover, "DarkCloudCover",
WriteIf(EngulfingBear, "Engulfing Bear",
WriteIf(HangingMan, "Hanging Man",
WriteIf(ShootingStar, "Shooting Star",
WriteIf(ThreeBlackCrows, "Three Black Crows",
WriteIf(TriStarBottom, "TriStar Bottom",
WriteIf(TweezerTops, "Tweezer Tops",
WriteIf(UpsideGapTwoCrows, "UpsideGapTwoCrows","")))))))))))))))))));
Bulls=/*Bulls*/
WriteIf(KBL, "Bullish Kicker",
WriteIf(MorningStar, "Morning Star",
WriteIf(MorningDojiStar, "Morning Doji Star",
WriteIf(Bull3Formation, "Bull 3 Formation",
WriteIf(BullishAbandonedBaby, "Bullish Abandoned Baby",
WriteIf(BullishBeltHold, "Bullish Belt Hold",
WriteIf(BullishCounterAttack, "Bullish Counter Attack",
WriteIf(BullishHaramiCross, "Bullish Harami Cross",
WriteIf(BullishHarami, "Bullish Harami",
WriteIf(BullishSeparatingLine, "Bullish Separating Line",
WriteIf(DragonflyDoji, "Dragonfly Doji",
WriteIf(EngulfingBull, "Engulfing Bull",
WriteIf(Hammer, "Hammer",
WriteIf(InvertedHammer, "Inverted Hammer",
WriteIf(PiercingLine, "Piercing Line",
WriteIf(SeperatingLines, "Seperating Lines",
WriteIf(ThreeWhiteSoldiers, "Three White Soldiers",
WriteIf(TriStarTop, "Tri-Star Top",
WriteIf(TweezerBottoms, "Tweezer Bottoms","")))))))))))))))))));
}

//////Divergence////Tin Hieu Phan Ky/////////////
{
GraphXSpace=7;
nph=Param("% Reverse ",20,0,100,1);
Buyph=Sellph=0;
Varph = Zig(RSI(14), nph);
tph= Trough(RSI(14), nph, 1);
pph= Peak(RSI(14), nph, 1);
xph[0] =Varph[0];
price[0] = C[0];
jph=0;
}
// bearish divergence
for ( iph=0; iph<BarCount; iph++)
{
if(Varph[iph] == pph[iph])
{
jph++;
xph[jph] =Varph[iph];
price[jph] =C[iph];
if(xph[jph] <xph[jph-1] && price[jph-1]< price[jph])
Sellph[iph] =1;
}
}

// bullish divergence
for ( iph=0; iph<BarCount; iph++)
{
if(Varph[iph] == tph[iph])
{
jph++;
xph[jph] =Varph[iph];
price[jph] =C[iph];
if(xph[jph] >xph[jph-1] && price[jph]<price[jph-1])
Buyph[iph] =1;
}
}

// ADX
{
Range             = Param(" +DI - D range", 10, 5, 30,1 );
BUY_ADX             = Cross(PDI(Range), MDI(Range)) OR Cross (PDI(Range), ADX(Range))OR Cross (ADX(Range), MDI(Range));
SELL_ADX            = Cross(MDI(Range), PDI(Range))OR Cross (MDI(Range), ADX(Range))OR Cross (ADX(Range), PDI (Range)) OR  (PDI(Range)>=(40) );
////////////
adxBuyxt =  Cross( PDI( 14 ), MDI( 14 ) ) OR (PDI( 14 ) > MDI( 14 ));
adxSellxt = Cross( MDI( 14 ), PDI( 14 ) ) OR (MDI( 14 ) > PDI( 14 ));
}
//MACD
{
r1 = Param( "Fast avg", 12, 2, 200, 1 );
r2 = Param( "Slow avg", 26, 2, 200, 1 );
r3 = Param( "Signal avg", 9, 2, 200, 1 );
//MACD crossing zero
B_MACD_0 =  Cross(MACD(r1, r2),0);
S_MACD_0 =  Cross(0,MACD(r1, r2));
//Bullish - Bearish MACD crossing signal above zero or below zero plane
BULL_CROSS_ABOVE_ZERO = Cross (MACD(r1, r2),Signal(r1,r2,r3)) AND MACD(r1, r2) > 0;
BEAR_CROSS_ABOVE_ZERO = Cross (Signal(r1,r2,r3),MACD(r1, r2)) AND MACD(r1, r2) > 0;
//bELOW ZERO Bullish - Bearish MACD crossing signal above zero or below zero plane
BULL_CROSS_BELOW_ZERO  = Cross (MACD(r1, r2),Signal(r1,r2,r3)) AND MACD(r1, r2)<0;
BEAR_CROSS_BELOW_ZERO  = Cross(Signal(r1,r2,r3),MACD(r1, r2)) AND MACD(r1, r2)<0;
//Zero line reject ZLR
BEAR_ZLR = BarsSince(B_MACD_0);
BEAR_ZLR1 = (BEAR_ZLR < 6) AND (S_MACD_0);
BULL_ZLR = BarsSince(S_MACD_0);
BULL_ZLR1 = (BULL_ZLR < 6) AND (B_MACD_0);
//HOOKS
BULL_HOOK1 = BarsSince(BEAR_CROSS_ABOVE_ZERO);
BULL_HOOK = (BULL_HOOK1<6) AND BULL_CROSS_ABOVE_ZERO ;
BEAR_HOOK1 = BarsSince(BULL_CROSS_ABOVE_ZERO);
BEAR_HOOK = (BEAR_HOOK1<6) AND BEAR_CROSS_ABOVE_ZERO ;
BUY_MACD = B_MACD_0 + BULL_CROSS_ABOVE_ZERO + BULL_CROSS_BELOW_ZERO + BULL_ZLR1 + BULL_HOOK;
SELL_MACD = S_MACD_0 + BEAR_CROSS_ABOVE_ZERO + BEAR_CROSS_BELOW_ZERO + BEAR_ZLR1 + BEAR_HOOK;
MBxt = Cross ( MACD(), Signal() ) OR (MACD() > Signal());
MSxt = Cross( Signal(), MACD() ) OR (MACD() < Signal());

}

//RSI
{
Rperiods = Param( "Periods", 14, 1, 200, 1 );
OB = Param("OverBrought Line",70,70,100,1);
OS = Param("OverSold Line",30,20,40,1);
RSI_PERIODS = Prec(RSI( Rperiods),1);
//******* RSI Cross 30 or 70**//
RSI_BUY=RSI_CROSS_30 = Cross(RSI_PERIODS,OS);
RSI_SELL=RSI_CROSS_70 = Cross(OB,RSI_PERIODS);
Ibuyxt =  Cross( RSI( 14 ), EMA( RSI( 14 ), 9 ) );
Isellxt = Cross( EMA( RSI( 14 ), 9 ), RSI( 14 ) );
}

// tochastics
{
SP = Param( "Periods", 10, 1, 200, 1 );
Ksmooth = Param( "%K avg", 5, 1, 200, 1 );
Dsmooth = Param( "%D avg", 5, 1, 200, 1 );
StochDval = StochD( SP , Ksmooth, DSmooth );
StochKval = StochK( SP , Ksmooth);
StochBuy = Cross(StochK(SP,Ksmooth), StochD(SP,Ksmooth, DSmooth)) AND 
(StochD(SP,Ksmooth, DSmooth) > 20) AND (StochK(SP,Ksmooth) > 20) AND
(StochD(SP,Ksmooth, DSmooth) < 80) AND (StochK(SP,Ksmooth) < 80);
StochSell = Cross (StochD(SP,Ksmooth, DSmooth), StochK(SP,Ksmooth)) AND
(StochD(SP,Ksmooth, DSmooth) > 20) AND (StochK(SP,Ksmooth) > 20) AND
(StochD(SP,Ksmooth, DSmooth) < 80) AND (StochK(SP,Ksmooth) < 80);
StochStrongBuy = Cross(StochK(SP,Ksmooth),StochD(SP,Ksmooth, DSmooth)) AND 
(StochD(SP,Ksmooth, DSmooth) < 20) AND (StochK(SP,Ksmooth) < 20) ;
StochStrongSell = Cross (StochD(SP,Ksmooth,DSmooth), StochK(SP , Ksmooth));
(StochD(SP,Ksmooth, DSmooth) > 80) AND (StochK(SP,Ksmooth) > 80);
BUY_STOCH = StochBuy + StochStrongBuy;
SELL_STOCH = StochSell + StochStrongSell;
{
StochKvalxt = StochK( 10, 5 );
StochDvalxt = StochD( 10, 5, 5 );
StochBuyxt = Cross( StochK( 10, 5 ), StochD( 10, 5, 5 ) );
StochSellxt = Cross ( StochD( 10, 5, 5 ), StochK( 10, 5 ) );
////
OBSettingxt=Param("Setting",45,1,500,1);
Blinext = StochD(OBSettingxt);
Oversoldxt=Blinext<=30;
Overboughtxt=Blinext>=85;
}
//
////////////StochD(14)////////////
{
ST33ph=StochD(14);
TR1ph=LLVBars(ST33ph,4);
TR2ph=IIf(ST33ph<30 AND TR1ph>0 AND Ref(TR1ph,-1)==0,Ref(ST33ph,-1),0);
TRCph=IIf(TR2ph>0,C,0);
vsph=ValueWhen(tr2ph, Ref(st33ph,-1), 1);
dvsph=vsph-Ref(vsph,-1);
vcph=ValueWhen(trcph, LLV(C,3), 1);
dvcph=vcph-Ref(vcph,-1);
diverph=IIf(dvsph>0 AND dvcph<0,30,0);
DASph=BarsSince(Ref(TR2ph,-1)>0);
DDph=IIf(DASph<20 AND C>=Ref(C,-1),DIVERph,0);
//Graph0=TR2;
//Graph0Style=2;
//Graph0BarColor=12;
//Graph1=dd;
//Graph1BarColor=5;
Buy1ph=DDph>0 ;
ST33ph=StochD(14);
TR11ph=HHVBars(ST33ph,4);
TR21ph=IIf(ST33ph>70 AND TR11ph>0 AND Ref(TR11ph,-1)==0,Ref(ST33ph,-1),0);
TRC1ph=IIf(TR21ph>0,C,0);
vs1ph=ValueWhen(tr21ph, Ref(st33ph,-1), 1);
dvs1ph=vs1ph-Ref(vs1ph,-1);
vc1ph=ValueWhen(trc1ph, HHV(H,3), 1);
dvc1ph=vc1ph-Ref(vc1ph,-1);
diver1ph=IIf(dvs1ph<0 AND dvc1ph>0,90,0);
DAS1ph=BarsSince(Ref(TR21ph,-1)>0);
ddd1ph=IIf(DAS1ph<20 AND C<Ref(C,-1),DIVER1ph,0);
}
}
//OBV
{
MA_OBV_Period = Param("OBV_MA Period",10,10,21,1);
/***********OBV CROSS MA************/
OBV_BUY = Cross(OBV(),MA(OBV(),MA_OBV_Period));
OBV_SELL = Cross(MA(OBV(),MA_OBV_Period),OBV());
}
//Gap 
{
 GAP_UP = GapUp();
GAP_DW = GapDown();
}
//==============Zero Lag TMA ==============
function ZeroLagTEMA( array, period )
{
    TMA1 = TEMA( array, period );
    TMA2 = TEMA( TMA1, period );
    Diff = TMA1 - TMA2;
    return TMA1 + Diff ;
}

{
MAPeriod = Param("MA Period", 4, 1, 100);
MAOpen = EMA(Open, MAPeriod);
MAHigh = EMA(High, MAPeriod);
MALow = EMA(Low, MAPeriod);
MAClose = EMA(Close, MAPeriod);
HaClose = (MAOpen + MAHigh + MALow + MAClose) / 4;
HaOpen = AMA(Ref(HaClose, -1), 0.5);
HaHigh = Max(MAHigh, Max(HaClose, HaOpen)); 
HaLow = Min(MALow, Min(HaClose, HaOpen)); 
haClosext = ( haClose + haOpen + haHigh + haLow ) / 4;
periodtmxt = 55;
ZLHaxt = ZeroLagTEMA( haClosext, periodtmxt );
ZLTypxt = ZeroLagTEMA( Avg, periodtmxt );
TMBuyxt = Cross( ZLTypxt, ZLHaxt );
TMSellxt = Cross( ZLHaxt, ZLTypxt );

//Graph1BarColor=1;
{
Sell1ph=ddd1ph==90;
EMA1ph= EMA(Close,12);
EMA2ph= EMA(EMA1ph,12);
Differenceph= EMA1ph - EMA2ph;
ZeroLagEMApph= EMA1ph + Differenceph;
//---------------------------------------
EMA1ph= EMA(Close,26);
EMA2ph= EMA(EMA1ph,26);
Differenceph= EMA1ph - EMA2ph;
ZeroLagEMAqph= EMA1ph + Differenceph;
//---------------------------------------
ZeroLagMACDph=ZeroLagEMApph - ZeroLagEMAqph;
ST33ph= ZeroLagMACDph;
barsph=50;
TR1ph= LLVBars(ST33ph,5);
COND1ph=TR1ph> 0 AND Ref(TR1ph,-1)==0 AND Ref(ST33ph,-1)<0;
TR2ph= IIf(COND1ph,Ref(ST33ph,-1),0);
M1ph= ValueWhen(COND1ph,ST33ph);
P1ph= ValueWhen(COND1ph,LLV(L,3));
DM1ph=M1ph- Ref(M1ph,-1);DP1ph=P1ph-Ref(P1ph,-1);
DTph= Ref(BarsSince(COND1ph),-1);
POSDIVph=DM1ph> 0 AND DP1ph<0 AND DTph<BARSph; 
TR11ph= HHVBars(ST33ph,5);
COND11ph=TR11ph> 0 AND Ref(TR11ph,-1)==0 AND Ref(ST33ph,-1)>0;
TR21ph= IIf(COND11ph,Ref(ST33ph,-1),0);
M11ph= ValueWhen(COND11ph,ST33ph);
P11ph= ValueWhen(COND11ph,HHV(H,3));
DM11ph=M11ph- Ref(M11ph,-1);DP11ph=P11ph-Ref(P11ph,-1);
DT1ph= Ref(BarsSince(COND11ph),-1);
NEGDIVph=DM11ph< 0 AND DP11ph>0 AND DT1ph<BARSph;
}
}

//========hist divergence
{
a1ph=EMA(C,12)-EMA(C,26);
a2ph = EMA(a1ph,9);
Histph = a1ph-a2ph;
ST33ph= Histph;
barsph=50;
TR1ph= LLVBars(ST33ph,5);
COND1ph=TR1ph> 0 AND Ref(TR1ph,-1)==0 AND Ref(ST33ph,-1)<0;
TR2ph= IIf(COND1ph,Ref(ST33ph,-1),0);
M1ph= ValueWhen(COND1ph,ST33ph);
P1ph= ValueWhen(COND1ph,LLV(L,3));
DM1ph=M1ph- Ref(M1ph,-1);DP1ph=P1ph-Ref(P1ph,-1);
DTph= Ref(BarsSince(COND1ph),-1);
POSDIV1ph=DM1ph> 0 AND DP1ph<0 AND DTph<BARSph; 
TR11ph= HHVBars(ST33ph,5);
COND11ph=TR11ph> 0 AND Ref(TR11ph,-1)==0 AND Ref(ST33ph,-1)>0;
TR21ph= IIf(COND11ph,Ref(ST33ph,-1),0);
M11ph= ValueWhen(COND11ph,ST33ph);
P11ph= ValueWhen(COND11ph,HHV(H,3));
DM11ph=M11ph- Ref(M11ph,-1);DP11ph=P11ph-Ref(P11ph,-1);
DT1ph= Ref(BarsSince(COND11ph),-1);
NEGDIV1ph=DM11ph< 0 AND DP11ph>0 AND DT1ph<BARSph;
}

//================cci divergence
{
ST33ph= CCI(14);
barsph=50;
TR1ph= LLVBars(ST33ph,5);
COND1ph=TR1ph> 0 AND Ref(TR1ph,-1)==0 AND Ref(ST33ph,-1)<0;
TR2phph= IIf(COND1ph,Ref(ST33ph,-1),0);
M1ph= ValueWhen(COND1ph,ST33ph);
P1ph= ValueWhen(COND1ph,LLV(L,3));
DM1ph=M1ph- Ref(M1ph,-1);DP1ph=P1ph-Ref(P1ph,-1);
DTph= Ref(BarsSince(COND1ph),-1);
POSDIV2ph=DM1ph> 0 AND DP1ph<0 AND DTph<BARSph; 
TR11ph= HHVBars(ST33ph,5);
COND11ph=TR11ph> 0 AND Ref(TR11ph,-1)==0 AND Ref(ST33ph,-1)>0;
TR21ph= IIf(COND11ph,Ref(ST33ph,-1),0);
M11ph= ValueWhen(COND11ph,ST33ph);
P11ph= ValueWhen(COND11ph,HHV(H,3));
DM11ph=M11ph- Ref(M11ph,-1);DP11ph=P11ph-Ref(P11ph,-1);
DT1ph= Ref(BarsSince(COND11ph),-1);
NEGDIV2ph=DM11ph< 0 AND DP11ph>0 AND DT1ph<BARSph;
quabancci=CCI( 14 ) < -100;
quamuacci=CCI( 14 ) > 100;
}

//////Buy -Sell Divergence
{
DayHph = TimeFrameGetPrice("H", inDaily, -1);// yesterdays high 
DayLph = TimeFrameGetPrice("L", inDaily, -1);//low 
DayCph = TimeFrameGetPrice("C", inDaily, -1);//close
R4ph = (((DayHph / DayLph) + 0.83) / 1.83) * DayCph;
S4ph = (2-( (DayHph / DayLph) + 0.83) / 1.83) * DayCph;
intra_buyph = C > R4ph AND (Buyph OR  Buy1ph OR posdivph OR posdiv1ph OR posdiv2ph);
intra_sellph = C < S4ph AND ( Sellph OR Sell1ph OR negdivph OR negdiv1ph OR negdiv2ph); 
  }

//============== WILLIAM'S %R ==============
{
WRxt = ( ( HHV( H, 14 ) - C ) / ( HHV ( H, 14 ) - LLV ( L, 14 ) ) ) * -100;
wrxtquamua=WRxt > -20;
WRxtquaban=WRxt < -80;
}
//============== A/D ==============
{
TRHxt = IIf( Ref( C, -1 ) > H, Ref( C, -1 ), H );
TRLxt = IIf( Ref( C, -1 ) < L, Ref( C, -1 ), L );
adxt = IIf( C > Ref( C, -1 ), C - TRLxt, IIf( C < Ref( C, -1 ), C - TRHxt, 0 ) );
WADxt = Cum( adxt );
wuxt = wadxt > Ref( wadxt, -1 );
wdxt = wadxt < Ref( wadxt, -1 );
}

//3.1 CANH BAO///ACTION

function Rise( Pd, perd, Pl, perl )
{
 MAD = DEMA(Pd,perd);
 MAL = LinearReg(Pl,perl);
 CondR = ROC(MAD,1)>0 AND ROC(MAL,1)>0;
 CondF = ROC(MAD,1)<0 AND ROC(MAL,1)<0; 
 R[0] = C[0]>(H[0]+L[0])/2;

 for(i=1;i<BarCount;i++)
 {
  if( CondR[i] )
  {
   R[i] = 1;
  }
  else
  {
   if( CondF[i] )
   {
    R[i] = 0;
   }
   else
   {
    R[i] = R[i-1];
   }
  }
 }
 return R;
} 
{
PrD = C;
PrL = H/2+L/2;
PrdD = PrdL = PrdM = Param("Prd",12,2,40,1);
permax = Max(prdd,prdl);
Rs = IIf( BarIndex()< permax, 0, Rise(PrD, PrdD, PrL, PrdL) );
Fs = IIf( BarIndex()<permax,0, 1-Rs );
Select = Rs AND Ref(Fs,-1);
Caution = Fs AND Ref(Rs,-1);
}

//_SECTION_BEGIN("buy sell");
nos=Param( "Swing", 5, 1, 55 );
res=HHV(H,nos);
sup=LLV(L,nos);
tsl=IIf(ValueWhen(IIf(C>Ref(res,-1),1,IIf(C<Ref(sup,-1),-1,0))!=0,IIf(C>Ref(res,-1),1,IIf(C<Ref(sup,-1),-1,0)),1)==1,sup,res);
//Plot(tsl, _DEFAULT_NAME(), colorGrey40, styleStaircase);
Buyswing = Cross(C,tsl) ;
Sellswing = Cross(tsl,C)  ;
PlotShapes(shapeSmallCircle*Buyswing, colorBlue, 0, L,-5);
PlotShapes(shapeSmallCircle*Sellswing, colorBlue, 0, H,5);
Buysellswingstatus=WriteIf(Buyswing,"                                                                 - Cham xanh blue: Buy swing.\n",WriteIf(Sellswing,"                                                                 - Cham xanh blue: Sell swing.\n",""));
//_SECTION_END();
///// Primary Filter
{
NR7xt = (H-L)==LLV((H-L),7); //Narrowest bar in the last 7 bars
InOutInxt = Ref(Inside(),-2) AND Ref(Outside(),-1) AND Inside(); //Inside Bar, followed by outside bar and last bar gain inside bar
new52WKxt = C>Ref(HHV(H,250),-1); // brkout into new 52 week Highest close
BO200MAxt = C>MA(C,200) AND Ref(C,-1)<Ref(MA(C,200),-1) AND (C-L)>0.75*(H-L);// Breakout Of 200MA
BO50MAxt = C>MA(C,50) AND Ref(C,-1)<Ref(MA(C,50),-1) AND (C-L)>0.75*(H-L);// Breakout Of 50MA
BO20MAxt = C>MA(C,20) AND Ref(C,-1)<Ref(MA(C,20),-1) AND (C-L)>0.75*(H-L);// Breakout Of 20MA
BD200MAxt = C<MA(C,200) AND Ref(C,-1)>Ref(MA(C,200),-1) AND C<O AND (O-C)>0.75*(H-L);// Breakdown Of 200MA
BD50MAxt = C<MA(C,50) AND Ref(C,-1)>Ref(MA(C,50),-1) AND C<O AND (O-C)>0.75*(H-L);// Breakdown Of 50MA
BD20MAxt = C<MA(C,20) AND Ref(C,-1)>Ref(MA(C,20),-1) AND C<O AND (O-C)>0.75*(H-L);// Breakdown Of 20MA
VBOxt = V>2*EMA(V,20) AND C>Ref(HHV(H,20),-1); //Price volume breakout
dojixt = abs(C-O)<0.25*(H-L);
DoubleDojixt = dojixt AND Ref(dojixt,-1); //Two Continous Doji
DoubleIBxt = Ref(Inside(),-1) AND Inside(); // coiling of volatility
Pin200MAxt = (C-L)>0.75*(H-L) AND doji AND H>MA(C,200) AND L<MA(C,200); //Pinbar At 200MA
fakednxt = L==LLV(L,10) AND C>Ref(C,-1); //Fakedown Pattern
TopIBxt = EMA(C,5)>EMA(C,10) AND  EMA(C,10)>EMA(C,20) AND Inside();//Top Inside Bar
}
//_SECTION_END();

////////doubleBottom,doubleTop//////
// doubleTop - doubleBottom////
p1xt = Param("TL 1 Periods", 20, 5, 50, 1);
p2xt = Param("TL 2 Periods", 5, 3, 25, 1);
TL1 = LinearReg(C, p1xt);
TL2 = EMA(TL1, p2xt);
bi = BarIndex();
fvb = FirstVisibleValue( bi );
lvb = LastVisibleValue( bi );

rightstrength = Param( "Right Strength", 5, 1, 50, 1 );
leftstrength = Param( "Left Strength", 5, 1, 50, 1 );
fact = Param( "Chart Time Frame Factor", 2, 1, 10, 1 );

rightStrength = rightStrength * fact;
leftStrength = leftStrength * fact;

pk = H == HHV( H, leftstrength ) AND Ref( HHV( H, rightstrength ), rightstrength ) < H;
tr = L == LLV( L, leftstrength ) AND Ref( LLV( L, rightstrength ), rightstrength ) > L;
pkl = H == HHV( H, leftstrength );
trl = L == LLV( L, leftstrength );

for( i = 0; i < 3; i++ )
{
    VarSet( "px" + i, ValueWhen( pk, bi, i ) );
    VarSet( "tx" + i, ValueWhen( tr, bi, i ) );
    VarSet( "ph" + i, ValueWhen( pk, H, i ) );
    VarSet( "tl" + i, ValueWhen( tr, L, i ) );
}


doubleTopThreshold = 0.75 * Ref( ATR( 20 ), -1 );
doubleTop = pk && abs( ph1 - ph2 ) < doubleTopThreshold;

doubleBottomThreshold = 0.75 * Ref( ATR( 20 ), -1 );
doubleBottom = tr && abs( tl1 - tl2 ) < doubleBottomThreshold;
PlotShapes( IIf(doubleBottom, shapeUpArrow, shapeNone), ColorRGB( 250, 125, 0 ), layer = 0, L, offset = -60);
PlotShapes( IIf(doubleTop, shapeDownArrow, shapeNone), ColorRGB( 250, 125, 0 ), layer = 0, H, offset = -60);
for( i = lvb; i > fvb; i-- )
{
    sz = 8;

    // troughs
    


    if( doubleTop[i] )
    {
        str = "Double Top";
        PlotTextSetFont( str, "Arial", sz, i, H[i], ColorRGB( 250, 125, 0 ), colorDefault, 70 );
        
    }
    
     if( doubleBottom[i] )
    {
        str = "Double Bottom";
        PlotTextSetFont( str, "Arial", sz, i, L[i], ColorRGB( 250, 125, 0 ), colorDefault, -80 );
        
    }
    
}
/////END------// doubleTop - doubleBottom////
//////////////////////

///////////Tieu chi 1
ma20=MA(C,20);
ma50=MA(C,50);
ma65=MA(C,65);
ma100=MA(C,100);
ma150=MA(C,150);
ma200=MA(C,200);
ma20catma50up=Cross(ma20,ma50);
ma20catma200up=Cross(ma20,ma200);
ma50catma200up=Cross(ma50,ma200);
ma20catma50dw=Cross(ma50,ma20);
ma20catma200dw=Cross(ma200,ma20);
ma50catma200dw=Cross(ma200,ma50);
mastatus= WriteIf(ma20>ma50 AND ma20>ma200 AND ma50>ma200,"MA20  >  MA50  >  MA200",WriteIf(ma20>ma50 AND ma20>ma200 AND ma50<ma200,"MA20  >  MA200  > MA50",WriteIf(ma20<ma50 AND ma20<ma200 AND ma50<ma200,"MA20  <  MA50  <  MA200"
			,WriteIf(ma20>ma50 AND ma20<ma200 AND ma50<ma200,"MA200  >  MA20  >  MA50",WriteIf(ma20<ma50 AND ma20<ma200 AND ma50>ma200,"MA50  >  MA200  >  MA20",WriteIf(ma20<ma50 AND ma20>ma200 AND ma50>ma200,"MA50  >  MA20  >  MA200",""))))));
ma20crossma50=WriteIf(ma20catma50up,"MA20 Cat MA50 - Up",WriteIf(ma20catma50dw,"MA20 Cat MA50 - Down",""));
ma20crossma200=WriteIf(ma20catma200up,"MA20 Cat MA200 - Up",WriteIf(ma20catma200dw," MA20 Cat MA200 - Down",""));
ma50crossma200=WriteIf(ma50catma200up,"MA50 Cat MA200 - Up",WriteIf(ma50catma200dw,"MA50 Cat MA200 - Down",""));
giacatma20up=Cross(C,ma20);
giacatma20dw=Cross(ma20,C);
giacatma50up=Cross(C,ma50);
giacatma50dw=Cross(ma50,C);
giacatma200up=Cross(C,ma200);
giacatma200dw=Cross(ma200,C);
giacatma20=WriteIf(giacatma20up,"Gia Cat MA20 - Up",WriteIf(giacatma20dw,"Gia Cat MA20 - Down",""));
giacatma50=WriteIf(giacatma50up," | Gia Cat MA50 - Up",WriteIf(giacatma50dw," | Gia Cat MA50 - Down",""));
giacatma200=WriteIf(giacatma200up," | Gia Cat MA200 - Up",WriteIf(giacatma200dw," | Gia Cat MA200 - Down","")); 
ma20ma65up=Cross(ma20,ma65); 
ma20ma65dw=Cross(ma65,ma20);   
muaythien=WriteIf(ma20catma50up,"Buy - Y Thien ",""); 
banythien=WriteIf(ma20catma50dw,"Sell - Y Thien ","");
muadolong=WriteIf(ma20ma65up,"Buy - Do Long ",""); 
bandolong=WriteIf(ma20ma65dw,"Sell - Do Long ","");       
PlotShapes(shapeStar*ma20catma50up, colorGold, 0, L,-20);
PlotShapes(shapeStar*ma20ma65up, colorCustom12, 0, L,-20);
PlotShapes(shapeStar*ma20catma50dw, colorGold, 0, H,20);
PlotShapes(shapeStar*ma20ma65dw, colorCustom12, 0, H,20);
rg=(H-L);
arg=Wilders(rg,30);
// break ma20 vol tang // TANG GIA KEO DAI
dkkhoiluong=V>= 1.2*MA(V,30) AND V>Ref(V,-1) AND V>Ref(V,-2) AND Ref(V,-1)>Ref(V,-2) AND Ref(V,-1)>= 1.1*MA(V,30) AND Ref(V,-2)>= 1.1*MA(V,30) ;
dkgia= C>O AND C>Ref(C,-1) AND C>Ref(C,-2) AND Ref(C,-1)>Ref(C,-2) AND C>ma20 ;
brma20voltang1= C>=ma20 AND V>= 1.2*MA(V,30) AND C>O AND C>Ref(C,-1);
brma20voltang2= giacatma20up AND V>= 1.2*MA(V,30) AND C>O AND C>Ref(C,-1);
statusbrma20= WriteIf(brma20voltang1 OR brma20voltang2,"                                                                 - Gia vuot MA20 va Vol tang.\n","");// break ma20 vol tang
tgkd1=dkkhoiluong AND dkgia;
tgkd= WriteIf(tgkd1,"                                                                 - Tang gia Keo dai; De y cay nen 2-3 ngay truoc, xem da vuot nen gia cu chua.\n","");// TANG GIA KEO DAI


//Mua theo qua bong tenis

tenis= V>= 1.3*MA(V,30) AND C>O AND C>ma20 AND C>Ref(C,-1) AND rg>arg;
tenisstatus= WriteIf(tenis,"                                                                 - Tenis mua, Co the co keo nguoc nho sau vai phien toi, chu y khoi luong giao dich.\n","");//Mua theo qua bong tenis

//so ngay tang gia trong vong 10 ngay truoc
n10t= Ref(C,-10)> Ref(O,-10);
n9t= Ref(C,-9)> Ref(O,-9);
n8t= Ref(C,-8)> Ref(O,-8);
n7t= Ref(C,-7)> Ref(O,-7);
n6t= Ref(C,-6)> Ref(O,-6);
n5t= Ref(C,-5)> Ref(O,-5);
n4t= Ref(C,-4)> Ref(O,-4);
n3t= Ref(C,-3)> Ref(O,-3);
n2t= Ref(C,-2)> Ref(O,-2);
n1t= Ref(C,-1)> Ref(O,-1);
nt= n1t + n2t + n3t + n4t + n5t + n6t + n7t + n8t + n9t + n10t;
sntg=WriteVal(nt,1);//so ngay tang gia trong vong 10 ngay truoc
//so ngay dong cua tot trong vong 10 ngay truoc
n10dc= Ref((C-L),-10)> Ref((H-L)/2,-10);
n9dc= Ref((C-L),-9)> Ref((H-L)/2,-9);
n8dc= Ref((C-L),-8)> Ref((H-L)/2,-8);
n7dc= Ref((C-L),-7)> Ref((H-L)/2,-7);
n6dc= Ref((C-L),-6)> Ref((H-L)/2,-6);
n5dc= Ref((C-L),-5)> Ref((H-L)/2,-5);
n4dc= Ref((C-L),-4)> Ref((H-L)/2,-4);
n3dc= Ref((C-L),-3)> Ref((H-L)/2,-3);
n2dc= Ref((C-L),-2)> Ref((H-L)/2,-2);
n1dc= Ref((C-L),-1)> Ref((H-L)/2,-1);

ndc=  n1dc + n2dc + n3dc + n4dc + n5dc + n6dc + n7dc + n8dc + n9dc + n10dc;
sndctot=WriteVal(ndc,1); //so ngay dong cua tot trong vong 10 ngay truoc

// khoi luong o nhung ngay tang gia so voi giam gia trong vong 10 ngay truoc
v0t=IIf(C>O, V,0);
v1t=IIf(Ref(C,-1)> Ref(O,-1), Ref(V,-1),0);
v2t=IIf(Ref(C,-2)> Ref(O,-2), Ref(V,-2),0);
v3t=IIf(Ref(C,-3)> Ref(O,-3), Ref(V,-3),0);
v4t=IIf(Ref(C,-4)> Ref(O,-4), Ref(V,-4),0);
v5t=IIf(Ref(C,-5)> Ref(O,-5), Ref(V,-5),0);
v6t=IIf(Ref(C,-6)> Ref(O,-6), Ref(V,-6),0);
v7t=IIf(Ref(C,-7)> Ref(O,-7), Ref(V,-7),0);
v8t=IIf(Ref(C,-8)> Ref(O,-8), Ref(V,-8),0);
v9t=IIf(Ref(C,-9)> Ref(O,-9), Ref(V,-9),0);
v10t=IIf(Ref(C,-10)> Ref(O,-10), Ref(V,-10),0);
v0g=IIf(C<O, V,0);
v1g=IIf(Ref(C,-1)< Ref(O,-1), Ref(V,-1),0);
v2g=IIf(Ref(C,-2)< Ref(O,-2), Ref(V,-2),0);
v3g=IIf(Ref(C,-3)< Ref(O,-3), Ref(V,-3),0);
v4g=IIf(Ref(C,-4)< Ref(O,-4), Ref(V,-4),0);
v5g=IIf(Ref(C,-5)< Ref(O,-5), Ref(V,-5),0);
v6g=IIf(Ref(C,-6)< Ref(O,-6), Ref(V,-6),0);
v7g=IIf(Ref(C,-7)< Ref(O,-7), Ref(V,-7),0);
v8g=IIf(Ref(C,-8)< Ref(O,-8), Ref(V,-8),0);
v9g=IIf(Ref(C,-9)< Ref(O,-9), Ref(V,-9),0);
v10g=IIf(Ref(C,-10)< Ref(O,-10), Ref(V,-10),0);
vt=v0t+v1t+v2t+v3t+v4t+v5t+v6t+v7t+v8t+v9t+v10t;
vg=v0g+v1g+v2g+v3g+v4g+v5g+v6g+v7g+v8g+v9g+v10g;
tylev=vt*100/(vg+vt);
volstatus= WriteIf(tylev>50,"                                                                 - Khoi luong o nhung ngay tang gia cao hon nhung ngay giam gia (10 ngay).  "+WriteVal(tylev,1)+" %"+" \n","");//khoi luong o nhung ngay tang gia so voi giam gia trong vong 10 ngay truoc

// 3 day thap hon, khoi luong lon gia nam duoi Ma20
badaythaphon= C<ma20 AND Ref(C,-2)<Ref(O,-2)AND Ref(C,-1)<Ref(O,-1) AND ( Ref(V,-2) >MA(V,15) OR Ref(V,-1) >MA(V,15) OR V >MA(V,15))
				AND Ref(L,-2)>Ref(L,-1) AND Ref(L,-1)>L;
giadongcua1= C<O AND rg>arg;
giadongcua2= C<O AND (H-C)<=(H-L)/3;
badaydk1= WriteIf(badaythaphon AND giadongcua1,"                                                                 - gia dong cua duoi MA20, 3 day thap hon, khoi luong lon khong co luc mua ho tro. Kha nang giao dich that bai. \n","");
badaydk2=WriteIf(badaythaphon AND giadongcua2,"                                                                  - gia dong cua duoi MA20, 3  day thap hon, khoi luong lon, co luc mua ho tro--> Hay can nhac.\n","");



// thong tin khangs cu ho tro ma va kijun
{//Crossing Resistance Lines MA AND KJUN
xt11c=Cross(C,KJ65);
xt12c=Cross(C,KJ129);
xt13c=Cross(C,MA20);
xt14c=Cross(C,MA50);
xt15c=Cross(C,MA200);
//Breaking support Lines MA AND KJUN
yt11c=Cross(KJ65,C);
yt12c=Cross(KJ129,C);
yt13c=Cross(MA20,C);
yt14c=Cross(MA50,C);
yt15c=Cross(MA200,C);
//Resistance approaching MA AND KJUN
ax11=C<KJ65 AND C>KJ65*0.97;
ax12=C<KJ129 AND C>KJ129*0.97;
ax13=C<MA20 AND C>MA20*0.97;
ax14=C<MA50 AND C>MA50*0.97;
ax15=C<MA200 AND C>MA200*0.97;
//Support approaching MA AND KJUN
ay11=C>KJ65 AND C<KJ65*1.03;
ay12=C>KJ129 AND C<KJ129*1.03;
ay13=C>MA20 AND C<MA20*1.03;
ay14=C>MA50 AND C<MA50*1.03;
ay15=C>MA200 AND C<MA200*1.03;
//Resistance lines commentary MA AND KJUN
khangcuma=
WriteIf(xt11c AND V>volAvg,"                                                                 - Khang cu tai KJ65 "+WriteVal(KJ65,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt11c AND V<volAvg,"                                                                 - Khang cu tai KJ65 "+WriteVal(KJ65,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(xt12c AND V>volAvg,"                                                                 - Khang cu tai KJ129 "+WriteVal(KJ129,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt12c AND V<volAvg,"                                                                 - Khang cu tai KJ129 "+WriteVal(KJ129,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(xt13c AND V>volAvg,"                                                                 - Khang cu tai MA20 "+WriteVal(MA20,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt13c AND V<volAvg,"                                                                 - Khang cu tai MA20 "+WriteVal(MA20,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(xt14c AND V>volAvg,"                                                                 - Khang cu tai MA50 "+WriteVal(MA50,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt14c AND V<volAvg,"                                                                 - Khang cu tai MA50 "+WriteVal(MA50,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(xt15c AND V>volAvg,"                                                                 - Khang cu tai MA200 "+WriteVal(MA200,1.2)+" Bi pha vo voi khoi luong cao.Bullish.\n",
WriteIf(xt15c AND V<volAvg,"                                                                 - Khang cu tai MA200 "+WriteVal(MA200,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""));
//Support line breaks Commentary MA AND KJUN
hotroma=
WriteIf(yt11c AND V>volAvg,"                                                                 - Ho tro tai KJ65 "+WriteVal(KJ65,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt11c AND V<volAvg,"                                                                 - Ho tro tai KJ65 "+WriteVal(KJ65,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(yt12c AND V>volAvg,"                                                                 - Ho tro tai KJ129 "+WriteVal(KJ129,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt12c AND V<volAvg,"                                                                 - Ho tro tai KJ129 "+WriteVal(KJ129,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(yt13c AND V>volAvg,"                                                                 - Ho tro tai MA20 "+WriteVal(MA20,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt13c AND V<volAvg,"                                                                 - Ho tro tai MA20 "+WriteVal(MA20,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(yt14c AND V>volAvg,"                                                                 - Ho tro tai MA50 "+WriteVal(MA50,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt14c AND V<volAvg,"                                                                 - Ho tro tai MA50 "+WriteVal(MA50,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""))+
WriteIf(yt15c AND V>volAvg,"                                                                 - Ho tro tai MA200 "+WriteVal(MA200,1.2)+" Bi pha vo voi khoi luong cao.Bearish.\n",
WriteIf(yt15c AND V<volAvg,"                                                                 - Ho tro tai MA200 "+WriteVal(MA200,1.2)+" Bi pha vo voi khoi luong thap. caution adviced.\n",""));
//Resistance approaching Commentary
kcuMA=
WriteIf(ax11 AND tls>0, "                                                                 - Gia gan den khang cu tai KJ65 "+WriteVal(KJ65,1.2)+  ". \n","")+
WriteIf(ax12 AND tls>0, "                                                                 - Gia gan den khang cu tai KJ129 "+WriteVal(KJ129,1.2)+  ". \n","")+
WriteIf(ax13 AND tls>0, "                                                                 - Gia gan den khang cu tai MA20 "+WriteVal(MA20,1.2)+  ". \n","")+
WriteIf(ax14 AND tls>0, "                                                                 - Gia gan den khang cu tai MA50 "+WriteVal(MA50,1.2)+  ". \n","")+
WriteIf(ax15 AND tls>0, "                                                                 - Gia gan den khang cu tai MA200 "+WriteVal(MA200,1.2)+  ". \n","");
htroma=
WriteIf(ay11 AND tls<0, "                                                                 - Gia gan den ho tro tai KJ65 "+WriteVal(KJ65,1.2)+  ". \n","")+
WriteIf(ay12 AND tls<0, "                                                                 - Gia gan den ho tro tai KJ129 "+WriteVal(KJ129,1.2)+  ". \n","")+
WriteIf(ay13 AND tls<0, "                                                                 - Gia gan den ho tro tai MA20 "+WriteVal(MA20,1.2)+  ". \n","")+
WriteIf(ay14 AND tls<0, "                                                                 - Gia gan den ho tro tai MA50 "+WriteVal(MA50,1.2)+  ". \n","")+
WriteIf(ay15 AND tls<0, "                                                                 - Gia gan den ho tro tai MA200 "+WriteVal(MA200,1.2)+  ". \n","");
}

////// O VUONG MAU
{
GfxSetOverlayMode(0);
GfxSelectPen( colorGrey40, 0 ); // data tooltip round border color
GfxSelectSolidBrush( colorLavender ); // data tooltip color
GfxRoundRect( 0, 20 , 200 , 500 , 10, 10 ); // data tooltip size
GfxRoundRect( 200, 20 , 400 , 90 , 10, 10 );
GfxRoundRect( 0, 0 , 110 , 20 , 0, 0 ); // name
GfxRoundRect( 110, 0 , 420 , 20 , 0, 0 ); //O-H-L-C
GfxRoundRect( 420, 0 , 520 , 20 , 0, 0 ); // Change
GfxRoundRect( 520, 0 , 680 , 20 , 0, 0 ); // Volume
GfxRoundRect( 680, 0 , 850 , 20 , 0, 0 ); // GTGD
GfxRoundRect( 850, 0 , 1350 , 20 , 0, 0 ); // GTGD
GfxRoundRect( 200, 90 , 360 , 110 , 0, 0 ); // GTGD

GfxSelectSolidBrush( colorDarkYellow ); // tieu de
GfxRoundRect( 0, 160 , 200 , 177 , 8, 8 ); // Ap Luc Mua - Ban
GfxRoundRect( 0, 225 , 200 , 242 , 8, 8 ); // Chi Bao Phan Ky
GfxRoundRect( 0, 275 , 200 , 292 , 8, 8 ); // Chi Bao ICHI
GfxRoundRect( 0, 330 , 200 , 347 , 8, 8 ); // He Thong giao dich
GfxRoundRect( 0, 65 , 200 , 82 , 8, 8 ); // Ly Do Mua/ban

}
GfxSetOverlayMode(0);
GfxSelectFont("Arial",10, 500);
GfxSetBkMode(0); // transparent
GfxSetTextColor( colorWhite );
GfxTextOut("Ap Luc Mua - Ban " , 55, 160);
GfxTextOut("Chi Bao Phan Ky " , 55, 225);
GfxTextOut("Ichimoku " , 75, 275);
GfxTextOut("He Thong Giao Dich " , 50, 330);
GfxTextOut("Ly Do Mua - Ban " , 55, 65);
GfxSetTextColor( colorBlue);
GfxTextOut("Kijun 65: " , 205, 22);
GfxTextOut("Kijun 129: " , 300, 22);
GfxTextOut("----------------------------------------------- " , 5, 375);
GfxTextOut("Candles: " , 2, 390);

{
GfxSetOverlayMode(0);
GfxSelectFont("Arial",10, 500);
GfxSetBkMode(0); // transparent
GfxSetTextColor( colorBlack );
GfxTextOut("" +Name()+" - "+ Date(), 2, 1.4);
GfxSetTextColor( colorBlue );
GfxTextOut("Open:", 115, 1.5);
GfxSetTextColor( colorBlack);
GfxTextOut(""+WriteVal(O,format=1.2), 150, 1.3);
GfxSetTextColor( colorBlue );
GfxTextOut("Close:", 190, 1.5);
GfxSetTextColor( colorBlack);
GfxTextOut(""+WriteVal(C,format=1.2), 230, 1.3);
GfxSetTextColor( colorBlue );
GfxTextOut("Low:", 270, 1.5);
GfxSetTextColor( colorBlack);
GfxTextOut(""+WriteVal(L,format=1.2), 300, 1.5);
GfxSetTextColor( colorBlue );
GfxTextOut("Hight:", 340, 1.5);
GfxSetTextColor( colorBlack);
GfxTextOut(""+WriteVal(H,format=1.2), 380, 1.5);
GfxSetTextColor( colorBlue);
GfxTextOut("Change:", 430, 1.5);
GfxSetTextColor( colorBlack);
GfxTextOut(""+WriteVal(ROC(C,1),format=1.2)+ "%", 480, 1.5);
GfxSetTextColor( colorBlue);
GfxTextOut("Volume:", 530, 1.5);
GfxSetTextColor( colorBlack);
GfxTextOut(""+WriteVal(V,1), 580, 1.5);
GfxSetTextColor( colorBlue);
GfxTextOut("GTGD:", 690, 1.5);
GfxSetTextColor( colorBlack);
GfxTextOut(""+WriteVal(V*C,1), 735, 1.5);
GfxSetTextColor( colorDarkGreen );
GfxTextOut("" + mastatus, 860, 1.3);
GfxSetTextColor( colorBrown );
GfxTextOut("" + ma20crossma50 + ma20crossma200 + ma50crossma200 + giacatma20 + giacatma50 + giacatma200, 1030, 1.3);
GfxSetTextColor( colorBlack );
GfxTextOut("" + WriteVal(KJ65,1.2), 260, 22);
GfxSetTextColor( colorBlack);
GfxTextOut("" + WriteVal(KJ129,1.2), 360, 22);
GfxSetTextColor( colorBlack);
GfxTextOut("Bollinger Fibonanci Band", 205, 92);
GfxSetTextColor( colorDarkGreen );
GfxTextOut("" + Bulls, 65, 390);
GfxSetTextColor( colorRed );
GfxTextOut("" + Bears, 65, 390);
GfxSetTextColor( colorBrown);
GfxTextOut("YTDL   :", 5, 430);
GfxSetTextColor( colorGreen);
GfxTextOut(""+muaythien+muadolong, 70, 430);
GfxSetTextColor( colorRed);
GfxTextOut(""+banythien+bandolong, 70, 430);
}
{
GfxSetOverlayMode(0);
GfxSelectFont("Arial",8.5, 500);
GfxSetBkMode(0); // transparent
GfxSetTextColor( colorGreen );
GfxTextOut("Ap Luc Mua = "+WriteVal(nbfraw,1.3)+ " ( Smooth = "+ WriteVal(nbf,1.3)+" )" , 5, 180);
GfxSetTextColor( colorRed );
GfxTextOut("Ap Luc Ban  = "+WriteVal(nsfraw,1.3)+ " ( Smooth = "+ WriteVal(nsf,1.3)+" )" , 5, 195);
GfxSetTextColor( colorDarkGrey );
GfxTextOut("Suc Manh    = " +WriteVal(diffsucmanh,1.3) , 5, 210);
GfxSetTextColor( colorGreen );
GfxTextOut("MACD : " + WriteIf( Buymapk,"Buy", WriteIf( Sellmapk,  "Sell",""))+WriteIf( Buymahpk,"| Buy-Histogram", WriteIf( Sellmahpk,  "| Sell-Histogram",""))
					+WriteIf( HistPosDivergence,"| Buy-Histogram 1", WriteIf( HistNegDivergence,  "| Sell-Histogram 1",""))+WriteIf( MACDPosDivergence,"| Buy-1", WriteIf( MACDNegDivergence,  "| Sell-1","")), 5, 245);
GfxSetTextColor( colorBrown );
GfxTextOut("RSI     : " + WriteIf( Buyrsi1,"Buy", WriteIf( Sellrsi1,  "Sell",""))+WriteIf( Buyrsi150," | 150 S-Buy", WriteIf( Sellrsi150,  "| 150 S-Sell",""))
						+ WriteIf( Buyr2,"| 260 S-Buy", WriteIf( Sellr2,  "| 260 S-Sell",""))+WriteIf( Buypk1," | Buy PK1", WriteIf( Sellpk1,  "| Sell PK1",""))
						+ WriteIf( Buypk2,"| Buy PK2", WriteIf( Sellpk2,  "| Sell PK2",""))+ WriteIf( Buyrsi130,"| 130 S-Buy", WriteIf( Sellrsi130,  "| 130 S-Sell","")), 5, 260);

GfxSetTextColor( colorGreen );
GfxTextOut("[9] [26] [26] [26] : " + WriteIf( StrongBuy,"S-Buy", WriteIf( MediumBuy,  "M-Buy",WriteIf( WeakBuy,"W-Buy", 
									WriteIf( StrongSell,  "S-Sell",WriteIf( MediumSell,  "M-Sell",WriteIf( WeakSell,  "W-Sell","")))))), 5, 295);
GfxSetTextColor( colorBrown );
GfxTextOut("[9] [17] [26] [26] : " + WriteIf( StrongBuy1,"S-Buy", WriteIf( MediumBuy1,  "M-Buy",WriteIf( WeakBuy1,"W-Buy", 
									WriteIf( StrongSell1,  "S-Sell",WriteIf( MediumSell1,  "M-Sell",WriteIf( WeakSell1,  "W-Sell","")))))), 5, 310);
GfxSetTextColor( colorGreen );
GfxTextOut("Tang gia         10D Truoc = " +sntg+" Ngay", 5, 350);	
GfxSetTextColor( colorBrown );
GfxTextOut("Dong Cua Tot 10D Truoc = " +sndctot+" Ngay", 5, 365);

GfxSetTextColor( colorDarkGrey );
GfxTextOut("" +thongtinnen, 420, 22);
								
}

Title ="\n" +"\n"+"\n"+
/**************** Primary Filter ****************/
EncodeColor(colorBlue)+  "                                                                                                                                      Primary Filter  :"+
WriteIf(NR7xt,EncodeColor(colorOrange)+"  NR7","")+WriteIf(InOutInxt,EncodeColor(colorBlue)+"  InOutIn","")+WriteIf(new52WKxt,EncodeColor(colorCustom12)+"  New52WK","")+
WriteIf(BO20MAxt,EncodeColor(colorBlue)+"  Breakout-20MA","")+WriteIf(BO50MAxt,EncodeColor(colorOrange)+"  Breakout-50MA","")+WriteIf(BO200MAxt,EncodeColor(colorTeal)+"  Breakout-200MA","")+
WriteIf(BD20MAxt,EncodeColor(colorTan)+"  Breakdown-20MA","")+WriteIf(BD50MAxt,EncodeColor(colorCustom3)+"  Breakdown-50MA","")+WriteIf(BD200MAxt,EncodeColor(colorRed)+"  Breakdown-200MA","")+
WriteIf(VBOxt,EncodeColor(colorBlack)+"  Price Volume Breakout","")+WriteIf(DoubleDojixt,EncodeColor(colorRose)+"  Double Doji","")+
WriteIf(DoubleIBxt,EncodeColor(colorTan)+"  Double Inside Bar","")+WriteIf(Pin200MAxt,EncodeColor(colorDarkYellow)+"  Pinbar At 200MA","")+WriteIf(fakednxt,EncodeColor(colorRed)+"  Fakedown Pattern","")+
WriteIf(TopIBxt,EncodeColor(colorDarkOliveGreen)+"  Top Inside Bar","")
+"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +"\n" +
 EncodeColor(colorGreen)+ khangcu + EncodeColor(colorRed) + hotro +EncodeColor(ColorRGB(0,128,192))+ khangcuma + EncodeColor(ColorRGB(255,128,128)) + hotroma + EncodeColor(colorRed) + kcu+kcuma + EncodeColor(ColorRGB(0,128,192)) + htro+htroma+EncodeColor(colorBlue)+Buysellswingstatus+
 EncodeColor(colordarkGreen)+statusbrma20+tgkd+tenisstatus+volstatus+ badaydk1+badaydk2+buyCondstatus+strengthDownstatus+strengthDown1status+
 lowVolTest1status+noDemandBarstatus+lowVolTeststatus+trendChangestatus+lowVolTest2status+upThrustBarstatus;
 
 
 
 
 //////////////////
 //// CHI BAO VA THONG TIN HIEN THI BEN DUOI GOC PHAI CHART
{
//=======================================================================================
DTL=Param("Linear regression period",60,10,100,10); 
wbf=Param("WRB factor",1.5,1.3,2.5,.1);
nbf=Param("NRB factor",0.7,0.3,0.9,0.1);
TL=LinRegSlope(MA(C, DTL),2); 
 Vlp=Param("Volume lookback period",15,10,300,10);
Vrg=MA(V,Vlp);
St = StDev(Vrg,Vlp); 
Vp3 = Vrg + 3*st; 
Vp2 = Vrg + 2*st;;
Vp1 = Vrg + 1*st;;
Vn1 = Vrg -1*st; 
Vn2 = Vrg -2*st; 
rg=(H-L);
arg=Wilders(rg,30);
wrb=rg>(wbf*arg);
nrb=rg<(nbf*arg); 
Vl=V<Ref(V,-1) AND V<Ref(V,-2);
upbar=C>Ref(C,-1);
dnbar=C<Ref(C,-1); 
Vh=V>Ref(V,-1) AND Ref(V,-1)>Ref(V,-2);
Cloc=(C-L);
tt=(H-L)/(C-L);
x1=IIf(Cloc==0,arg,tt);
Vb=V>Vrg OR V>Ref(V,-1);
ucls=x1<2;
dcls=x1>2;
mcls=x1<2.2 AND x1>1.8 ;
Vlcls=x1>4;
Vhcls=x1<1.35;
j=MA(C,5);
TLL=LinRegSlope(j,40) ;
Tlm=LinRegSlope(j,15) ;
tls=LinRegSlope(j,5);
mp=(H+L)/2;
//==========================================================================================
utbar=wrb AND dcls AND tls>0 ;
utcond1=Ref(utbar,-1) AND dnbar ;
utcond2=Ref(utbar,-1) AND dnbar AND V>Ref(V,-1);
utcond3=utbar AND V> 2*Vrg;
trbar=Ref(V,-1)>Vrg  AND Ref(upbar,-1) AND Ref(wrb,-1) AND dnbar AND dcls AND wrb AND tll>0 AND H==HHV(H,10);
Hutbar=Ref(upbar,-1) AND Ref(V,-1)>1.5*Vrg AND dnbar AND dcls AND NOT wrb AND NOT utbar;
Hutcond=Ref(Hutbar,-1) AND dnbar AND dcls AND NOT utbar;
tcbar=Ref(upbar,-1) AND H==HHV(H,5)AND dnbar AND (dcls OR mcls) AND V>vrg AND NOT wrb AND NOT Hutbar ;
Scond1=(utcond1 OR utcond2 OR utcond3) ;
Scond2=Ref(scond1,-1)==0;
scond=scond1 AND scond2;
stdn0= tll<0 AND V>Ref(V,-1) AND Ref(dnbar,-1) AND upbar AND (ucls OR mcls) AND tls<0 AND tlm<0;
stdn= V>Ref(V,-1) AND Ref(dnbar,-1) AND upbar AND (ucls OR mcls) AND tls<0 AND tlm<0;
stdn1= tll<0 AND V>(vrg*1.5) AND Ref(dnbar,-1) AND upbar AND (ucls OR mcls)AND tls<0 AND tlm<0;
stdn2=tls<0 AND Ref(V,-1)<Vrg  AND upbar AND vhcls AND V>Vrg;
bycond1= stdn OR stdn1;
bycond= upbar  AND Ref(bycond1,-1);
stvol= L==LLV(L,5)  AND (ucls OR mcls) AND V>1.5*Vrg AND tll<0;
ndbar=upbar AND nrb AND Vl  AND dcls ;
nsbar=dnbar AND nrb AND Vl  AND dcls ;
nbbar= C>Ref(C,-1) AND Vl AND nrb AND x1<2;
nbbar= IIf(C>Ref(C,-1) AND V<Ref(V,-1) AND V<Ref(V,-2) AND x1<1.1,1,0);
lvtbar= vl AND L<Ref(L,-1) AND ucls;
lvtbar1= V<Vrg AND L<Ref(L,-1) AND ucls AND tll>0 AND tlm>0 AND wrb;
lvtbar2= Ref(Lvtbar,-1) AND upbar AND ucls;
dbar= V>2*Vrg AND dcls AND upbar AND tls>0 AND tlm>0 AND NOT Scond1 AND NOT utbar;
eftup=H>Ref(H,-1) AND L>Ref(L,-1) AND C>Ref(C,-1) AND C>=((H-L)*0.7+L) AND rg>arg AND V>Ref(V,-1);
eftupfl=Ref(eftup,-1) AND (utbar OR utcond1 OR utcond2 OR utcond3);
eftdn=H<Ref(H,-1) AND L<Ref(L,-1) AND C<Ref(C,-1) AND  C<=((H-L)*0.25+L) AND rg>arg AND V>Ref(V,-1);


//====================================================================================================
Vpc= utbar OR utcond1 OR utcond2 OR utcond3 OR stdn0 OR stdn1 OR stdn2 OR stdn OR lvtbar1 OR Lvtbar OR Lvtbar2 OR Hutbar OR Hutcond OR ndbar OR stvol OR tcbar;


///////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////Candle DES////////////////////////////////////////
////////////////////////////////////////Starts//////////////////////////////////////////



/*ndele
Copiare questo dile nell'area commenti "Formula" del "Guru Commentary" di Amibroker.
Le frecce Verdi piene indicano candele Bullish "rialziste" con elevata affidabilit.
Le frecce Verdi vuote indicano candele Bullish "rialziste" con moderata e bassa affidabilit.
Le frecce Rosse piene indicano candele Bearish "ribassiste" con elevata affidabilit.
Le frecce Rosse vuote indicano candele Bearish "ribassiste" con moderata e bassa affidabilit.
Spostare il cursore e cliccare sulla candela prescelta per avere il commento.
I commenti sono di Steve Nison "Japanese Candlestick Charting Techniques" e dal sito LitWick.
**********************************************************/

/*Colori candele*/
whiteBody=C>=O;
blackBody=O>C;

/*Ampiezza candele*/
smallBodyMaximum=0.0025;//meno di 0.25%
LargeBodyMinimum=0.01;//meno di 1.0%
smallBody=(O>=C*(1-smallBodyMaximum) AND whiteBody) 
         OR (C>=O*(1-smallBodyMaximum) AND blackBody);
largeBody=(C>=O*(1+largeBodyMinimum) AND whiteBody) 
         OR C<=O*(1-largeBodyMinimum) AND blackBody;
mediumBody=NOT LargeBody AND NOT smallBody;
identicalBodies=abs(abs(Ref(O,-1)-Ref(C,-1))-abs(O-C)) < 
          abs(O-C)*smallBodyMaximum;
realBodySize=abs(O-C);


/*Shadows*/
smallUpperShadow=(whiteBody AND H<=C*(1+smallBodyMaximum))
               OR (blackBody AND H<=O*(1+smallBodyMaximum));
smallLowerShadow=(whiteBody AND L>=O*(1-smallBodyMaximum)) 
               OR (blackBody AND L>=C*(1-smallBodyMaximum));
largeUpperShadow=(whiteBody AND H>=C*(1+largeBodyMinimum)) 
               OR (blackBody AND H>=O*(1+largeBodyMinimum));
largeLowerShadow=(whiteBody AND L<=O*(1-largeBodyMinimum)) 
              OR (blackBody AND L<=C*(1-largeBodyMinimum));

/*Gaps*/
upGap=  IIf(Ref(blackBody,-1)AND whiteBody AND O>Ref(O,-1),1,
        IIf(Ref(blackbody,-1) AND blackBody AND C>Ref(O,-1),1,
        IIf(Ref(whiteBody,-1) AND whiteBody AND O>Ref(C,-1),1,
        IIf(Ref(whiteBody,-1) AND blackBody AND C>Ref(C,-1),1,0))));

downGap=IIf(Ref(blackBody,-1)AND whiteBody AND C<Ref(C,-1),1,
        IIf(Ref(blackbody,-1) AND blackBody AND O<Ref(C,-1),1,
        IIf(Ref(whiteBody,-1) AND whiteBody AND C<Ref(O,-1),1,
        IIf(Ref(whiteBody,-1) AND blackBody AND O<Ref(O,-1),1,0))));


/*Definizione candele*/
spinningTop=mediumBody;
doji=CdDoji(threshold=0.05);/*abs(C-O) <= (C*smallBodyMaximum) OR
(abs(O-C)<=((H-L)*0.1));*/
dojiStar=doji AND (upgap OR downgap)AND Ref(LargeBody,-1);
marabuzu=LargeBody AND smallUpperShadow AND smallLowerShadow;

shootingStar=/*(NOT largeBody AND smallLowerShadow AND LargeUpperShadow) OR*/
    smallLowerShadow AND NOT doji AND
   ((blackBody AND abs(O-H)>2*realBodySize) OR
   (whiteBody AND abs(H-C)>2*realBodySize));

Hammer=smallUpperShadow AND NOT doji AND
   ((blackBody AND abs(C-L)>2*realBodySize) OR
   (whiteBody AND abs(L-O)>2*realBodySize));

tweezerTop=abs(H-Ref(H,-1))<=H*0.0025;
tweezerBottom=abs(L-Ref(L,-1))<=L*0.0025;
engulfing=
   IIf(blackBody AND Ref(blackbody,-1) AND C<Ref(C,-1) AND O>Ref(O,-1),1,
   IIf(blackBody AND Ref(whiteBody,-1) AND O>Ref(C,-1) AND C<Ref(O,-1),1,
   IIf(whitebody AND Ref(whitebody,-1) AND C>Ref(C,-1) AND O<Ref(O,-1),1,
   IIf(whiteBody AND Ref(blackBody,-1) AND C>Ref(O,-1)AND O<Ref(C,-1),1,0))));
Harami=
   IIf(blackbody AND Ref(blackBody,-1) AND O<Ref(O,-1) AND C>Ref(C,-1),1,
   IIf(blackBody AND Ref(whiteBody,-1) AND C>Ref(O,-1) AND O<Ref(C,-1),1,
   IIf(whiteBody AND Ref(whiteBody,-1) AND C<Ref(C,-1) AND O>Ref(O,-1),1,
   IIf(whiteBody AND Ref(blackBody,-1) AND O>Ref(C,-1) AND C<Ref(O,-1),1,0))));


/*Maximum High Today - (MHT)
Oggi  il massimo High negli ultimi 5 giorni*/
MHT=  HHV(H,5)==H;

/*Maximum High Yesterday - (MHY)
Ieri  il massimo High negli ultimi 5 giorni*/
MHY=   HHV(H,5)==Ref ( H, -1);

/*Minimum Low Today - (MLT)
Oggi  il minimo Low negli ultimi 5 giorni*/
MLT=   LLV(L,5)==L;

/*Minimum Low Yesterday - (MLY)
Ieri  il minimo Low negli ultimi 5 giorni*/
MLY=   LLV(L,5)==Ref(L,-1);

/*Definizioni DOJI */

/*Doji Today - (DT)*/
DT = abs(C-O) <= (C*smallBodyMaximum) OR
(abs(O-C)<=((H-L)*0.1));

/* Doji Yesterday - (DY)*/
DY = abs(Ref ( C, -1)-Ref(O,-1)) <= Ref ( C, -1) *smallBodyMaximum OR
abs (Ref ( O, -1)-Ref(C,-1)) <= (Ref ( H, -1 ) - Ref ( L, -1 ) )*0.1;

/**************************************************
             CANDELE BULLISH 
*************************************************** */

/* Abandoned Baby Bullish*/
abandonedBabybullish =Ref(largeBody,-2) AND Ref(blackBody,-2)//Large black candle
             AND Ref(GapDown(),-1)  
             AND whiteBody AND LargeBody AND GapUp();//Large white candle

/* Belt Hold*///Bad formula
beltHoldBullish = largeBody AND smallLowerShadow AND whiteBody AND MLT;


/*BreakAway Bullish*/
breakAwayBullish=Ref(Largebody,-4) AND Ref(blackBody,-4)
              AND Ref(blackBody,-3) AND Ref(O,-3)<Ref(C,-4)
              AND Ref(smallbody,-2) AND Ref(C,-2)<Ref(C,-3)
              AND Ref(C,-1)<Ref(C,-2)
              AND LargeBody AND whiteBody AND C>Ref(O, -3) 
              AND C<Ref(C,-4);

/*Concealing Baby Swallow only one trade */
ConcealingBabySwallow=Ref(marabuzu,-3) AND Ref(blackbody,-3) AND
                      Ref(MArabuzu,-2) AND Ref(blackBody,-2) AND
                      Ref(blackBody,-1) AND Ref(downGap,-1) AND 
                      Ref(H,-1)>Ref(C,-2)AND Ref(blackbody,-1)AND 
                      blackBody AND engulfing;

/*Doji Star Bullish*/
dojiStarBullish=(dojiStar AND (MLT OR MLY))OR 
   (doji AND (C<Ref(C,-1) OR O<Ref(C,-1))AND Ref(blackBody,-1)
    AND Ref(LargeBody,-1));

/*Engulfing Bullish*/   
engulfingBullish =
    engulfing AND largeBody AND whiteBody AND 
    (Ref(blackbody,-1) OR Ref(Doji,-1)) AND MLT;

/*Hammer Bullish*/
hammerBullish=Hammer AND (MLT OR MLY);

/*Dragonfly Doji Bullish*/
dragonflyDoji=smallBody AND LargeLowerShadow AND smallUpperShadow AND MLT;

/* Harami Bullish*/
haramiBullish = harami AND Ref (LargeBody,-1) AND Ref(blackBody,-1) AND
                NOT LargeBody AND whiteBody;

/*Harami Cross*/
HaramiCross=harami AND Ref(LargeBody,-1) AND Ref(blackBody,-1) AND doji; 
       
/* Homing Pigeon*/
homingPigeon =  Ref(largeBody,-1) AND Ref(blackBody,-1) AND
                H<= Ref ( O, -1 ) AND L>=Ref( C, -1) AND C<O AND MLY;

/*Inverted Hammer*/
invertedHammer=shootingStar AND (MLT OR MLY);

/* Meeting LinesBullish*/
meetingLinesbullish= Ref(LargeBody,-1) AND Ref(blackBody,-1) AND
                     LargeBody AND whiteBody AND
                     C>Ref(C,-1)*0.9975 AND C< Ref(C,-1)*1.0025;

/*Morning Doji Star*/
morningDojiStar= Ref(LargeBody,-2) AND Ref(blackBody,-2) AND
                 Ref(doji,-1) AND Ref(O,-1)<Ref(C,-2) AND
                 whiteBody AND C>Ref(C,-2) AND MLY;

/* Morning Star*/
morningStar =Ref(largeBody,-2) AND Ref(blackBody,-2)//Large black candle 
             AND Ref(downGap,-1)//Gap down yesterday
             AND whiteBody AND LargeBody AND C>Ref(C,-2)//Large white candle today
             AND MLY; //Yesterday was the low

/* Piercing Line*/
piercingLine= Ref(largeBody,-1) AND Ref(blackBody,-1)AND
               O<Ref(L,-1) AND C>=(Ref(O,-1)+Ref(C,-1))/2 AND C<Ref(O,-1) AND MLT;

/* Stick Sandwich*/
stickSandwich=Ref(largeBody,-2) AND Ref(blackbody,-2) AND 
              Ref(largeBody,-1) AND Ref(whiteBody,-1) AND
              Ref(O,-1)>=Ref(C,-2) AND O>=Ref(C,-1) AND
              abs(C-Ref(C,-2))<=C*0.0025;

/*Three Inside Up harami confirming*/
threeInsideUp =Ref(Haramibullish,-1) AND whiteBody AND 
    largeBody AND C>Ref(C,-1);


/* Three Outside Up Engulfing confirmation*/
threeOutsideUp =Ref(engulfingBullish,-1) AND whiteBody AND C>Ref(C,-1);

/* Three Stars in the South*///Rewrite???
threeStarsInTheSouth=
   Ref(LargeBody,-2) AND Ref(blackBody,-2) AND Ref(largelowerShadow,-2)
   AND Ref(blackBody,-1) AND Ref(largeLowerShadow,-1) AND 
   Ref(L,-1)>Ref(L,-2) AND blackBody AND smallUpperShadow AND
   smallLowerShadow AND L>Ref(L,-1) AND H<Ref(H,-1);

/* Tri-Star Bullish*/
triStarBullish=Ref(doji,-2) AND Ref(doji,-1) AND doji AND MLY AND
   Ref(downgap,-1) AND upGap;

/* Three River Bottom Bad formula*/
threeriverBottom=Ref(largeBody,-2) AND Ref(blackBody,-2) AND
                 Ref(blackbody,-1) AND Ref(Largelowershadow,-1) AND
                 Ref(O,-1)<Ref(O,-2) AND Ref(C,-1)>Ref(C,-2) AND
                 whiteBody AND C<Ref(C,-1) AND MLY;   
                  
/* Mat Hold Bullish*/
MAtHoldBullish=Ref(LargeBody,-4) AND Ref(whiteBody,-4)//1st day
   AND Ref(blackBody,-3) AND Ref(upGap,-3) AND NOT Ref(LargeBody,-3)
   AND NOT Ref(LargeBody,-2) AND Ref(C,-2)<Ref(C,-3) AND Ref (O,-2)<Ref(O,-3) AND 
   Ref(C,-2)>Ref(O,-4) AND NOT Ref(LargeBody,-1) AND Ref(C,-1)<Ref(C,-2)
   AND LargeBody AND whiteBody AND C>Ref(C,-4); 

/*RisingThreeMethods*/
risingThreeMethods=Ref(LargeBody,-4) AND Ref(whiteBody,-4) AND NOT
  Ref(LargeBody,-3) AND NOT Ref(LargeBody,-2)AND NOT Ref(LargeBody,-1) AND
  Ref(C,-3)<Ref(C,-4) AND Ref(C,-2)<Ref(C,-3) AND Ref(C,-1)<Ref(C,-2) AND
  LargeBody AND whitebody AND C>Ref(C,-4);

/* Seperating Lines Bullish*/
separatingLinesBullish=Ref(blackBody,-1) AND whiteBody AND LargeBody AND
smallLowerShadow AND MHT AND abs(O-Ref(O,-1))<=O*0.0025;

/*Side by Side White Lines*/
sideBySideWhiteLines=NOT Ref(smallBody,-2) AND Ref(whiteBody,-2) 
   AND Ref(upGap,-1) AND Ref(whitebody,-1)AND whiteBody AND
   identicalBodies AND abs(O-Ref(O,-1))<O*0.0025;


/*Three White Soldiers*/
threeWhiteSoldiers=NOT Ref(smallbody,-2) AND Ref(whiteBody,-2) AND NOT
   Ref(smallBody,-1) AND Ref(whiteBody,-1) AND NOT
   smallBody AND whiteBody AND C>Ref(C,-1) AND Ref(C,-1)>Ref(C,-2) AND
   Ref(O,-1)>Ref(O,-2) AND Ref(O,-1)<Ref(C,-2) AND O<Ref(C,-1) AND
   O>Ref(O,-1) AND Ref(smallUpperShadow,-2) AND
   Ref(smallUpperShadow,-1) AND smallUppershadow AND LLV(L,12)==Ref(L,-2);

/*Upside Gap Three Methods not very good*/
upsideGapThreeMethods=Ref(Largebody,-2) AND Ref(whiteBody,-2) AND
   Ref(LargeBody,-1) AND Ref(whiteBody,-1) AND Ref(upGap,-1) AND
   blackBody AND O>Ref(O,-1) AND C<Ref(C,-2)AND C>Ref(O,-2) AND 
  MHY;

/*Three Line Strike not good signals*/
threeLineStrike=NOT Ref(smallBody,-3) AND NOT Ref(smallBody,-2) AND 
   NOT Ref(smallBody,-1) AND Ref(whiteBody,-3) AND Ref(whiteBody,-2) AND
   Ref(whiteBody,-1) AND Ref(C,-1)>Ref(C,-2) AND Ref(C,-2)>Ref(C,-3) AND
   blackBody AND O>Ref(C,-1) AND C<Ref(O,-3);

/*Tweezer Bottom*/
tweezerBottom= (abs(L-Ref(L,-1))/L<0.0025 OR
               abs(L-Ref(L,-2))/L<0.0025)
               AND (MLT OR MLY); 

/*Upside Tasuki Gap*/
upsideTasukiGap=Ref(largeBody,-2) AND Ref(largeBody,1) AND
   Ref(whiteBody,-2) AND Ref(whiteBody,-1) AND Ref(upGap,-1) AND
   blackBody AND O>Ref(O,-1) AND C<Ref(O,-1) AND C>Ref(C,-2) AND
   identicalBodies AND O<Ref(C,-1);
   //AND HHV(H,5)==Ref(H,-1); Do not use this line


/*****************************************
            CANDELE BEARISH 
******************************************/

/*Abandoned Baby Bearish*/
AbandonedBabyBearish=Ref(LargeBody,-2) AND Ref(whiteBody,-2) AND
   Ref(smallBody,-1) AND Ref(GapUp(),-1) AND GapDown() AND 
   NOT smallBody AND blackBody AND MHY;

/*Advance Block Bearish*/
AdvanceBlockBearish=Ref(LargeBody,-2) AND Ref(whiteBody,-2) 
    AND Ref(whiteBody,-1) AND
   whiteBody AND Ref(O,-1)>Ref(O,-2) AND Ref(O,-1)<Ref(C,-2) AND
   Ref(C,-1)>Ref(C,-2) AND C>Ref(C,-1) AND
   O<Ref(C,-1) AND O>Ref(O,-1) AND Ref(LargeUpperShadow,-1) AND LargeUpperShadow
   AND C-O<Ref(C,-1)-Ref(O,-1) AND Ref(C,-1)-Ref(O,-1) < Ref(C,-2)-Ref(O,-2);

/*Belt Hold Bearish*/
beltHoldBearish=LargeBody AND BlackBody AND smalluppershadow AND MHT;

/*Breakaway Bearish*/
breakAwayBearish=Ref(LargeBody,-4) AND Ref(whiteBody,-4) AND
   Ref(GapUp(),-3) AND Ref(whiteBody,-3) AND 
   Ref(smallbody,-2) AND Ref(smallBody,-1) AND
   blackBody AND O>Ref(O,-3) AND C<Ref(C,-4);

/*Dark Cloud Cover*/
darkCloudCover=Ref(LargeBody,-1) AND Ref(whiteBody,-1) AND
   blackBody AND O>Ref(H,-1) AND C>Ref(O,-1) AND C<(Ref(O,-1)+Ref(C,-1))/2
   AND MHT;

/*Deliberation Bearish: needs confirmation*/
deliberationBearish=Ref(LargeBody,-2) AND Ref(whiteBody,-2) AND
   Ref(LargeBody,-1) AND Ref(whiteBody,-1) AND Ref(C,-1)>Ref(C,-2) AND
   smallbody AND upGap;

/*CounterAttackBearish*/
CounterAttackBearish=MHT AND LargeBody AND blackbody AND
   Ref(largeBody,-1) AND Ref(whiteBody,-1) AND
   C<Ref(C,-1)*1.0025 AND C>Ref(C,-1)*0.9975;;

/*Doji Star Bearish*/
dojiStarBearish=(dojiStar AND (MHT OR MHY))OR 
   (doji AND (C>Ref(C,-1) OR O>Ref(C,-1))AND Ref(whiteBody,-1)
    AND Ref(LargeBody,-1));

/*Engulfing Bearish*/
engulfingBearish=engulfing AND largeBody AND blackBody AND 
    (Ref(whitebody,-1) OR Ref(Doji,-1))AND (MHT OR MHY);

/*Evening Doji Star check formula???*/
eveningDojiStar=Ref(LargeBody,-2) AND Ref(whiteBody,-2) AND
   Ref(dojiStar,-1) AND Ref(GapUp(),-1) AND (MHY OR MHT);

/*Evening Star*/
eveningStar=Ref(LargeBody,-2) AND Ref(whiteBody,-2) AND
   Ref(upGap,-1) AND NOT Ref(largeBody,-1) AND blackBody AND NOT smallBody AND
   (MHT OR MHY);

/*Hammer Bearish*/
HammerBearish=Hammer AND HHV(H,8)==H;

/*hangingMan*/
HangingMan=NOT largeBody AND smallUpperShadow AND LargeLowerShadow AND MHT;

/*dragonfly Doji Bearish*/
dragonflyDojiBearish=doji AND smallUpperShadow AND LargeLowerShadow AND MHT;
   
/*Harami Bearish-*/
HaramiBearish=harami AND Ref(Largebody,-1) AND Ref(whiteBody,-1)AND blackBody 
AND (MHY OR MHT);

/*HaramiCross Bearish*/
HaramiCrossBearish=harami AND doji AND Ref(whiteBody,-1) AND Ref(Largebody,-1);

/*Identical three black crows*/
idendicalThreeBlackCrows=Ref(blackBody,-2) AND Ref(blackBody,-1) AND blackBody AND
   abs(Ref(C,-2)-Ref(O,-1))<Ref(C,-1)*0.0025 AND abs(Ref(C,-1)-O)<O*0.0025 AND
   HHV(H,20)==Ref(H,-2) AND NOT Ref(doji,-2) AND NOT Ref(doji,-1) AND NOT doji AND
   Ref(smallLowerShadow,-2) AND Ref(smallLowerShadow,-1) AND smallLowerShadow;

/*Kicking Bearish No trades*/
kickingBearish=Ref(whiteBody,-1) AND Ref(MArabuzu,-1) AND blackBody AND MArabuzu    AND GapDown();

/*Meeting Lines Bearish*/
MeetingLinesBearish=Ref(LargeBody,-1) AND Ref(whiteBody,-1) AND
  HHV(C,8)==Ref(C,-1) AND LargeBody AND blackBody AND 
  abs(C-Ref(C,-1))<C*0.0025;

/*ShootingStar*/
shootingStarGap=shootingStar AND GapUp() AND MHT;

/*Gravestone Doji*/
gravestoneDoji=doji AND largeUpperShadow AND smallLowerShadow AND GapUp()AND MHT;

/*Three Inside Down Bearish*/
threeInsideDownBearish=Ref(HaramiBearish,-1) AND blackBody AND C<Ref(C,-1)AND    smallUpperShadow;

/*Three Outside Down Bearish*/
threeoutsideDownBearish=Ref(engulfingBearish,-1) AND blackBody AND C<Ref(C,-1)AND
   NOT LargeUpperShadow;

/*Tri Star Bearish*/
triStarBearish=Ref(doji,-2) AND Ref(doji,-1) AND doji AND MHY AND Ref(upGap,-1)AND    downGap;

/*Two Crows Bearish*/
twoCrows=Ref(whiteBody,-2) AND Ref(LargeBody,-2) //first day
   AND Ref(blackBody,-1) AND Ref(upGap,-1)//Second Day
   AND blackBody AND O<Ref(O,-1) AND O>Ref(C,-1)AND C<Ref(C,-2) AND 
   C>Ref(O,-2) AND MHY;//Third day

/*Upside Gap Two Crows*/
upsideGapTwoCrows= Ref(whiteBody,-2) AND Ref(LargeBody,-2)// first day
   AND Ref(upGap,-1) AND Ref(blackBody,-1) // 2nd day
   AND blackbody AND O>Ref(O,-1) AND C<Ref(C,-1) AND C>Ref(C,-2);

/*Doji Star Bearish needs confirmation
dojiStarBearish=Ref(LargeBody,-1) AND Ref(whiteBody,-1) // first day
   AND doji AND upGap AND MHT;*/

/* Downside Gap Three Methods*/
downsideGapThreeMethods=
     Ref(LargeBody,-2) AND Ref(blackBody,-2) AND Ref(downGap,-2) //first day
     AND Ref(LargeBody,-1) AND Ref(blackBody,-1)//2nd day
     AND whitebody AND O<Ref(O,-1) AND C>Ref(C,-2)
     AND LLV(L,8)==Ref(L,-1);

/*Downside Tasuki Gap*/
downsideTasukiGap=
   Ref(blackBody,-2)//first day
   AND Ref(blackbody,-1) AND Ref(downgap,-1) //2nd day
   AND whiteBody AND O<Ref(O,-1) AND O>Ref(C,-1) AND C>Ref(O,-1) AND C<Ref(C,-2)
   AND Ref(identicalBodies,-1)                                                                                                                   
   AND LLV(L,15)==Ref(L,-1);


/*Falling Three Meothods*/
fallingThreeMethods=Ref(LargeBody,-4) AND Ref(blackBody,-4) AND
  /*Ref(doji,-3) AND Ref(doji,-2) AND Ref(doji,-1) AND*/ Ref(C,-1)>Ref(C,-2) 
  AND Ref(C,-2)>Ref(C,-3) AND LargeBody AND blackBody AND O>Ref(C,-4) AND
  O<Ref(O,-4) AND C<Ref(O,-4)AND C<Ref(C,-4);

/*In Neck Bearish not good*/
inNeckBearish=Ref(LargeBody,-1) AND Ref(blackBody,-1) AND
   whiteBody AND O<Ref(L,-1) AND C<Ref(C,-1)*1.0005 AND C>=Ref(C,-1);

/*On Neck Bearish not good*/
OnNeckBearish=Ref(LargeBody,-1) AND Ref(blackBody,-1) AND
   whiteBody AND O<Ref(L,-1) AND C<Ref(L,-1)*1.0025 AND C>=Ref(L,-1)*0.9975;

/*separating Lines Bearish*/
separatingLinesBearish=Ref(LargeBody,-1) AND Ref(whiteBody,-1) AND
   blackBody AND O>Ref(O,-1)*0.9975 AND O<=Ref(O,-1)*1.0025;

/*Side By Side White Lines Bearish*/
sideBySideWhiteLinesBearish=NOT Ref(smallBody,-2) AND Ref(blackBody,-2) AND  
   Ref(whiteBody,-1) AND whiteBody AND Ref(downGap,-1) AND identicalBodies
  AND abs(C-Ref(C,-1)<C*0.0025);

/*Three Black Crows*/
threeBlackCrows=Ref(blackBody,-2) AND Ref(blackBody,-1) AND blackBody  AND Ref(C,-1)<Ref(C,-2) AND C<Ref(C,-1) AND HHV(H,8)==Ref(H,-2) AND NOT Ref(doji,-2) AND NOT Ref(doji,-1) AND NOT doji;;
   
/*Three Line Strike no trades*/
threeLineStrike=threeBlackCrows AND whiteBody AND O<Ref(C,-1) AND C>Ref(O,-3);

/*Thrusting Bearish*/
thrustingBearish=Ref(blackBody,-1) AND Ref(LargeBody,-1) AND LargeBody AND
   whitebody AND O<Ref(L,-1) AND C<(Ref(O,-1)+Ref(C,-1))/2 AND C>Ref(C,-1);

/*Tweezer Top*/
tweezerTop= (abs(H-Ref(H,-1))/H<0.0025 OR
               abs(H-Ref(H,-2))/H<0.0025)
               AND (MHT OR MHY); 
////////////////
Buynen=
abandonedBabybullish OR
ConcealingBabySwallow OR 
morningDojiStar OR
morningStar OR
threeInsideUp OR
threeOutsideUp OR
MAtHoldBullish OR
risingThreeMethods OR
sideBySideWhiteLines OR
threeWhiteSoldiers;
/////////////
Covernen=
beltHoldBullish OR
breakAwayBullish OR
dojiStarBullish OR
engulfingBullish OR
hammerBullish OR
dragonflyDoji OR
haramiBullish OR
HaramiCross OR
homingPigeon OR
invertedHammer OR
meetingLinesbullish OR
piercingLine OR
stickSandwich OR
threeStarsInTheSouth OR   
triStarBullish OR
threeriverBottom OR
separatingLinesBullish OR
upsideGapThreeMethods OR
threeLineStrike OR
tweezerBottom OR
upsideTasukiGap;
//////////////
Shortnen=
advanceBlockBearish OR
beltHoldBearish OR
breakAwayBearish OR
HangingMan OR
deliberationBearish OR
CounterAttackBearish OR
engulfingBearish OR
HammerBearish OR
dragonflyDojiBearish OR
HaramiBearish OR
HaramiCrossBearish OR
MeetingLinesBearish OR
shootingStarGap OR
gravestoneDoji OR
triStarBearish OR
twoCrows OR
dojiStarBearish OR
downsideGapThreeMethods OR
downsideTasukiGap OR
inNeckBearish OR
OnNeckBearish OR
separatingLinesBearish OR
sideBySideWhiteLinesBearish OR
threeLineStrike OR
thrustingBearish OR
tweezerTop;
////////////////////////////
Sellnen=
AbandonedBabyBearish OR
darkCloudCover OR
eveningDojiStar OR
eveningStar OR
idendicalThreeBlackCrows OR
kickingBearish OR
threeInsideDownBearish OR
threeoutsideDownBearish OR
upsideGapTwoCrows OR
fallingThreeMethods OR
threeBlackCrows;
}
nenbuysell= WriteIf(Buynen,"| Buy",WriteIf(Covernen,"| Cover",WriteIf(Shortnen,"| Short",WriteIf(Sellnen,"Sell",""))));
 GfxSetOverlayMode(0);
GfxSelectFont("Arial",9, 500);
GfxSetBkMode(0); // transparent
GfxSetTextColor( colorBlack );
GfxTextOut("" + nenbuysell, 210, 501);
 
 Title =Title
 +"\n"
/////////////////////////////////////////// CHI BAO HIEN THI BEN DUOI GOC TRAI CHART
+WriteIf(Vpc,"","")
+EncodeColor(ColorRGB(255,40,40))+WriteIf(utbar , "                                                                 - Up-thrust bar duoc thiet ke de bat cac diem dung va danh lua cang nhieu nha giao dich cang tot. Chung thuong duoc nhin thay sau khi co diem yeu trong nen.\n                                                                  Cac nha tao lap thi truong biet rang thi truong dang yeu, vi vay gia duoc danh dau de bat cac diem dung, khuyen khich cac nha giao dich mua dai han\n                                                                  trong mot moi truong yeu va cac nha giao dich hoang so da ban kho^ng' de che day vi the tot cua ho. \n","")/////Up-thrusts are designed to catch stops and to mislead as many traders as possible.They are normally seen after there has been weakness in the background.\nThe market makers know that the market is weak, so the price is marked up to catch stops, encourage traders to go long in a weak market, and panic traders \n that are already Short into covering their very good position.
+EncodeColor(ColorRGB(255,40,40))+WriteIf(utcond3,"                                                                 - upthrust bar nay tai vi tri khoi luong lon, day dam bao la tin hieu yeu. Dieu nay co the xem xet viec ket thuc cua chu ky dai va san sang dao nguoc. \n","")//This upthrust bar is at high volume.This is a sure sign of weakness. One may even seriously consider ending the Longs AND be ready to reverse
+EncodeColor(ColorRGB(255,40,40))+WriteIf(utbar OR utcond3,"                                                                 - Luu y rang 1 thanh giam gia voi su chenh lech giua gia mua va ban rong xuat hien ngay sau bat ky up-thrust, co xu huong xac nhan diem yeu \n                                                                 ( nha tao lap thi truong dang khoa cac nha giao dich vao cac vi the thua). Voi su xuat hien cua mot luc day, ban nen chac chan chu y den giao dich va diem dung cua ban.\n                                                                  Tren nhieu luc tang ban se thay rang thi truong dang test gan nhu ngay lap tuc. \n","")//Also note that A wide spread down-bar that appears immediately after any up-thrust, tends to confirm\n the weakness (the market makers are locking in traders into poor positions). With the appearance of an upthrust you should certainly be paying attention to your trade \nAND your stops. On many upthrusts you will find that the market will 'test' almost immediately.
+EncodeColor(ColorRGB(255,40,40))+WriteIf(utcond1 , "                                                                 - Mot nen giam gia voi su chenh lech rong ngay sau Upthrust Bar xac nhan 1 tin hieu yeu. Dong tien thong minh dang khoa cac nha giao dich vao vi the thua.\n","")///A wide spread down bar following a Upthrust Bar. This confirms weakness. The Smart Money is locking in Traders into poor positions
+EncodeColor(ColorRGB(255,40,40))+WriteIf(utcond2 , "                                                                 - Tai khoi luong cao ( cao hon trung binh) cung the.Dong tien thong minh dang khoa cac nha giao dich vao vi the thua.\n ","")//Also here the volume is high( Above Average).This is a sure sign of weakness. The Smart Money is locking in Traders into poor positions
+EncodeColor(colorDarkGreen)+WriteIf(stdn, "                                                                 - Strength Bar. Co phieu da co xu huong giam. Nen tang voi khoi luong lon dong cua gan muc cao la tin hieu cua suc manh dang tro lai. Xu huong giam co kha nang som dao chieu. \n","")//Strength Bar. The stock has been in a down Trend. An upbar with higher Volume closing near the High is a sign of strength returning.\nThe downtrend is likely to reverse soon.
+EncodeColor(colorDarkGreen)+WriteIf(stdn1,"                                                                 - Khoi luong tai day cao hom trung binh. Dieu nay lam cho chi bao nay manh hon. \n","")//Here the volume is very much above average. This makes this indication more stronger.
+EncodeColor(colorDarkGreen)+WriteIf(bycond,"                                                                 - Nen truoc do da chung kien suc manh tro lai. Thanh nay khang dinh suc manh. \n","")//The previous bar saw strength coming back. This upbar confirms strength.
+EncodeColor(ColorRGB(255,40,40))+WriteIf(Hutbar,"                                                                 - Mot luc day gia?. Dieu nay thuong xuat hien sau 1 nen tang co khoi luong tren trung binh. Dieu nay giong nhu nen day dong cua duoi muc thap nhat nhung khoi luong thuong thap hon muc trung binh.\n                                                                  Day la 1 tin hieu yeu neu khoi luong cao thi diem yeu se tang len. Dong tien thong minh dang khoa cac nha giao dich vao vi the kem. \n","")//A pseudo Upthrust. This normally appears after an Up Bar with above average volume. This looks like an upthrust bar closing down near the Low. \nBut the Volume is normally Lower than average. this is a sign of weakness.If the Volume is High then weakness increases. \nSmart Money is trying to trap the retailers into bad position.
+EncodeColor(ColorRGB(255,40,40))+WriteIf(Hutcond, "                                                                 - Mot nen giam sau 1 nen tang gia? xac nhan yeu. Neu khoi luong tren trung binh thi tin hieu yeu tang len. \n","")//A downbar after a pseudo Upthrust Confirms weakness. \nIf the volume is above average the weakness is increased.
+EncodeColor(colorDarkGreen)+WriteIf(Lvtbar2,"                                                                 - Nen truoc do da test thanh cong luc cung. Nen hien tai la nen tang co khoi luong cao. Khang dinh suc manh. \n","")//The previous bar was a successful Test of supply.\n The current bar is a upbar with higher volume. \nThis confirms strength
+EncodeColor(colorCustom12)+WriteIf(dbar,"                                                                 - Mot thanh nen co bien do rong va khoi luong cao trong xu huong tang dang dong cua phia duoi la mot tin hieu phan phoi dang duoc tien hanh.\n                                                                  Dong tien thong minh dang ban co phieu cho nhung trader den muon do xo vao mua co phieu khong de bi bo roi boi mot dong thai tang. \n","")//A wide range, high volume bar in a up trend closing \ndown is an indication the Distribution is in progress. \nThe smart money is Selling the stock to the late Comers rushing \nto Buy the stock NOT to be Left Out Of a \nBullish move.
+EncodeColor(colorDarkGreen)+WriteIf(Lvtbar1, "                                                                 - Kiem tra nguon cung trong uptrend. tin hieu manh. \n","")//Test for supply in a uptrend. Sign of Strength.
+EncodeColor(ColorRGB(255,40,40))+WriteIf(tcbar,"                                                                 - Co phieu da tang len voi khoi luong lon. Nen hien tai la 1 nen giam voi khoi luong lon. chi bao yeu va co the ket thuc qua trinh di len.\n","")//The stock has been moving up on high volume. \nThe current bar is a Downbar with high volume. \nIndicates weakness and probably end of the up move
+EncodeColor(colorDarkGreen)+WriteIf(eftup,"                                                                 - No luc de tang gia. Dieu nay thuong duoc tim thay o dau giai doan la danh dau day la dau hieu tang gia.\n                                                                 Dieu nay co the duoc tim thay o dau dot tang nhu la dong tien thong minh no luc sau cung de di chuyen gia len muc toi da.\n","")//Effort to Rise bar. This normally found in the beginning of a Markup Phase and is bullish sign.\nThese may be found at the top of an Upmove as the Smart money makes a last effort to move the price to the maximum
+EncodeColor(ColorRGB(255,40,40))+WriteIf(eftdn,"                                                                 - No luc that bai. Dieu nay thuong thay trong giai doan bat dau giam.\n","")//Effort to Fall bar. This normally found in \nthe beginning of a Markdown phase.
+EncodeColor(colorDarkGreen)+WriteIf(nsbar,"                                                                 - Thanh nen Khong co nguon cung cho biet nguon cung da bi loai bo va dong tien thong minh co the dinh gia. Tot hon het la nen doi xac nhan.\n","")//No Supply. A no supply bar indicates supply \nhas been removed and the Smart money can markup the price. \nIt is better to wait for confirmation
+EncodeColor(colorCustom12)+WriteIf(stvol,"                                                                 - Stopping Volume. Day se la nen giam trong chu ky giam dong cua tai dinh voi khoi luong cao.Stopping Volume thong thuong cho chung ta thay\n                                                                  tien thong minh dang hap thu nguon cung, do la tin hieu cho thay thi truong tang gia. Do do chung ta co the mong doi 1 su dao chieu trong xu huong giam. \n","")//Stopping Volume. This will be an downbar \nduring a bearish period closing towards the Top accompanied \nby High volume. A stopping Volume normally \nindicates that smart money is absorbing the supply which is a Indication that they are Bullishon the MArket. Hence we Can expect a reversal in the down trend.
+EncodeColor(ColorRGB(255,40,40))+WriteIf(ndbar, "                                                                 - Nen khong co nguon cau. Bat ky 1 nen tang nao dong cua o muc trung binh hoac thap, dac biet la neu khoi luong giam xuong la dau hieu tiem an cua 1 su suy yeu.\n                                                                  Chu y: neu thi truong van manh, thong thuong ban se thay tin hieu cua suc manh trong 1 vai thanh tiep theo; hau het se hien thi duoi dang thanh di xuong voi muc chenh lech hep,\n                                                                  dong cua o giua hoac cao. * Nen giam tren khoi luong giam.\n","")//No Demand Brief \nDescription: Any up bar which closes in the middle OR Low, \nespecially if the Volume has fallen off, \nis a potential sign of weakness.\nThings to Look Out for:if the market is still strong, \nyou will normally see signs of strength in the next\n few bars, which will most probably show itself as a:\n * Down bar with a narrow spread, closing in the middle OR High. \n* Down bar on Low Volume.
+EncodeColor(ColorRGB(255,40,40))+WriteIf (eftupfl, "                                                                 - No luc day gia len da that bai, tin hieu giam gia. \n","")//Effort to Move up has failed. Bearish sign
+WriteIf (stvol, "                                                                 - Stopping volume. Thong thuong cho thay su ket thuc cua mot xu huong giam dang den gan. \n","")//Stopping volume. Normally indicates end of bearishness is nearing.
+EncodeColor(ColorRGB(255,40,40))+WriteIf (utcond2 AND NOT utcond1, "                                                                 - Nen giam voi khoi luong cao sau khi tang. Xac nhan yeu. \n","")//A High Volume downbar after an Upthrust. Confirm weakness.
+EncodeColor(colorDarkGreen)+WriteIf (stdn0 AND NOT stdn, "                                                                 - Suc manh tro lai sau xu huong giam. \n","")//Strength seen returning after a down trend.
+EncodeColor(colorDarkGreen)+WriteIf (stdn AND NOT stdn1, "                                                                 - Suc manh tro lai sau xu huong giam dai.\n","")//Strength seen returning after a long down trend.
+EncodeColor(colorDarkGreen)+WriteIf (Lvtbar, "                                                                 - Test for supply. \n","")
+EncodeColor(colorDarkGreen)+WriteIf (stdn2, "                                                                 - Nen tang voi khoi luong lon, dong cua o muc cao cho thay suc manh \n ","")//High volume upbar closing on the high indicates strength.

+/**************************************************
Standards of Cover (Moderate and low Reliability)
/***************************************************/
EncodeColor(colorOrange)+
WriteIf(beltHoldBullish,"                                                                 (+) Belt Hold Bullish. Mo hinh dao chieu. Nen cang rong thi cang co y nghia. Do tin cay : Thap \n","")//  Belt Hold Bullish. Pattern reversal.\nThe wider the candle, the more significant.\nReliability second LitWick: Low.
+WriteIf(breakAwayBullish,"                                                                 (+) breakvar Away Bullish. Mo hinh dao chieu.Do tin cay :Vua phai \n","") //breakvar Away Bullish. Pattern reversal.\nReliability second LitWick: Moderate 
+WriteIf(dojiStarBullish,"                                                                 (+) Bullish doji Star. Mo hinh dao chieu. Yeu cau xac nhan. tin hieu tot nhat tai dinh. Do tin cay:Vua phai \n","")//Bullish doji Star. Pattern reversal.\nNison: Requires confirmation. Best sign on top.\nReliability second LitWick: Moderate
+WriteIf(hammerBullish,"                                                                 (+) Bullish Hammer. Mo hinh dao chieu. Duoi duoi cang dai, ngan hon phan duoi tren va than nen cang nho thi mo hinh cang co y nghia. Nen trang tang gia nhieu hon so voi than nen den. \n","") //Bullish Hammer. Pattern reversal.\nNison: The longer the tail lower (shadow), is shorter than the upper tail AND smaller the body of the candle, the more significant the pattern. The candles are white rialziste more than the black body with candles. \\ NReliability Second LitWick: Low.
+WriteIf(dragonflyDoji,"                                                                 (+) Dragonfly Doji. Do tin cay :Vua phai \n","") //Dragonfly Doji. Reliability second LitWick: Moderate
+WriteIf(haramiBullish, "                                                                 (+) Harami Bullish. Mo hinh dao chieu. khong co y nghia. mo hinh yeu cau xac nhan.Do tin cay :Thap. \n","") //Harami Bullish. Pattern reversal.\nNison: Insignificant. The pattern requires confirmation. \\ NReliability second LitWick: Low.
+WriteIf(HaramiCross,"                                                                 (+) Harami Cross. Mo hinh dao chieu. Chi bao Harami tot.Do tin cay :Thap \n","") //Harami Cross. Pattern reversal.\nNison: Best indicator Harami. Best on the maximum signal that the minimum. \\ NReliability second LitWick: Low.
+WriteIf(homingPigeon,"                                                                 (+) Homing Pigeon. Mo hinh dao chieu.Do tin cay :vua phai. \n","") //Homing Pigeon. Pattern reversal.\nReliability second LitWick: Moderate 
+WriteIf(invertedHammer,"                                                                 (+) Inverted Hammer. Mo hinh dao chieu. Yeu cau xac nhan tang gia.Do tin cay :Thap \n","") //Inverted Hammer. Pattern reversal.\nNison: Requires confirmation bullish.\nReliability second LitWick: Low.
+WriteIf(meetingLinesbullish,"                                                                 (+) Meeting Lines bullish.Mo hinh dao chieu.Do tin cay :vua phai \n","") //Meeting Lines bullish. Pattern reversal.\nReliability second LitWick: Moderate
+WriteIf(piercingLine,"                                                                 (+) Piercing Line.Mo hinh dao chieu.Mot mo hinh dao nguoc manh. Do tin cay :vua phai. \n","") //Piercing Line. Pattern reversal.\nNison: a pattern of strong inversion.\nReliability second LitWick: Moderate
+WriteIf(stickSandwich,"                                                                 (+) Stick Sandwich.Mo hinh dao chieu.Do tin cay :vua phai \n","") //Stick Sandwich. Pattern reversal.\nReliability second LitWick: Moderate
+WriteIf(threeStarsInTheSouth,"                                                                 (+) 3 Stars in the South. Mo hinh dao chieu.Do tin cay :vua phai \n","") //3 Stars in the South. Pattern reversal.\nReliability second LitWick: Moderate
+WriteIf(triStarBullish,"                                                                 (+) Tri-Star Bullish. Mo hinh dao chieu dang ke. Do tin cay :vua phai. \n","") //Tri-Star Bullish. Pattern reversal.\nNison: Patterns of significant reversal.\nReliability second LitWick: Moderate
+WriteIf(threeriverBottom,"                                                                 (+) 3 River Bottom.Mo hinh dao chieu. Ap luc ban dang giam dan. Do tin cay :vua phai. \n","") //3 River Bottom. Pattern reversal.\nNison: The selling pressure is decreasing.\nReliability Second LitWick: Moderate
+WriteIf(separatingLinesBullish,"                                                                 (+) Separating Lines Bullish. Tiep tuc xu huong. Do tin cay :Thap \n","") //Separating Lines Bullish. Pattern continued.\nReliability second LitWick: Low.
+WriteIf(upsideGapThreeMethods,"                                                                 (+) Upside Gap 3 Methods. Tiep tuc xu huong. Do tin cay :vua phai. \n","") //Upside Gap 3 Methods. Pattern continued.\nReliability second LitWick: Moderate
+WriteIf(threeLineStrike,"                                                                 (+) 3 Line Strike.Tiep tuc xu huong. Do tin cay :Thap \n","") //3 Line Strike. Pattern continued.\nReliability second LitWick: Low.
+WriteIf(tweezerBottom,"                                                                 (+) Tweezer Bottom. Mo hinh dao chieu. Cung voi su dao chieu cua cac nen khac co the cho chung ta biet muc do ho tro. Yeu cau xac nhan. \n","") //Tweezer Bottom. Pattern reversal. Together with other candles reversal may indicate a level of support.\nNison: Requires confirmation.
+WriteIf(upsideTasukiGap,"                                                                 (+)  Upside Tasuki Gap. Tiep tuc xu huong. Than cua 2 ngon nen trong khoang trong phai co do lon tuong tu nhau.Do tin cay :vua phai.\n","") //Upside Tasuki Gap. Pattern continued.\nNison: the bodies of two candles in the gap should be of similar magnitude.\nReliability second LitWick: Moderate 
+
/**************************************
              Commenti
***************************************
            Candles bullish - Bullish 
****************************************/
EncodeColor(colorGreen)+
WriteIf(abandonedBabybullish,"                                                                 (+) Abandoned Baby Bullish. Mo hinh dao chieu. Do tin cay :Cao \n","") //Abandoned Baby Bullish. Pattern reversal.\nReliability second LitWick: high.
+WriteIf(ConcealingBabySwallow,"                                                                 (+) Concealing Baby Swallow. Mo hinh dao chieu. Do tin cay :Cao \n","") //Concealing Baby Swallow. Pattern reversal.\nReliability second LitWick: high.
+WriteIf(engulfingBullish,"                                                                 (+) Bullish Engulfing. Mo hinh dao chieu. Cac yeu to lam tang tac dong cua mo hinh la:\n                                                                  1)Cay nen truoc do co than nho va co than rong vao ngay sau. \n                                                                 2)Mo hinh xuat hien sau khi di chuyen rat nhanh hoac keo dai.\n                                                                  3)Khoi luong cao vao ngay thu 2.\n                                                                 4)Ngay thu 2 bao phu (Engulfs) nen nhieu hon.\n                                                                  Do tin cay :Vua phai \n","") //Bullish Engulfing. Pattern reversal.\nNison: The factors that increase the effect of the pattern are\n 1) The first day (before) the candle has a small body on the second day and has a wide body.\n 2) The pattern appears after a move very fast or very protracted. \n 3) High Volume on the second day (current).\n 4)The days seconfo covers (Engulfs) more of a candle.\n Reliability second LitWick: Moderate
+WriteIf(morningDojiStar,"                                                                 (+) Morning Doji Star. Mo hinh dao chieu. Tin hieu dao chieu quan trong. Do tin cay :Cao \n","") //Morning Doji Star. Pattern reversal.\nImportant sign of reversal.\nReliability second LitWick: high.
+WriteIf(morningStar,"                                                                 (+) Morning Star. Mo hinh dao chieu. Tot hon khi kich thuoc cua nen trang tang ( thu 3). Do tin cay :Cao \n","") //Morning Star. Pattern reversal.\nNison: 	Better according to increase the size of the white candle (third).\nReliability Second LitWick: high.
+WriteIf(threeInsideUp,"                                                                 (+) 3 Inside Up. Mo hinh dao chieu. Do tin cay :Cao \n","") //3 Inside Up. Pattern reversal.\nReliability second LitWick: high.
+WriteIf(threeOutsideUp,"                                                                 (+) 3 Outside Up. Mo hinh dao chieu. Do tin cay :Cao \n","") //3 Outside Up. Pattern reversal.\nReliability second LitWick: High. 
+WriteIf(MAtHoldBullish,"                                                                 (+) Mat Hold Bullish. Tiep tuc xu huong.2-4 co the co nen den. Do tin cay :Cao \n","") //Mat Hold Bullish. Pattern continued.\nNison: 2-4 may have black candles.\nReliability Second LitWick: High.
+WriteIf(risingThreeMethods,"                                                                 (+) Rising Three Methods. Tiep tuc xu huong. Co y nghia lon hon neu khoi luong cua nen trang lon hon khoi luong cua nen den. Do tin cay :Cao. \n","") //Rising Three Methods. Pattern continued.>\nNison: Ha maggior significato se il volume delle candele bianche  maggiore rispetto a quello delle candele nere.\nReliability second LitWick: High.
+WriteIf(sideBySideWhiteLines,"                                                                 (+) Side by Side White Lines. Tiep tuc xu huong. Neu trong su huong giam co the xay ra trong ngan han. Do tin cay :Cao \n","") //Side by Side White Lines. Pattern continued.\nNison: if in a downtrend may be caused by ricoperture be Short.\nReliability Second LitWick: High.
+WriteIf(threeWhiteSoldiers,"                                                                 (+) 3 White Soldiers. Tiep tuc xu huong. Tich cuc, nhung hay chu y den mo hinh xau cua su be tac va mo hinh tiep theo bi tro ngai. Do tin cay :Cao \n","") + //3 White Soldiers. Pattern continued.\nNison: Positive, but pay attention to such negative pattern of stalemate and subsequent pattern of the block.\nReliability second LitWick: High.
/***************************************
                 Candle Down - Bearish 
********************************************/
EncodeColor(ColorRGB(255,40,40))+
WriteIf(AbandonedBabyBearish,"                                                                 (-) Abandoned Baby Bearish. Mo hinh dao chieu. Cuc ky hiem. Do tin cay :Cao. \n","") +//Abandoned Baby Bearish. Pattern reversal.\nNison: Extremely rare.\nReliability second LitWick: High.
WriteIf(advanceBlockBearish,"                                                                 (-) Advancing Block Bearish. Mo hinh dao chieu. Mot dau hieu cua su suy yeu co the la su giam dan cua than nen trang hoac su hien dien tuong doi cao hon,\n                                                                  sep hang dai tren hai ngon nen trang cuoi cung. Khong nhat thiet phai la mo hinh dao nguoc. Do tin cay :Vua phai. \n","") + //Advancing Block Bearish. Pattern reversal.\nNison: Rally has problems. A sign of weakness could be a gradual decrease in the bodies of white candles OR the presence of relatively higher long queues on the last two white candles. NOT necessarily a reversal pattern.\nReliability Second LitWick: Moderate
WriteIf(darkCloudCover,"                                                                 (-) Dark Cloud Cover. Mo hinh dao chieu. Cac yeu to cho thay tam quan trong cua tin hieu nay la:\n                                                                 1)Su xam nhap cua ngon nen dau tien trong ngon nen thu 2.\n                                                                 2)Neu ca 2 nen deu la marabozu.\n                                                                 3)Than cua cay nen thu 2 o muc khang cu dang ke.\n                                                                 4)Khoi luong cao trong ngay thu 2.\n                                                                  Do tin cay :Cao. \n","") + //Dark Cloud Cover. Pattern reversal.\nNison: Factors that indicate the importance of this signal is: \\ n 1) Magggior penetration of the first candle in the second. \\ n 2) If both candles are marabozu. \\ n 3) The body of the second candle on a significant level of resistance. \n 4) High-volume days in socondo.\nReliability second LitWick: High.
WriteIf(eveningDojiStar,"                                                                 (-) vening Doji Star. Mo hinh dao chieu.Phai duoc xac nhan boi 1 nen den dai. Do tin cay :Cao. \n","") + //Evening Doji Star. Pattern reversal.\nNison: must be confirmed by a long black candle.\nReliability second LitWick: High
WriteIf(eveningStar,"                                                                 (-) Evening Star. Mo hinh dao chieu. Khoang cach giua than nen thu 2 va thu 3 khong phai luc nao cung xuat hien. Do tin cay :Cao. \n","") + //Evening Star. Pattern reversal.\nNison: the gap between the second and third candle body is not always present.\nReliability second LitWick: High.
WriteIf(HammerBearish,"                                                                 (-) Bearish Hammer. Mo hinh dao chieu. Giam nhieu hon neu co bua mau den. can xac nhan giam gia. 1 gap down dang ke vao ngay hom sau se duoc xac nhan. \n","") + //Bearish Hammer. Pattern reversal.\nNison: more bearish if the hammer is black. E 'bearish confirmation needed. A significant gap down the next day will be confirmed.
WriteIf(dragonflyDojiBearish,"                                                                 (-) Dragonfly Bearish. Mo hinh dao chieu.Nhu hanging Man. Do tin cay :Vua phai. \n","") + //Dragonfly Bearish. Pattern reversal.\nNison: as in 'Hanging Man'.\nReliability Second LitWick: Moderate
WriteIf(HaramiBearish,"                                                                 (-) Harami Bearish. Mo hinh dao chieu.Khong co y nghia nhu hanging man and engulfing. Do tin cay :Thap. \n","") + //Harami Bearish. Pattern reversal.\nNison: not as significant as' hanging man 'and' engulfing '.\nReliability second LitWick: Low.
WriteIf(idendicalThreeBlackCrows,"                                                                 (-) Identical 3 Black Crows.Mo hinh dao chieu tang. Do tin cay :Cao. \n","") +//Identical 3 Black Crows. Pattern di inversione in uptrend.\nNison: very bearish.\nReliability Second LitWick: High.
WriteIf(kickingBearish,"                                                                 (-) Kicking Bearish. Mo hinh dao chieu.Do tin cay :Cao \n","") + //Kicking Bearish. Pattern reversal.\nReliability second LitWick: High.
WriteIf(threeInsideDownBearish,"                                                                 (-) 3 Inside Down. Mo hinh dao chieu.Do tin cay :Cao. \n","") + //3 Inside Down. Pattern reversal.\nReliability second LitWick: High.
WriteIf(threeoutsideDownBearish,"                                                                 (-) 3 Outside Down. Mo hinh dao chieu.Do tin cay :Cao \n","") + //3 Outside Down. Pattern reversal.\nReliability second LitWick: High.
WriteIf(upsideGapTwoCrows,"                                                                 (-) Upside Gap 2 Crows. Mo hinh dao chieu. Yeu cau xac nhan voi su dao nguoc vao ngay thu 3. Do tin cay :Cao. \n","") + //Upside Gap 2 Crows. Pattern reversal.\nNison: requires confirmation with inversion continued on the third day.\nReliability second LitWick: High.
WriteIf(fallingThreeMethods,"                                                                 (-) Falling 3 Methods.Tiep tuc xu huong. Do tin cay :Cao. \n","") + //Falling 3 Methods. Pattern continued.\nReliability second LitWick: High.
WriteIf(threeBlackCrows,"                                                                 (-) 3 Black Crows. Mo hinh dao chieu.Do tin cay :Cao. \n","") + //3 Black Crows. Pattern reversal.\nNison: should look after a rise 'mature'.\nReliability Second LitWick: High.
/***********************************************
               Short sell
**************************************************/
EncodeColor(colorCustom12)+
WriteIf(beltHoldBearish,"                                                                 (-) Belt Hold Bearish. Nen cang dai thi mo hinh cang quan trong. Mo hinh dao chieu. \n","") + //Belt Hold Bearish. Pattern reversal.\nNison: The longer the height of the candle is the most significant pattern.\nReliability second LitWick: Low.
WriteIf(breakAwayBearish,"                                                                 (-) breakvar Away Bearish. Mo hinh dao chieu. Do tin cay :Vua Phai. \n","") + //breakvar Away Bearish. Pattern reversal.\nReliability second LitWick: Moderate
WriteIf(HangingMan,"                                                                 (-) Hanging Man. Mo hinh dao chieu. Nhu la cay bua dao chieu voi y nghia gap down vao ngay hom sau. Do tin cay :Thap \n","") + //Hanging Man. Pattern reversal.\nNison: Such a 'bearish hammer' with a significant gap down the next day. Reliability second LitWick: Low.
WriteIf(deliberationBearish,"                                                                 (-) Deliberation Bearish. Mo hinh dao chieu. Day khong phai la mo hinh dao chieu thuc su,\n                                                                  nhung la mot dau hieu cho thay su phuc hoi dang yeu. Do tin cay :Vua Phai. \n","") + //Deliberation Bearish. Pattern reversal.\nNison: It is not a real pattern of reversal, but a sign that the rally is weakening. Reliability second LitWick: Moderate
WriteIf(CounterAttackBearish,"                                                                 (-) Counter Attack Bearish. Mot ngan can tiem nang cua su lay lai suc. \n","") + //Counter Attack Bearish.\nNison: un potenziale stallo del rally.
WriteIf(engulfingBearish,"                                                                 (-) Engulfing Bearish. Mo hinh dao chieu. Tin hieu dao chieu quan trong. Cac yeu to lam tang tam quan trong cua mo hinh la:\n                                                                  1) Phan tren cua than nen nho va cay nen thu 2 co phan than lon.\n                                                                  2) Mo hinh xuat hien sau 1 su keo dai hoac di chuyen nhanh.\n                                                                  3) Khoi luong lon trong ngay thu 2. \n                                                                  4) Phan than nen cua ngay thu 2 bao phu phan lon cay nen truoc do. Do tin cay :Vua Phai. \n","") + //Engulfing Bearish. Pattern reversal.\nNison: Important sign of reversal. The factors that increase the importance of the patterns are: \n 1) above the candle has a very small body AND the Second candle is a very large body. \n 2) the pattern appears after a protracted OR moving very fast. \n 3 ) High volumes in the Second Day. \n 4) on the Second Day covers the body more than a body of candles before.\nReliability Second LitWick: Moderate
WriteIf(HaramiCrossBearish,"                                                                 (-) Harami Cross Bearish. Mo hinh dao chieu. Mo hinh Harami trong downtrend co y nghia hon.\n                                                                 Ngay thu 2 cay nen co the trang hoac den. Do tin cay :Vua Phai. \n","") + //Harami Cross Bearish. Pattern reversal.\nNison: more significant downtrend pattern of 'Harami'. The second day, the candle can be white or black.\nReliability second LitWick: Moderate
WriteIf(MeetingLinesBearish,"                                                                 (-) Meeting Lines Bearish. Mo hinh dao chieu.Do tin cay :Vua Phai, nhung no khong qua manh nhu Dark Cloud Cover \n","") + //Meeting Lines Bearish. Pattern reversal.\nReliability second LitWick: moderate, but not so strong as' Dark Cloud Cover '.
WriteIf(shootingStarGap,"                                                                 (-) Shooting Star. Mo hinh dao chieu.Khong qua qan trong nhu evening star. Tot nhat, than nen phai nam\n                                                                  trong mot khoang trong so vo than nen truoc do.No se xuat hien sau 1 xu huong tich cuc. Do tin cay :Thap. \n","") + //Shooting Star. Pattern reversal.\nNison: not so important as an 'evening star'. Ideally, the body of the candle should be in a gap from the body of the candle before. It should appear after a positive trend.\nReliability second LitWick: Low.
WriteIf(gravestoneDoji,"                                                                 (-) Gravestone Doji. Mo hinh dao chieu.Quan trong hon khi cham muc cao nhat moi thoi dai. Do tin cay :Vua Phai. \n","") + //Gravestone Doji. Pattern reversal.\nNison: more significant when touching a new all-time high.\nReliability second LitWick: Moderate
WriteIf(triStarBearish,"                                                                 (-) Tri-Star Bearish. Mo hinh dao chieu. Mo hinh dao chieu quan trong nhat. Do tin cay :Vua Phai. \n","") + //Tri-Star Bearish. Pattern reversal.\nNison: pattern of very significant reversal.\nReliability second LitWick: Moderate
WriteIf(twoCrows,"                                                                 (-) 2 Crows. Mo hinh dao chieu.Do tin cay :Vua Phai. \n","") + //2 Crows. Pattern reversal.\nReliability second LitWick: Moderate
WriteIf(dojiStarBearish,"                                                                 (-) Doji Star Bearish. Mo hinh dao chieu. Yeu cau xac nhan. Do tin cay :Vua Phai. \n","") + //Doji Star Bearish. Pattern reversal.\nNison: Requires confirmation.Reliability second LitWick: Moderate
WriteIf(downsideGapThreeMethods,"                                                                 (-) Downside Gap 3 Methods. Tiep tuc xu huong. Do tin cay :Vua Phai. \n","") + //Downside Gap 3 Methods. Pattern continued.\nReliability second LitWick: Moderate
WriteIf(downsideTasukiGap,"                                                                 (-) Downside Tasuki Gap. Neu ngay cuoi cung chung toi thu hep khoang cach, mo hinh tiep tuc se bi tu choi. Do tin cay :Vua Phai. \n","") + //Downside Tasuki Gap. Method of continuation.\nNison: if the last Day we closed the gap, the pattern to continuevar is denied.\nReliability Second LitWick: Moderate
WriteIf(inNeckBearish,"                                                                 (-) In Neck Bearish. Tiep tuc xu huong. Nhu trong mau hinh xuyen thau\n                                                                 nhung giam gia nhieu hon trong ngay thu 2 boi vi khong co su sang suot. Do tin cay :Vua Phai. \n","") + //In Neck Bearish. Pattern continued.\nNison: as in 'piercing pattern' but more bearish on the second day because there is no penetration.\nReliability second LitWick: Moderate
WriteIf(OnNeckBearish,"                                                                 (-) On Neck Bearish. Tiep tuc xu huong. Tuong tu nhu su xuyen thau,\n                                                                 giam gia nhieu hon boi vi khong co su sang suot vao ngay thu 2. Do tin cay :Vua Phai. \n","") + //On Neck Bearish. Pattern continued. Similar to 'piercing'ma more bearish because there is no penetration on the second day.\nReliability second LitWick: Moderate
WriteIf(separatingLinesBearish,"                                                                 (-) Separating Lines Bearish. \n","") +
WriteIf(sideBySideWhiteLinesBearish,"                                                                 (-) Side by Side White Lines Bearish: Tiep tuc xu huong. Do tin cay TB. \n","") + //Side by Side White Lines Bearish. Pattern continued.\nNison: very rare.\nReliability Second LitWick: Moderate
WriteIf(threeLineStrike,"                                                                 (-) 3 Line Strike: Tiep tuc xu huong. Do tin cay thap. \n","") + //3 Line Strike. Pattern continued.\nReliability second LitWick: Low.
WriteIf(thrustingBearish,"                                                                 (-) Thrusting: Tiep tuc xu huong. Khong phai la nen dao chieu boi vi nen hom nay khong dong cua lon hon 1/2 cay nen truoc do. Do tin cay thap. \n","") + //Thrusting. Pattern continued.\nNison: is not a day of reversal because the second day does not engage the midpoint of the first day.\nReliability second LitWick: Low.
WriteIf(tweezerTop,"                                                                 (-) Tweezer Top: Mo hinh nen dao chieu. Theo doi cay nen ngay mai. \n","") //Tweezer Top. Pattern reversal.\nNison: Requires confirmation.
;
 
_SECTION_BEGIN("Gartley");
GBmin = Param("Swing B Min.",0.55,0.3,1,0.01);
GBmax = Param("Swing B Max.",0.72,0.4,1,0.01);
GCmin = Param("Swing C Min.",0.38,0.3,1.27,0.01);
GCmax = Param("Swing C Max.",1.0,0.4,1.27,0.01);
GDmin = Param("Swing D Min.(XA)",0.55,0.3,1,0.01);
GDmax = Param("Swing D Max.(XA)",1.0,0.4,1.0,0.01);
_SECTION_END();

_SECTION_BEGIN("Bat");
BatBmin = Param("Swing B Min.",0.38,0.3,1,0.01);
BatBmax = Param("Swing B Max.",0.55,0.4,1,0.01);
BatCmin = Param("Swing C Min.",0.38,0.3,1.62,0.01);
BatCmax = Param("Swing C Max.",1.27,0.4,1.62,0.01);
BatDmin = Param("Swing D Min.(XA)",0.5,0.3,1,0.01);
BatDmax = Param("Swing D Max.(XA)",1.0,0.4,1.0,0.01);
_SECTION_END();

_SECTION_BEGIN("Butterfly");
BtBmin = Param("Swing B Min.",0.55,0.3,1,0.01);
BtBmax = Param("Swing B Max.",0.9,0.4,1,0.01);
BtCmin = Param("Swing C Min.",0.38,0.3,1.62,0.01);
BtCmax = Param("Swing C Max.",1.27,0.4,1.62,0.01);
BtDmin = Param("Swing D Min.(XA)",1,1,1.8,0.01);
BtDmax = Param("Swing D Max.(XA)",1.8,1,1.8,0.01);						// Max XA of Butterfly = (1.0 - 1.618)
_SECTION_END();

_SECTION_BEGIN("Crab");
CBmin = Param("Swing B Min.",0.38,0.3,1,0.01);
CBmax = Param("Swing B Max.",0.65,0.4,1,0.01);
CCmin = Param("Swing C Min.",0.38,0.3,1.62,0.01);
CCmax = Param("Swing C Max.",1.270,0.4,1.62,0.01);
CDmin = Param("Swing D Min.(XA)",1.25,1,1.8,0.01);
CDmax = Param("Swing D Max.(XA)",1.8,1,2,0.01);
_SECTION_END();

_SECTION_BEGIN("AB=CD");
abcd_Cmin = Param("Swing C Min.",0.3,		0.3	,	1,		0.01);
abcd_Cmax = Param("Swing C Max.",0.8,		0.8	,	1,		0.01);
abcd_Dmin = Param("Swing D Min.",1.2,		1,		2.7,	0.01);
abcd_Dmax = Param("Swing D Max.",3.7,		1,		4,		0.01);
_SECTION_END();

_SECTION_BEGIN("Patterns");

bi = Cum(1)-1;
function GetTop(bars) 														// Lay' gia' tri cao nhat' = di?nh
	{
		Top = H == HHV(H,2*bars) AND Ref(HHV(H,bars),bars) < H;
		Top = Top AND LastValue(bi)-ValueWhen(Top,bi) > bars;
		return Top;
	}

function GetValley(bars)													// La'y gia tri thap' nhat' = day'
	{
		Valley = L == LLV(L,2*bars) AND Ref(LLV(L,bars),bars) > L;
		Valley = Valley AND LastValue(bi)-ValueWhen(Valley,bi) > bars;
		return Valley;
	}
// Build fractals array
P1 = GetTop(strength);										// so' bar cho 1 duong` XA, AB, BC, CD
V1 = GetValley(Strength);
P1 = IIf(P1,IIf(ValueWhen(P1,bi,2) < ValueWhen(V1,bi),P1,IIf(ValueWhen(P1,H,2) > H,False,P1)),P1);
P1 = IIf(P1 AND ValueWhen(P1,bi,0) > bi,IIf(ValueWhen(P1,bi,0) < ValueWhen(V1,bi,0),IIf(ValueWhen(P1,H,0) >= H,False,P1),P1),P1);
V1 = IIf(V1,IIf(ValueWhen(V1,bi,2) < ValueWhen(P1,bi),V1,IIf(ValueWhen(V1,L,2)<L,False,V1)),V1);
V1 = IIf(V1 AND ValueWhen(V1,bi,0) > bi ,IIf(ValueWhen(V1,bi,0) < ValueWhen(P1,bi,0),IIf(ValueWhen(V1,L,0) <= L, False,V1),V1),V1); 
P1H1 = ValueWhen(P1,H);
P1Bar1 = ValueWhen(P1,bi);
P1H2 = ValueWhen(P1,H,2);
P1Bar2 = ValueWhen(P1,bi,2);
V1L1 = ValueWhen(V1,L);
V1Bar1 = ValueWhen(V1,bi);
V1L2 = ValueWhen(V1,L,2);
V1Bar2 = ValueWhen(V1,bi,2);

//============================================
//				BULLISH PATTERNS
//============================================
/*
	Mo hinh Bullish:
	A	=	P1H2
	B	=	V1L1
	C	=	P1H1
	X	=	V1L2

*/
PTvalid = (P1Bar1 > V1Bar1 AND V1Bar1 > P1Bar2 AND P1bar2 > V1Bar2) AND P1; // Peaks and troughs are in order
myAX			=	P1H2-V1L2;
myAB			=	P1H2-V1L1;
myBC			=	P1H1-V1L1;
myAB_AX		=	myAB/ myAX;
myBC_AB		=	myBC/ myAB;	
BullGartley4 		= PTvalid 	AND 	(	myAB_AX > GBmin	) 		AND (	myAB_AX < GBmax	)
								AND  	(	myBC_AB > GCMin 	) 		AND (	myBC_AB < GCMax	); 

BullBat4 			= PTvalid 	AND 	(	myAB_AX > BatBmin ) 		AND (	myAB_AX < BatBmax	)
								AND 	(	myBC_AB > BatCMin ) 		AND (	myBC_AB < BatCMax	); 

BullButterfly4 	= PTvalid 	AND 	(	myAB_AX > BtBmin ) 		AND (	myAB_AX < BtBMax	)
								AND  	(	myBC_AB > BtCmin ) 		AND (	myBC_AB < BtCmin 	);

BullCrab4 			= PTvalid 	AND 	(	myAB_AX > CBmin )	  		AND (	myAB_AX < CBmax 	)
								AND  	(	myBC_AB > CCmin ) 		AND (	myBC_AB < CCmax	);

BullABCD4			= PTvalid AND 	(	myBC_AB > abcd_Cmin) 	AND (	myBC_AB < abcd_Cmax	);
strPattern = "";

//==================================================
//				 BULLISH ABCD
// 	Bullish pattern found. D retracement level is not evaluated
//==================================================
	dHigh		=		HighestSince(BullABCD4,H);				// Tinh' gia' tri min, max cua duong Ad. Duong Ad la duong con cua AD
	dLow 		= 		LowestSince(BullABCD4,L);
	myC			=		ValueWhen(BullABCD4,P1H1);
	myB			=		ValueWhen(BullABCD4,V1L1);
	myA			=		ValueWhen(BullABCD4,P1H2);
	myX			=		ValueWhen(BullABCD4,V1L2);
	myCB		=		myC - myB;
	my_d_min	=		myCB	*	abcd_DMin ;					// Tinh' gia' tri cua duong Ad con. Khi gia' giam? tu` tre^n xuong' thi` max -> min
	my_d_max	=		myCB	*	abcd_DMax ;
	my_Cd_min	=		myC - my_d_min;					   // Khoang dich chuyen cua duong Ad con.
	my_Cd_max	=		myC - my_d_max;
BullABCD	 	= 		IIf(		( dLow  <	my_Cd_min	)	AND		( dLow	> my_Cd_max )	
								AND	( dHigh	<=	myC		)	AND		( dLow	==	L), 
								True, False
							);

BullABCD		=		BullABCD	AND (dLow		<	myB);

//==================================================
// 				BULLISH GARTLEY
//==================================================
	dHigh		=		HighestSince(BullGartley4,H);				// Tinh' gia' tri min, max cua duong Ad. Duong Ad la duong con cua AD
	dLow 		= 		LowestSince(BullGartley4,L);

	myC			=		ValueWhen(BullGartley4,P1H1);
	myB			=		ValueWhen(BullGartley4,V1L1);
	myA			=		ValueWhen(BullGartley4,P1H2);
	myX			=		ValueWhen(BullGartley4,V1L2);
	myAX		=		myA - myX;
	my_d_min	=		myAX	*	GDmin;							// Tinh' gia' tri cua duong Ad con. Khi gia' giam? tu` tre^n xuong' thi` max -> min
	my_d_max	=		myAX	*	GDMax;
	my_Ad_min	=		myA - my_d_min;							// Khoang dich chuyen cua duong Ad con.
	my_Ad_max	=		myA - my_d_max;

BullGartley 	= 		IIf(		( dLow  <	my_Ad_min	)	AND		( dLow	> my_Ad_max )	
								AND	( dHigh	<=	myC		)	AND		( dLow	==	L), 
								True, False
							);
BullGartley 	=		BullGartley 	AND (dLow		<	myB);						// diem D thap' hon B
strPattern 	=		WriteIf(BullGartley,"BULLISH GARTLEY",strPattern);

//==================================================
// 				BULLISH BAT
//==================================================
	dHigh		=		HighestSince(BullBat4,H);				// Tinh' gia' tri min, max cua duong Ad. Duong Ad la duong con cua AD
	dLow 		= 		LowestSince(BullBat4,L);	
	myC			=		ValueWhen(BullBat4,P1H1);
	myB			=		ValueWhen(BullBat4,V1L1);
	myA			=		ValueWhen(BullBat4,P1H2);
	myX			=		ValueWhen(BullBat4,V1L2);
	myAX		=		myA - myX;
	my_d_min	=		myAX	*	BatDmin;						// Tinh' gia' tri cua duong Ad con. Khi gia' giam? tu` tre^n xuong' thi` max -> min
	my_d_max	=		myAX	*	BatDmax ;
	my_Ad_min	=		myA - my_d_min;							// Khoang dich chuyen cua duong Ad con.
	my_Ad_max	=		myA - my_d_max;
BullBat 		= 		IIf(		( dLow  <	my_Ad_min	)	AND		( dLow	> my_Ad_max )	
								AND	( dHigh	<=	myC		)	AND		( dLow	==	L), 
								True, False
							);
BullBat 		=		BullBat 	AND (dLow		<	myB);			// diem d thap hon diem B
strPattern 	=		WriteIf(BullBat,"BULLISH BAT",strPattern);

//==================================================
// 				BULLISH CRAB - CUA
//==================================================
	dHigh		=		HighestSince(BullCrab4,H);				// Tinh' gia' tri min, max cua duong Ad. Duong Ad la duong con cua AD
	dLow 		= 		LowestSince(BullCrab4,L);
	myC			=		ValueWhen(BullCrab4,P1H1);
	myB			=		ValueWhen(BullCrab4,V1L1);
	myA			=		ValueWhen(BullCrab4,P1H2);
	myX			=		ValueWhen(BullCrab4,V1L2);
	myAX		=		myA - myX;
	my_d_min	=		myAX	*	CDmin ;					// Tinh' gia' tri cua duong Ad con. Khi gia' giam? tu` tre^n xuong' thi` max -> min
	my_d_max	=		myAX	*	CDmax ;
	my_Ad_min	=		myA - my_d_min;						// Khoang dich chuyen cua duong Ad con.
	my_Ad_max	=		myA - my_d_max;
BullCrab 		= 		IIf(		( dLow  <	my_Ad_min	)	AND		( dLow	> my_Ad_max )	
								AND	( dHigh	<=	myC		)	AND		( dLow	==	L), 
								True, False
							);
BullCrab 		=		BullCrab 	AND (dLow		<	myX);					// diem D thap' hon X
strPattern 	=		WriteIf(BullCrab ,"BULLISH CRAB",strPattern);


//==================================================
// 				BULLISH  BUTTTERFLY
//==================================================
	dHigh		=		HighestSince(BullButterfly4,H);				// Tinh' gia' tri min, max cua duong Ad. Duong Ad la duong con cua AD
	dLow 		= 		LowestSince(BullButterfly4,L);
	myC			=		ValueWhen(BullButterfly4,P1H1);
	myB			=		ValueWhen(BullButterfly4,V1L1);
	myA			=		ValueWhen(BullButterfly4,P1H2);
	myX			=		ValueWhen(BullButterfly4,V1L2);
	myAX		=		myA - myX;
	my_d_min	=		myAX	*	BtDmin ;								// Tinh' gia' tri cua duong Ad con. Khi gia' giam? tu` tre^n xuong' thi` max -> min
	my_d_max	=		myAX	*	BtDmax ;
	my_Ad_min	=		myA - my_d_min;									// Khoang dich chuyen cua duong Ad con.
	my_Ad_max	=		myA - my_d_max;
BullButterfly 	= 		IIf(		( dLow  <	my_Ad_min	)	AND		( dLow	> my_Ad_max )	
									AND	( dHigh	<=	myC		)	AND		( dLow	==	L), 
								True, False
								);
BullButterfly 	=		BullButterfly 	AND (dLow		<	myX);					// diem D thap' hon X
strPattern 		=		WriteIf(BullButterfly ,"BULLISH BUTTERFLY",strPattern);

//==========================================================
//   VE DUONG CHO MO HINH BULLISH ABCB 
//==========================================================
BullHar4 	=  BullABCD4;
BullHar 	=  BullABCD;
Point4 = IIf(BullHar,ValueWhen(BullHar4,bi),Null);
BullHar = IIf(BullHar, IIf(Point4 == ValueWhen(BullHar,point4,0) AND ValueWhen(BullHar,bi,0) > bi ,False,BullHar),BullHar);
A = ValueWhen(BullHar4,P1H2);
Abar = ValueWhen(BullHar4,P1bar2);
B = ValueWhen(BullHar4,V1L1);
Bbar = ValueWhen(BullHar4,V1bar1);
C1 = ValueWhen(BullHar4,P1H1);
C1bar = ValueWhen(BullHar4,P1bar1);
D = ValueWhen(BullHar,L);
Dbar = ValueWhen(BullHar,bi);
BCdAB = (C1-B)/(A-B);
BCdCD = (C1-D)/(C1-B);
PlotPattern = Dbar > C1bar;
if(LastValue(PlotPattern) AND bu)
{
		ColorX = colorGreen;
	// Ve cac duong AB, BC, CD
		Plot(LineArray(LastValue(Abar),LastValue(A),LastValue(Bbar),LastValue(B)),"",ColorX ,styleThick);
		Plot(LineArray(LastValue(Bbar),LastValue(B),LastValue(C1bar),LastValue(C1)),"",ColorX ,styleThick);
		Plot(LineArray(LastValue(C1bar),LastValue(C1),LastValue(Dbar),LastValue(D)),"",ColorX ,styleThick);
		Plot(LineArray(LastValue(Abar),LastValue(A),LastValue(C1bar),LastValue(C1)),"",ColorX ,styleDashed);
		Plot(LineArray(LastValue(Bbar),LastValue(B),LastValue(Dbar),LastValue(D)),"",ColorX ,styleDashed);
	// Ve cac gia tri Fibo
		PlotText(NumToStr(LastValue(BCdAB),1.2),(LastValue(C1bar)+LastValue(Abar))/2,(LastValue(C1)+LastValue(A))/2,ColorX );
		PlotText(NumToStr(LastValue(BCdCD),1.2),(LastValue(Bbar)+LastValue(Dbar))/2,(LastValue(B)+LastValue(D))/2,ColorX );
	//---------- Viet cac diem X, A, B, C, D: by binhnd---------------------
		xlech		=	0;
		ylech 		= 	2;
		PlotText("",LastValue(Abar)	+ 	xlech,	LastValue(A)	+	ylech,	ColorX );
		PlotText("",LastValue(Bbar)	+ 	xlech,	LastValue(B)	-	ylech,	ColorX );
		PlotText("",LastValue(C1bar)	+ 	xlech,	LastValue(C1)	+	ylech,	ColorX );
		PlotText("BUY",LastValue(Dbar)	+ 	xlech,	LastValue(D)	-	ylech,	ColorX );
	//--------- Viet thuyet minh mo hinh: by binhnd--------------
		if (strPattern!="")  
		{
			myStr			=	"BULLISH AB=CD";
			toadoX			=	LastValue(Abar);
			toadoY			=	LastValue(D);
			PlotText(myStr,toadoX,toadoY,ColorX );
		}
}			//	end of Ve duong` bullish abcd

//==========================================================
//   VE DUONG CHO MO HINH BULLISH BAT, GARTLEY, BUTTERFLY, CRAB
//==========================================================

BullHar4 = BullGartley4 OR BullButterfly4 OR BullBat4 OR BullCrab4 ;
BullHar = BullGartley OR BullButterfly OR BullBat OR BullCrab;
Point4 = IIf(BullHar,ValueWhen(BullHar4,bi),Null);
BullHar = IIf(BullHar, IIf(Point4 == ValueWhen(BullHar,point4,0) AND ValueWhen(BullHar,bi,0) > bi ,False,BullHar),BullHar);
X = ValueWhen(BullHar4,V1L2);
Xbar = ValueWhen(BullHar4,V1Bar2);
A = ValueWhen(BullHar4,P1H2);
Abar = ValueWhen(BullHar4,P1bar2);
B = ValueWhen(BullHar4,V1L1);
Bbar = ValueWhen(BullHar4,V1bar1);
C1 = ValueWhen(BullHar4,P1H1);
C1bar = ValueWhen(BullHar4,P1bar1);
D = ValueWhen(BullHar,L);
Dbar = ValueWhen(BullHar,bi);
ABdXA = (A-B)/(A-X);
BCdAB = (C1-B)/(A-B);
ADdXA = (A-D)/(A-X);
BCdCD = (C1-D)/(C1-B);
PlotPattern = Dbar > C1bar;
if(LastValue(PlotPattern) AND bu)
{
			ColorX	= ColorRGB(62,158,255);
		// Ve cac duong XA, AB, BC, CD
			Plot( LineArray(LastValue(Xbar),LastValue(X),LastValue(Abar),LastValue(A)),"",ColorX,styleThick);
			Plot(LineArray(LastValue(Abar),LastValue(A),LastValue(Bbar),LastValue(B)),"",ColorX,styleThick);
			Plot(LineArray(LastValue(Bbar),LastValue(B),LastValue(C1bar),LastValue(C1)),"",ColorX,styleThick);
			Plot(LineArray(LastValue(C1bar),LastValue(C1),LastValue(Dbar),LastValue(D)),"",ColorX,styleThick);
			Plot(LineArray(LastValue(Xbar),LastValue(X),LastValue(Bbar),LastValue(B)),"",ColorX,styleDashed);
			Plot(LineArray(LastValue(Xbar),LastValue(X),LastValue(Abar),LastValue(A)),"",ColorX,styleThick);
			Plot(LineArray(LastValue(Abar),LastValue(A),LastValue(C1bar),LastValue(C1)),"",ColorX,styleDashed);
			Plot(LineArray(LastValue(Bbar),LastValue(B),LastValue(Dbar),LastValue(D)),"",ColorX,styleDashed);
			Plot(LineArray(LastValue(Xbar),LastValue(X),LastValue(Dbar),LastValue(D)),"",ColorX,styleDashed);
		// Ve cac gia tri Fibo
			PlotText(NumToStr(LastValue(ABdXA),1.2),(LastValue(Bbar)+LastValue(Xbar))/2,(LastValue(B)+LastValue(X))/2,ColorX);
			PlotText(NumToStr(LastValue(BCdAB),1.2),(LastValue(C1bar)+LastValue(Abar))/2,(LastValue(C1)+LastValue(A))/2,ColorX);
			PlotText(NumToStr(LastValue(ADdXA),1.2) ,(LastValue(Dbar)+LastValue(Xbar))/2,(LastValue(D)+LastValue(X))/2,ColorX);
			PlotText(NumToStr(LastValue(BCdCD),1.2),(LastValue(Bbar)+LastValue(Dbar))/2,(LastValue(B)+LastValue(D))/2,ColorX);
		//---------- Viet cac diem X, A, B, C, D: by binhnd---------------------
			xlech		=	0;
			ylech 		= 	2;
			PlotText("",LastValue(Xbar)	+ 	xlech,	LastValue(X)	-	ylech,	ColorX);
			PlotText("",LastValue(Abar)	+ 	xlech,	LastValue(A)	+	ylech,	ColorX);
			PlotText("",LastValue(Bbar)	+ 	xlech,	LastValue(B)	-	ylech,	ColorX);
			PlotText("",LastValue(C1bar)	+ 	xlech,	LastValue(C1)	+	ylech,	ColorX);
			PlotText("BUY",LastValue(Dbar)	+ 	xlech,	LastValue(D)	-	ylech,	ColorX);
		//--------- Viet thuyet minh mo hinh: by binhnd--------------
			if (strPattern!="")  
			{
				strPattern 	= 	"Mo Hinh: " + strPattern;
				toadoX			=	(LastValue(Dbar)+LastValue(Xbar))/2;
				toadoY			=	(LastValue(D)+LastValue(X))/2;
				PlotText(strPattern,toadoX,toadoY-2,ColorX);
			}
}			// end of Ve duong cho cac mo hinh Crab, Butterfly, Bat
//=============================================================
//				BEARISH PATTERNS
//=============================================================
PTvalid = (V1Bar1 > P1Bar1 AND P1Bar1 > V1Bar2 AND V1Bar2 > P1Bar2) AND V1;
/*=====================
		X 	= 	P1H2					 Trong mo hinh` bear: Die^m X cao hon diem A. MyAX = X-> A
		A	=	V1L2
		B	=	P1H1
		C	=	V1L1
=======================*/
myAX			=	P1H2-V1L2;				
myAB			=	P1H1-V1L2;
myBC			=	P1H1-V1L1;
myAB_AX		=	myAB/ myAX;
myBC_AB		=	myBC/ myAB;	
BearGartley4 		= PTvalid 	AND 	(	myAB_AX > GBmin	) 		AND (	myAB_AX < GBmax	)
								AND  	(	myBC_AB > GCMin 	) 		AND (	myBC_AB < GCMax	); 
BearBat4 			= PTvalid 	AND 	(	myAB_AX > BatBmin ) 		AND (	myAB_AX < BatBmax	)
								AND 	(	myBC_AB > BatCMin ) 		AND (	myBC_AB < BatCMax	); 
BearButterfly4 	= PTvalid 	AND 	(	myAB_AX > BtBmin ) 		AND (	myAB_AX < BtBMax	)
								AND  	(	myBC_AB > BtCmin ) 		AND (	myBC_AB < BtCmin 	);
BearCrab4 			= PTvalid 	AND 	(	myAB_AX > CBmin )	  		AND (	myAB_AX < CBmax 	)
								AND  	(	myBC_AB > CCmin ) 		AND (	myBC_AB < CCmax	);
BearABCD4			= PTvalid AND 	(	myBC_AB > abcd_Cmin) 	AND (	myBC_AB < abcd_Cmax	);
strPattern = "";

//==========================================================
//				 BEARISH ABCD
// 	Bearish pattern found. D retracement level is not evaluated
//==========================================================
	dHigh		=		HighestSince(BearABCD4,H);				// Tinh' gia' tri min, max cua duong Ad. Duong Ad la duong con cua AD
	dLow 		= 		LowestSince(BearABCD4,L);
	myA			=		ValueWhen(BearABCD4,V1L2);
	myB			=		ValueWhen(BearABCD4,P1H1);
	myC			=		ValueWhen(BearABCD4,V1L1);
	myCB		=		myB - myC;
	my_d_min	=		myCB	*	abcd_DMin ;					// Tinh' gia' tri cua duong Ad con. Khi gia' giam? tu` tre^n xuong' thi` max -> min
	my_d_max	=		myCB	*	abcd_DMax ;
	my_Cd_min	=		myC + my_d_min;					   // Khoang dich chuyen cua duong Ad con.
	my_Cd_max	=		myC + my_d_max;
BearABCD	 	= 		IIf(		( dHigh  	>	my_Cd_min	)	AND		( dHigh	< my_Cd_max )	
								AND	( dLow		>=	myC			)	AND		( dHigh	==	H), 
								True, False
							);
BearABCD		=		BearABCD	AND (dHigh		>	myB);

//=============================================================
//				BEARISH GARTLEY
//=============================================================
	dHigh		=		HighestSince(BearGartley4,H);		// Tinh' gia' tri min, max cua duong Ad. Duong Ad la duong con cua AD
	dLow 		= 		LowestSince(BearGartley4,L);

	myX			=		ValueWhen(BearGartley4,P1H2);
	myA			=		ValueWhen(BearGartley4,V1L2);
	myAX		=		myX - myA;

	myB			=		ValueWhen(BearGartley4,P1H1);
	myC			=		ValueWhen(BearGartley4,V1L1);


	my_d_min	=		myAX	*	GDmin;						// Tinh' gia' tri cua duong Ad con. Khi gia' giam? tu` tre^n xuong' thi` max -> min
	my_d_max	=		myAX	*	GDMax;
	my_Ad_min	=		myA 	+ 	my_d_min;					// Khoang dich chuyen cua duong Ad con.
	my_Ad_max	=		myA 	+ 	my_d_max;

BearGartley 	= 		IIf(		( dHigh	>	my_Ad_min	)	AND		( dHigh	< my_Ad_max )	
								AND	( dLow		>=	myC			)	AND		( dHigh	==	H), 
								True, False
							);
BearGartley 	=		BearGartley 	AND (dHigh		>	myB);						// diem D cao hon B
strPattern 	=		WriteIf(BearGartley ,"BEARISH BAT",strPattern);

//=============================================================
//				BEARISH BAT
//=============================================================
	dHigh		=		HighestSince(BearBat4,H);		// Tinh' gia' tri min, max cua duong Ad. Duong Ad la duong con cua AD
	dLow 		= 		LowestSince(BearBat4,L);

	myX			=		ValueWhen(BearBat4,P1H2);
	myA			=		ValueWhen(BearBat4,V1L2);
	myAX		=		myX - myA;

	myB			=		ValueWhen(BearBat4,P1H1);
	myC			=		ValueWhen(BearBat4,V1L1);


	my_d_min	=		myAX	*	BatDmin ;						// Tinh' gia' tri cua duong Ad con. Khi gia' giam? tu` tre^n xuong' thi` max -> min
	my_d_max	=		myAX	*	BatDMax ;
	my_Ad_min	=		myA 	+ 	my_d_min;					// Khoang dich chuyen cua duong Ad con.
	my_Ad_max	=		myA 	+ 	my_d_max;

BearBat 		= 		IIf(		( dHigh	>	my_Ad_min	)	AND		( dHigh	< my_Ad_max )	
								AND	( dLow		>=	myC			)	AND		( dHigh	==	H), 
								True, False
							);
BearBat 		=		BearBat 	AND (dHigh		>	myB);						// diem D cao hon B
strPattern 	=		WriteIf(BearBat ,"BEARISH BAT",strPattern);


//=============================================================
//				BEARISH BUTTERFLY
//=============================================================
	dHigh		=		HighestSince(BearButterfly4,H);		// Tinh' gia' tri min, max cua duong Ad. Duong Ad la duong con cua AD
	dLow 		= 		LowestSince(BearButterfly4,L);

	myX			=		ValueWhen(BearButterfly4,P1H2);
	myA			=		ValueWhen(BearButterfly4,V1L2);
	myAX		=		myX - myA;

	myB			=		ValueWhen(BearButterfly4,P1H1);
	myC			=		ValueWhen(BearButterfly4,V1L1);


	my_d_min	=		myAX	*	BtDmin ;						// Tinh' gia' tri cua duong Ad con. Khi gia' giam? tu` tre^n xuong' thi` max -> min
	my_d_max	=		myAX	*	BtDmax ;
	my_Ad_min	=		myA 	+ 	my_d_min;						// Khoang dich chuyen cua duong Ad con.
	my_Ad_max	=		myA 	+ 	my_d_max;

BearButterfly = 		IIf(		( dHigh	>	my_Ad_min	)	AND		( dHigh	< my_Ad_max )	
								AND	( dLow		>=	myC			)	AND		( dHigh	==	H), 
								True, False
							);
BearButterfly	=		BearButterfly 	AND (dHigh		>	myX);						// diem D cao hon X
strPattern		=		WriteIf(BearButterfly ,"BEARISH BUTTERFLY",strPattern);



//=============================================================
//				BEARISH CRAB
//=============================================================
	dHigh		=		HighestSince(BearCrab4,H);				// Tinh' gia' tri min, max cua duong Ad. Duong Ad la duong con cua AD
	dLow 		= 		LowestSince(BearCrab4,L);

	myX			=		ValueWhen(BearCrab4,P1H2);
	myA			=		ValueWhen(BearCrab4,V1L2);
	myAX		=		myX - myA;

	myB			=		ValueWhen(BearCrab4,P1H1);
	myC			=		ValueWhen(BearCrab4,V1L1);


	my_d_min	=		myAX	*	CDmin ;						// Tinh' gia' tri cua duong Ad con. Khi gia' giam? tu` tre^n xuong' thi` max -> min
	my_d_max	=		myAX	*	CDmax ;
	my_Ad_min	=		myA 	+ 	my_d_min;						// Khoang dich chuyen cua duong Ad con.
	my_Ad_max	=		myA 	+ 	my_d_max;

BearCrab 		= 		IIf(		( dHigh	>	my_Ad_min	)	AND		( dHigh	< my_Ad_max )	
								AND	( dLow		>=	myC			)	AND		( dHigh	==	H), 
								True, False
							);
BearCrab 		=		BearCrab 	AND (dHigh		>	myX);						// diem D cao hon X
strPattern 	=		WriteIf(BearCrab ,"BEARISH CRAB",strPattern);



//==========================================================
//   VE DUONG CHO MO HINH BEARISH ABCD
//==========================================================


BearHar4 = BearABCD4;
BearHar = BearABCD;

Point4 = IIf(BearHar,ValueWhen(BearHar4,bi),Null);
BearHar = IIf(BearHar, IIf(Point4 == ValueWhen(BearHar,point4,0) AND ValueWhen(BearHar,bi,0) > bi ,False,BearHar),BearHar);

A = ValueWhen(BearHar4,V1L2);
Abar = ValueWhen( BearHar4,V1bar2);
B = ValueWhen(BearHar4,P1H1);
Bbar = ValueWhen(BearHar4,P1bar1);
C1 = ValueWhen(BearHar4,V1L1);
C1bar = ValueWhen(BearHar4,V1bar1);
D = ValueWhen(BearHar,H);
Dbar = ValueWhen(BearHar,bi);

BCdAB = (B-C1)/(B-A);
BCdCD = (D-C1)/(B-C1);

PlotPattern = Dbar > C1bar;

//--------- Ve duong ------------------
if(LastValue(Plotpattern) AND be)
{
		ColorX = colorYellow;
	// Ve duong AB, BC
		Plot(LineArray(LastValue(Abar),LastValue(A),LastValue(Bbar),LastValue(B)),"",ColorX ,styleThick);
		Plot(LineArray(LastValue(Bbar),LastValue(B),LastValue(C1bar),LastValue(C1)),"",ColorX ,styleThick);
		Plot(LineArray(LastValue(C1bar),LastValue(C1),LastValue(Dbar),LastValue(D)),"",ColorX ,styleThick);
		Plot(LineArray(LastValue(Abar),LastValue(A),LastValue(C1bar),LastValue(C1)),"",ColorX ,styleDashed);
		Plot(LineArray(LastValue(Bbar),LastValue(B),LastValue(Dbar),LastValue(D)),"",ColorX ,styleDashed);

	// Viet cac gia tri Fibo tren duong AB, BC
		PlotText(NumToStr(LastValue(BCdAB),1.2),(LastValue(C1bar)+LastValue(Abar))/2,(LastValue(C1)+LastValue(A))/2,ColorX );
		PlotText(NumToStr(LastValue(BCdCD),1.2) ,(LastValue(Dbar)+LastValue(Bbar))/2,(LastValue(D)+LastValue(B))/2,ColorX );

	//---------- Viet cac diem A, B, C, D: by binhnd---------------------
		xlech		=	-1;
		ylech 		= 	1;
		PlotText("",LastValue(Abar)	+ 	xlech,	LastValue(A)	-	ylech,	ColorX );
		PlotText("",LastValue(Bbar)	+ 	xlech,	LastValue(B)	+	ylech,	ColorX );
		PlotText("",LastValue(C1bar)	+ 	xlech,	LastValue(C1)	-	ylech,	ColorX );
		PlotText("SELL",LastValue(Dbar)	+ 	xlech,	LastValue(D)	+	ylech,	ColorX );

	//--------- Viet thuyet minh mo hinh: by binhnd--------------
		if (strPattern!="") 
			{
				myStr			=	"MAU HINH: BEARISH AB=CD";
				toadoaX		=	LastValue(Abar);
				toadoY			=	LastValue(D);

				PlotText(myStr,toadoaX,toadoY+1,ColorX );
			}
	
}			// end of VE DUONG CHO MO HINH BEARISH ABCD


//==========================================================
//   VE DUONG CHO MO HINH BEARISH BAT, GARTLEY, BUTTERFLY, CRAB
//==========================================================

BearHar4 = BearGartley4 OR BearButterfly4 OR BearBat4 OR BearCrab4 ;
BearHar = BearGartley OR BearButterfly OR BearBat OR BearCrab ;

Point4 = IIf(BearHar,ValueWhen(BearHar4,bi),Null);
BearHar = IIf(BearHar, IIf(Point4 == ValueWhen(BearHar,point4,0) AND ValueWhen(BearHar,bi,0) > bi ,False,BearHar),BearHar);

X = ValueWhen(BearHar4,P1H2);
Xbar = ValueWhen(BearHar4,P1Bar2);
A = ValueWhen(BearHar4,V1L2);
Abar = ValueWhen( BearHar4,V1bar2);
B = ValueWhen(BearHar4,P1H1);
Bbar = ValueWhen(BearHar4,P1bar1);
C1 = ValueWhen(BearHar4,V1L1);
C1bar = ValueWhen(BearHar4,V1bar1);
D = ValueWhen(BearHar,H);
Dbar = ValueWhen(BearHar,bi);

ABdXA = (B-A)/(X-A);
BCdAB = (B-C1)/(B-A);
ADdXA = (D-A)/(X-A);
BCdCD = (D-C1)/(B-C1);

PlotPattern = Dbar > C1bar;

//--------- Ve duong ------------------
if(LastValue(Plotpattern) AND be)
{
		ColorX = ColorRGB(255,128,128);
	// Ve duong XA, AB, BC
		Plot( LineArray(LastValue(Xbar),LastValue(X),LastValue(Abar),LastValue(A)),"",ColorX ,styleThick);
		Plot(LineArray(LastValue(Abar),LastValue(A),LastValue(Bbar),LastValue(B)),"",ColorX ,styleThick);
		Plot(LineArray(LastValue(Bbar),LastValue(B),LastValue(C1bar),LastValue(C1)),"",ColorX ,styleThick);
		Plot(LineArray(LastValue(C1bar),LastValue(C1),LastValue(Dbar),LastValue(D)),"",ColorX ,styleThick);
		Plot(LineArray(LastValue(Xbar),LastValue(X),LastValue(Bbar),LastValue(B)),"",ColorX ,styleDashed);
		Plot(LineArray(LastValue(Xbar),LastValue(X),LastValue(Abar),LastValue(A)),"",ColorX ,styleThick);
		Plot(LineArray(LastValue(Abar),LastValue(A),LastValue(C1bar),LastValue(C1)),"",ColorX ,styleDashed);
		Plot(LineArray(LastValue(Bbar),LastValue(B),LastValue(Dbar),LastValue(D)),"",ColorX ,styleDashed);
		Plot(LineArray(LastValue(Xbar),LastValue(X),LastValue(Dbar),LastValue(D)),"",ColorX ,styleDashed);

	// Viet cac gia tri Fibo tren duong XA, AB, BC
		PlotText(NumToStr(LastValue(ABdXA),1.2),(LastValue(Bbar)+LastValue(Xbar))/2,(LastValue(B)+LastValue(X))/2,ColorX );
		PlotText(NumToStr(LastValue(BCdAB),1.2),(LastValue(C1bar)+LastValue(Abar))/2,(LastValue(C1)+LastValue(A))/2,ColorX );
		PlotText(NumToStr(LastValue(BCdCD),1.2) ,(LastValue(Dbar)+LastValue(Bbar))/2,(LastValue(D)+LastValue(B))/2,ColorX );
		PlotText(NumToStr(LastValue(ADdXA),1.2) ,(LastValue(Dbar)+LastValue(Xbar))/2,(LastValue(D)+LastValue(X))/2,ColorX );

	//---------- Viet cac diem X, A, B, C, D: by binhnd---------------------
		xlech		=	-1;
		ylech 		= 	1;
		PlotText("",LastValue(Xbar)	+ 	xlech,	LastValue(X)	+	ylech,	ColorX );
		PlotText("",LastValue(Abar)	+ 	xlech,	LastValue(A)	-	ylech,	ColorX );
		PlotText("",LastValue(Bbar)	+ 	xlech,	LastValue(B)	+	ylech,	ColorX );
		PlotText("",LastValue(C1bar)	+ 	xlech,	LastValue(C1)	-	ylech,	ColorX );
		PlotText("SELL",LastValue(Dbar)	+ 	xlech,	LastValue(D)	+	ylech,	ColorX );

	//--------- Viet thuyet minh mo hinh: by binhnd--------------
		if (strPattern!="") 
			{
				strPattern 	= 	"Mo Hinh " + strPattern;
				toadoaX		=	(LastValue(Dbar)+LastValue(Xbar))/2;
				toadoY			=	(LastValue(D)+LastValue(X))/2;

				PlotText(strPattern,toadoaX,toadoY+1,ColorX );
			}
	
}			// end of VE DUONG CHO MO HINH BEARISH BAT, GARTLEY, BUTTERFLY, CRAB

//=================================
// Show diem ho^~ tro. va` khang' cu. ko?
//=================================

plotFractals = ParamToggle("Plot Fractals","Off|On",0);				
if(PlotFractals)
{
	PlotShapes(shapeDownArrow*P1,colorYellow,0,H,-10);
	PlotShapes(shapeUpArrow*V1,colorBrightGreen,0,L,-10);
}
//==============================================
// DAT DIEU KIEN cho TIM KIEM BULL
//==============================================
dkBull = False;
ListBull 		= 	ParamList("Type of Bullish", "None|AB=CD|Gartley|Butterfly|Bat|Crab|All Patterns", 6);
	if 	(	ListBull == "None"		)		dkBull = 	True;
	if (	ListBull =="AB=CD"		) 		dkBull	=	BullABCD ;
	if (	ListBull =="Gartley"		) 		dkBull	=	BullGartley ;
	if (	ListBull =="Butterfly"	) 		dkBull	=	BullButterfly ;
	if (	ListBull =="Bat"			) 		dkBull	=	BullBat ;
	if (	ListBull =="Crab"			) 		dkBull	=	BullCrab ;
	if (	ListBull =="All Patterns") 		dkBull	=	(BullABCD) OR (BullGartley) OR (BullButterfly ) OR (BullBat ) OR (BullCrab);
//===============================

//==============================================
// DAT DIEU KIEN cho TIM KIEM BEAR
//==============================================
dkBear = False;
ListBear 		= 	ParamList("Type of Bearish", "None|AB=CD|Gartley|Butterfly|Bat|Crab|All Patterns", 0);
	if 	(	ListBear == "None"		)		dkBear = 	True;
	if (	ListBear =="AB=CD"		) 		dkBear	=	BearABCD ;
	if (	ListBear =="Gartley"		) 		dkBear	=	BearGartley ;
	if (	ListBear =="Butterfly"	) 		dkBear	=	BearButterfly ;
	if (	ListBear =="Bat"			) 		dkBear	=	BearBat ;
	if (	ListBear =="Crab"			) 		dkBear =	BearCrab ;
	if (	ListBear =="All Patterns") 		dkBear =	(BearABCD ) OR (BearGartley ) OR (BearButterfly ) OR (BearBat ) OR (BearCrab );
//===============================
AddColumn(BullABCD,"BlABCD",True);
AddColumn(BullGartley,"BlGartley",True);
AddColumn(BullBat,"BLBat",True);
AddColumn(BullCrab,"BlCrab",True);
AddColumn(BullButterfly,"BlButrfly",True);

AddColumn(BearABCD,"BrABCD",True);
AddColumn(BearGartley,"BrGartley",True);
AddColumn(BearBat,"BrBat",True);
AddColumn(BearCrab,"BrCrab",True);
AddColumn(BearButterfly,"BrButrfly",True);

_SECTION_END();

_SECTION_BEGIN("");
HaClose[0] = (Open[0]+High[0]+Low[0]+Close[0]) / 4;
HaOpen[0] = (HaClose[0] + Open[0]) / 2;
HaHigh[0] = Max( High[0], Max( HaClose[0], HaOpen[0] ) );
HaLow[0] = Min( Low[0], Min( HaClose[0], HaOpen[0] ) );
for (i = 1; i < BarCount; i++)
{
HaClose[i] = (Open[i]+High[i]+Low[i]+Close[i]) / 4;
Haopen[i] = (HaClose[i-1] + HaOpen[i-1]) / 2;
HaHigh[i] = Max( High[i], Max( HaClose[i], HaOpen[i] ) );
Halow[i] = Min( Low[i], Min( HaClose[i], HaOpen[i] ) );
}
Periods = Param("Periods", 14, 2, 300, 1, 10 );
simpleMA = MA( HaClose, Periods );
///////////
FastEma=Param("Fast EMA", 12, 1 , 25, 1);
SlowEma=Param("Slow EMA", 26, 1 , 50, 1);
SignalEma=Param("Signal EMA", 9, 1 , 25, 1);
// signals
OsMA=MACD( FastEma, SlowEma )-Signal( FastEma, SlowEma, SignalEma );
// Plot removed
momentum = HaClose * 100 / Ref(HaClose, -Param("Period", 10, 1, 100 ) );
// Plot removed
//_SECTION_BEGIN("RSIa");
periods = Param("Periods", 5, 1, 200, 1 );
rxRsi = RSIa( HaClose, periods);
longCond1 = Cross(HaClose, simpleMA);
longCond2 = OsMA > 0;
longCond3 = momentum > 100;
longCond4 = rxRsi > 50;
Buy1 = ((HaOpen < HaClose) AND (HaClose>simpleMA) AND (OsMA > 0) AND (momentum > 100) AND (rxRsi > 50));
Sell1 = ((HaOpen > HaClose) AND (OsMA <= 0)); 
Buyx=ExRem(Buy1,Sell1);
Sellx=ExRem(Sell1,Buy1);
PlotShapes(Buyx*shapeSmallUpTriangle,ColorRGB(0,167,247),0,L,-14); PlotShapes(Sellx*shapeSmallDownTriangle,ColorRGB(0,167,247),0,H,-14);
_SECTION_END();
////////////Volume tai gia
PlotVAPOverlay( Param("lines",260,10,1000,1), Param("width",10,1,99,1), ParamColor("color", colorLightGrey), Param("style",3,0,7,1) );

//_SECTION_BEGIN( "Button fibonance bollinger band" );
function GfxConvertValueToPixelY( Value ) 
{
	local Miny, Maxy, pxchartbottom, pxchartheight; 
	 Miny = Status("axisminy"); 
	 Maxy = Status("axismaxy"); 
	 pxchartbottom = Status("pxchartbottom"); 
	 pxchartheight = Status("pxchartheight"); 
	 return pxchartbottom - floor( 0.5 + ( Value - Miny ) * pxchartheight/ ( Maxy - Miny ) ); 
}
function DrawButton( _x1, _y1, _x2, _y2, RndRectBkClr, CirBkClr )
{
	 GfxSetOverlayMode( 0 );
     GfxSelectPen( RndRectBkClr );
     GfxSelectSolidBrush( RndRectBkClr );
     GfxSetBkColor( RndRectBkClr );
     _x3 = 2;
     _y3 = 2;
     GfxRoundRect( _x1, _y1, _x2, _y2, _x3, _y3 );
     GfxSelectPen( CirBkClr );
     GfxSelectSolidBrush( CirBkClr );
     GfxCircle( ( _x1 + _x2 ) / 2, ( _y1 + _y2 ) / 2, 8 );
}
	 GraphXSpace = 3;
per = Param("Period",20,10,55,1);
TH =IIf(Ref(C,-1) > H,Ref(C,-1),H);
TL=IIf(Ref(C,-1) < L,Ref(C,-1),L);
TR = TH-TL;
TRa= Wilders(TR,per);
UpperBand3 =MA( C, per) + ( 4.2360 * TRa);
UpperBand2=MA( C, per) + ( 2.6180 * TRa);
UpperBand1=MA( C, per) + ( 1.6180 * TRa);
MidPoint=MA(C, per);
LowerBand1=MA( C, per) - ( 1.6180 * TRa);
LowerBand2=MA( C, per) - ( 2.6180 * TRa);
LowerBand3=MA( C, per) - ( 4.2360 * TRa);
	 MouseState = GetCursorMouseButtons();
	 JustClkd = MouseState == 9;
	 MousePx  = Nz( GetCursorXPosition( 1 ) );
	 MousePy  = Nz( GetCursorYPosition( 1 ) );
	 x1 =360;
	 y1 =90; 
	 x2 =380;
	 y2 =110;
	 BtnBkClr = Nz( StaticVarGet( "#BtnBkClr" + Name(), False ), colorPaleBlue );
	 InBtnBkClr = Nz( StaticVarGet( "#InBtnBkClr" + Name(), False ), colorWhite );
	 DrawButton( x1, y1, x2, y2, BtnBkClr, InBtnBkClr );
	 CrsrInBTN = MousePx > x1 AND MousePx < x2 AND MousePy > y1 AND MousePy < y2;
	 mipBTN = Nz( StaticVarGet( "#mipBTN" + Name(), False ) );
	 FrstClick = NOT mipBTN AND CrsrInBTN AND JustClkd; //First Click on the button for "ON"
	 NxtClick = mipBTN AND CrsrInBTN AND JustClkd; //Next Click on the button for "OFF"
	 if( FrstClick )
	 {
		 StaticVarSet( "#yesPlot" + Name(), 1, False );
		 StaticVarSet( "#BtnBkClr" + Name(), colorPaleBlue, False );
		 StaticVarSet( "#InBtnBkClr" + Name(), colorGreen, False );
		 StaticVarSet( "#mipBTN" + Name(), True, False );
	 }
	 if( NxtClick )
	 {
		 StaticVarSet( "#yesPlot" + Name(), Null, False );
		 StaticVarSet( "#BtnBkClr" + Name(), colorPaleBlue, False );
		 StaticVarSet( "#InBtnBkClr" + Name(), colorRed, False );
		 StaticVarSet( "#mipBTN" + Name(), False, False );
	 }
	 
	 yesPlot = Nz( StaticVarGet( "#yesPlot" + Name(), False ), 0 );
	 if( yesPlot )
	 {
		Plot(MidPoint,"",colorGreen,styleLine,0,0,0,0,1);
Plot(UpperBand1,"",colorOrange,styleLine,0,0,0,0,1);
Plot(LowerBand1,"",colorOrange,styleLine,0,0,0,0,0);
	 }
	
	 RequestTimedRefresh( 1 );
//_SECTION_END();

///////////////////////////////////////////////////////
mfyperiod=Param("MFI period",14,5,100);
rsyperiod=Param("RSI period",14,5,100);
zzg=Zig(C,5);
ispeak=zzg>Max(Ref(zzg,-1),Ref(zzg,1));
istrough=zzg<Min(Ref(zzg,-1),Ref(zzg,1));
yp2=LastValue(ValueWhen(ispeak,C,2));
yp1=LastValue(ValueWhen(ispeak,C,1));
yb2=LastValue(ValueWhen(istrough,C,2));
yb1=LastValue(ValueWhen(istrough,C,1));
stchbulld=(yb1<yb2)*(LastValue(ValueWhen(istrough,StochK(15,3),1))>LastValue(ValueWhen(istrough,StochK(15,3),2)));
stchbeard=(yp1>yp2)*(LastValue(ValueWhen(ispeak,StochK(15,3),1))<LastValue(ValueWhen(ispeak,StochK(15,3),2)));
rsybulld=(yb1<yb2)*(LastValue(ValueWhen(istrough,RSI(rsyperiod),1))>LastValue(ValueWhen(istrough,RSI(rsyperiod),2)));
rsybeard=(yp1>yp2)*(LastValue(ValueWhen(ispeak,RSI(rsyperiod),1))<LastValue(ValueWhen(ispeak,RSI(rsyperiod),2)));
mfybulld=(yb1<yb2)*(LastValue(ValueWhen(istrough,MFI(mfyperiod),1))>LastValue(ValueWhen(istrough,MFI(mfyperiod),2)));
mfybeard=(yp1>yp2)*(LastValue(ValueWhen(ispeak,MFI(mfyperiod),1))<LastValue(ValueWhen(ispeak,MFI(mfyperiod),2)));
x=Cum(1);
// Get the x-ordinate of Close at Peaks
xp1=LastValue(ValueWhen(ispeak,x,1))-1;
xp2=LastValue(ValueWhen(ispeak,x,2))-1;
//Get the x-ordinate of Close at Troughs
xb1=LastValue(ValueWhen(istrough,x,1))-1;
xb2=LastValue(ValueWhen(istrough,x,2))-1;

// Get the value of Price At Peaks
yp2=LastValue(ValueWhen(ispeak,C,2));
yp1=LastValue(ValueWhen(ispeak,C,1));
// Get the value of Price At Troughs
yb2=LastValue(ValueWhen(istrough,C,2));
yb1=LastValue(ValueWhen(istrough,C,1));
PlotShapes(IIf(x==xb1+1,shapeSmallCircle,shapeNone),colorDarkOliveGreen,0,L,-30);
PlotShapes(IIf(istrough,shapeSmallCircle,shapeNone),colorCustom3,0,L,-37);
PlotShapes(IIf(x==xb2+1,shapeSmallCircle,shapeNone),colorPaleBlue,0,L,-25);
PlotShapes(IIf(x==xp1+1,shapeSmallCircle+shapePositionAbove,shapeNone),colorDarkRed,0,H,-30);
PlotShapes(IIf(x==xp2+1,shapeSmallCircle+shapePositionAbove,shapeNone),colorDarkRed,0,H,-37);

//////
rocquaban=ROC( C, 14 ) < -10;
rocquamua=ROC( C, 14 ) > 10;
////////////

/////////////
// TIN TUONG
{
TinTuong=
(C > Ref(H,-1) AND C > Ref(H,-2) AND C > Ref(H,-3) AND C > Ref(H,-4)
AND C>=O
AND C>=1.01*Ref(C,-1)
AND C>=Ref(C,-2)
AND V>=Ref(V,-1)
AND C*V>=1000000
AND C*V<500000000
AND Ref(V,-5)>=50000
AND Ref(V,-10)>=50000
AND Ref(V,-15)>=50000
AND Ref(V,-20)>=50000
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND Ref(C,-2)<=1.04*Ref(C,-3)
AND Ref(C,-3)<=1.04*Ref(C,-4)
AND Ref(V,-1)>=100000
AND C>1.3*LLV(L,50))

OR 
(C > 1.01*Ref(C,-1) 
AND C>=Ref(C,-2)
AND C*V<500000000
AND (V >= 1.3*MA(V,50) OR V >= 1.3*MA(V,15))  
AND MA(V,15)>= 100000 
AND MA(V,50)>= 100000 
AND C> MA(C,15) 
AND V>Ref(V,-1)
AND C >= (H + L)/ 2 
AND C > O
AND C*V>=1000000
AND C>1.3*LLV(L,50)
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND Ref(C,-2)<=1.04*Ref(C,-3)
AND Ref(C,-3)<=1.04*Ref(C,-4)
AND Ref(V,-1)>=30000
AND RSI(14)>=58)
AND Ref(V,-5)>=50000
AND Ref(V,-10)>=50000
AND Ref(V,-15)>=50000
AND Ref(V,-20)>=50000

OR
(C > Ref(H,-1) AND C > Ref(H,-2) AND C > Ref(H,-3) AND C > Ref(H,-4)
AND C>MA(C,15)
AND Ref(C,-1)>MA(C,15)
AND C>=O
AND C>=1.01*Ref(C,-1)
AND C*V>=1000000
AND C*V<500000000
AND C>1.3*LLV(L,50)
AND V>=Ref(V,-1)AND Ref(V,-5)>=50000
AND Ref(V,-10)>=50000
AND Ref(V,-15)>=50000
AND Ref(V,-20)>=50000)

OR
(C > 1.01*Ref(C,-1) 
AND C>=Ref(C,-2)
AND RSI(14)>60
AND V >= 1.3*MA(V,30)
AND V>=0.8*Ref(V,-1)
AND MA(V,15)>= 50000 
AND MA(V,50)>= 50000 
AND C> MA(C,15) 
AND C >= (H + L)/ 2 
AND C > O
AND C*V>=1000000
AND C*V<500000000
AND C>1.3*LLV(L,50)
AND Ref(C,-1)<=1.05*Ref(C,-2)
AND Ref(V,-5)>=50000
AND Ref(V,-10)>=50000
AND Ref(V,-15)>=50000
AND Ref(V,-20)>=50000)

OR 
((C > Ref(H,-1) 
AND C > Ref(H,-2) 
AND C > Ref(H,-3) 
AND C > Ref(H,-4)
AND C>=O
AND C>=1.02*Ref(C,-1)
AND Ref(C,-1) <= 1.05*Ref(C,-2)
AND V>=0.8*Ref(V,-1)
AND V >= 1.3*MA(V,15) 
AND C*V>=1000000
AND C*V<500000000
AND Ref(V,-5)>=50000
AND Ref(V,-10)>=50000
AND Ref(V,-15)>=50000
AND Ref(V,-20)>=50000)
OR
(Ref(RSI(14),-1)<=35
AND C>1.02*Ref(C,-1)
AND C*V>=1000000))
OR
(  C > Ref(H,-1) 
AND C > Ref(H,-2) 
AND C > Ref(H,-3) 
AND C > Ref(H,-4)
AND C>=5
AND C>=O
AND C*V>=3000000
AND C*V<500000000
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND Ref(C,-2)<=1.04*Ref(C,-3)
AND C <1.15*LLV(C,10)
)
OR
(
    C > Ref(H,-1) 
AND C > Ref(H,-2) 
AND C > Ref(H,-3) 
AND C > Ref(H,-4)
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND Ref(C,-2)<=1.04*Ref(C,-3)
AND C>=5
AND C>=O
AND C>=1.02*Ref(C,-1)
AND C>=Ref(C,-2)
AND V>=Ref(V,-1)
AND V >= 1.3*MA(V,15) 
AND C*V>=3000000
AND C*V<500000000
AND Ref(V,-5)>=50000
AND Ref(V,-10)>=50000
AND Ref(V,-15)>=50000
AND Ref(V,-20)>=50000
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND Ref(C,-2)<=1.06*Ref(C,-3)
AND Ref(C,-3)<=1.06*Ref(C,-4)
AND Ref(V,-1)>=100000
AND C>=5
AND C>1.3*LLV(L,50)
AND C <1.15*LLV(C,10)
)

OR 
(
C > 1.02*Ref(C,-1) 
AND C>=Ref(C,-2)
AND C*V<500000000
AND V >= 1.3*MA(V,15)  
AND MA(V,15)>= 100000 
AND MA(V,50)>= 100000 
AND C> MA(C,15) 
AND V>Ref(V,-1)
AND C >= (H + L)/ 2 
AND C > O
AND C>=5
AND C*V>=3000000
AND C>1.3*LLV(L,50)
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND Ref(C,-2)<=1.04*Ref(C,-3)
AND Ref(C,-3)<=1.04*Ref(C,-4)
AND Ref(V,-1)>=30000
AND Ref(V,-5)>=50000
AND Ref(V,-10)>=50000
AND Ref(V,-15)>=50000
AND Ref(V,-20)>=50000
AND C>= 0.8*HHV(C,60)
AND C> 1.2*LLV(L,60)
AND C <1.15*LLV(C,10)

)
OR
(
C > Ref(H,-1) 
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND Ref(C,-2)<=1.04*Ref(C,-3)
AND C > Ref(H,-2) 
AND C > Ref(H,-3) 
AND C > Ref(H,-4)
AND C>MA(C,15)
AND Ref(C,-1)>MA(C,15)
AND C>=O
AND C>=5
AND C>=1.02*Ref(C,-1)
AND C*V>=3000000
AND C*V<500000000
AND C>1.3*LLV(L,50)
AND V >= 1.3*MA(V,15)
AND V>=Ref(V,-1)
AND Ref(V,-5)>=50000
AND Ref(V,-10)>=50000
AND Ref(V,-15)>=50000
AND Ref(V,-20)>=50000
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND C <1.15*LLV(C,10)

)


OR
(
C > 1.02*Ref(C,-1) 
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND Ref(C,-2)<=1.04*Ref(C,-3)
AND C>=Ref(C,-2)
AND V >= 1.3*MA(V,15)
AND V>=0.8*Ref(V,-1)
AND MA(V,15)>= 50000 
AND MA(V,50)>= 50000 
AND C> MA(C,15) 
AND C >= (H + L)/ 2 
AND C > O
AND C>=5
AND C*V>=3000000
AND C*V<500000000
AND C>1.3*LLV(L,50)
AND Ref(C,-1)<=1.05*Ref(C,-2)
AND Ref(V,-5)>=50000
AND Ref(V,-10)>=50000
AND Ref(V,-15)>=50000
AND Ref(V,-20)>=50000
AND C>= 0.8*HHV(C,60)
AND C> 1.2*LLV(L,60)
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND C <1.15*LLV(C,10)

)
OR 
( 
C > Ref(H,-1) 
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND Ref(C,-2)<=1.04*Ref(C,-3)
AND C > Ref(H,-2) 
AND C > Ref(H,-3) 
AND C > Ref(H,-4)
AND C>MA(C,15)
AND Ref(C,-1)>MA(C,15)
AND C>=O
AND C>=1.02*Ref(C,-1)
AND V>=Ref(V,-1)
AND C>5
AND C*V>=3000000
AND V >= 1.3*MA(V,15)
AND C <1.15*LLV(C,10)

)

OR
(C > 1.02*Ref(H,-1) 
AND C>=Ref(H,-2)
AND (V >= 1.3*MA(V,50) OR V >= 1.3*MA(V,15))  
AND C >= (H + L)/ 2 
AND C > O
AND C*V>=1000000
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND Ref(C,-2)<=1.04*Ref(C,-3)

AND C>=5
AND C>MA(C,30)
AND C >= Ref(C,-2)
AND C >= Ref(C,-3)
AND C >= Ref(C,-4) 
AND C >= Ref(C,-5)
AND Ref(V,-1) >=30000

AND C <1.15*LLV(C,10)
)
;
}
///////////////

//TheoDoiTrongPhien
{
TheoDoiTrongPhien=(C*V>=1000000
AND C>=4
AND C>= 1.01*Ref(C,-1)
AND MA(V,15) >=100000
AND Ref(V,-5)>=50000
AND Ref(V,-10)>=50000
AND Ref(V,-15)>=50000
AND Ref(V,-20)>=50000
AND C*V<5000000000)
OR
//tanggia
(
C*V>=3000000
AND C>=5
AND C> 1.01*Ref(C,-1)
AND Ref(C,-1) < 1.04*Ref(C,-2)
AND Ref(C,-2) < 1.04*Ref(C,-1)
AND LLV(V,50) >50000
AND C*V<5000000000
AND C>= (H+L)/2
AND C <1.15*LLV(C,10)
)
OR 
//break
(C > 1.02*Ref(H,-1) 
AND C>=Ref(H,-2)
AND (V >= 1.3*MA(V,50) OR V >= 1.3*MA(V,15))  
AND C >= (H + L)/ 2 
AND C > O
AND C*V>=1000000
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND Ref(C,-2)<=1.04*Ref(C,-3)

AND C>=5
AND C>MA(C,30)
AND C >= Ref(C,-2)
AND C >= Ref(C,-3)
AND C >= Ref(C,-4) 
AND C >= Ref(C,-5)
AND C <1.15*LLV(C,10))
OR
//bung no khoi luong
 (V>=1.3*MA(V,30)
AND C>=4
AND C*V >=3000000
AND C>1.02*Ref(C,-1)
AND C>=MA(C,30) 
AND MA(V,30)>=50000
AND C>=O
AND Ref(V,-5)>50000
AND Ref(V,-10)>50000
AND EMA(C,6)> EMA(C,10)
AND V> Ref(V,-1)
AND V> Ref(V,-2))
;

}

 ///BatDay
 {
 BatDay=
 (C*V>=1000000
AND C>=4
AND C>= 1.01*Ref(C,-1)
AND C<MA(C,30)
AND MA(V,15) >=100000
AND Ref(V,-5)>=50000
AND Ref(V,-10)>=50000
AND Ref(V,-15)>=50000
AND Ref(V,-20)>=50000
AND C*V<1000000000
AND HHV(H,15) >1.2*C )

OR

(C*V>=1000000
AND C>=4
AND C<MA(C,30)
AND MA(V,15) >=100000
AND Ref(V,-5)>=50000
AND Ref(V,-10)>=50000
AND Ref(V,-15)>=50000
AND Ref(V,-20)>=50000
AND C*V<1000000000
AND RSI(14) <=35
AND HHV(H,20) >1.2*C
AND C> 1.02*L)

OR 
 (C*V>=3000000
AND C>=5
AND (C-L)/L >=0.02
AND C<MA(C,30)
AND MA(V,15) >=100000
AND C*V<1000000000
AND HHV(H,20) >1.2*C
AND Ref(RSI(14),-1) <=35
AND LLV(V,50) >50000
AND C <1.15*LLV(C,10))

OR
(C*V>=5000000
AND C>=3
AND (C-L)/L >=0.02
AND C<MA(C,30)
AND MA(V,15) >=100000
AND Ref(V,-5)>=50000
AND Ref(V,-10)>=50000
AND Ref(V,-15)>=50000
AND Ref(V,-20)>=50000
AND C*V<1000000000
AND HHV(H,20) >1.2*C
AND Ref(RSI(14),-1) <=35
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND Ref(C,-2)<=1.04*Ref(C,-3))
;
}

 //MuoiGioToi
 {
 MuoiGioToi=(
C>= 0.7*HHV(C,120)
AND C>= 0.7*HHV(C,20)
AND (C- Ref(C,-1))/Ref(C,-1)<= 0.03
AND (Ref(C,-1)- Ref(C,-2))/Ref(C,-2)<= 0.03
AND ( Ref(C,-2)-Ref(C,-1))/Ref(C,-1)<= 0.03
AND ((C - Ref(C,-120))/Ref(C,-120))*100>= 10
AND ((C - Ref(C,-20))/Ref(C,-20))*100>= 10
AND C*V >= 1000000
AND C>=4
AND Ref(V,-1)>=100000
AND Ref(V,-5)>=100000
AND Ref(V,-10)>=100000)

OR 
( HHV(C,5) <1.055* LLV(C,5)
AND C * V >= 1000000 
AND C*V < 500000000
AND C>= (HHV(C,5)+LLV(C,5))/2
AND MA(V,30)>=100000
AND Ref(V,-5)>=100000
AND Ref(V,-10)>=100000
AND Ref(V,-20)>=100000
AND RSI(14)>=40
AND C>=4
AND C>MA(C,30))
 ;
}

//////////////////
mua =  
(C >= Ref(C,-1)
AND C >= Ref(C,-2)
AND C >= Ref(C,-3)
AND C >= Ref(C,-4) 
AND C >= Ref(C,-5)
AND C >= Ref(C,-6)
AND C >= Ref(C,-7) 
AND C >= Ref(C,-8)
AND C >= Ref(C,-9)
AND C >= Ref(C,-10)
AND C >= Ref(C,-11) 
AND C >= Ref(C,-12)
AND C >= Ref(C,-13)
AND C >= Ref(C,-14) 
AND C >= Ref(C,-15)
AND C>5
AND C*V>1000000
)
;
 ban =  
     C <= Ref(C,-1)
AND C <= Ref(C,-2)
AND C <= Ref(C,-3)
AND C <= Ref(C,-4)
AND C <= Ref(C,-5)
AND C <= Ref(C,-6)
AND C <= Ref(C,-7)
AND C <= Ref(C,-8)
AND C <= Ref(C,-9)
AND C <= Ref(C,-10)
AND C <= Ref(C,-11)
AND C <= Ref(C,-12)
AND C <= Ref(C,-13)
AND C <= Ref(C,-14)
AND C <= Ref(C,-15)
AND C <= Ref(C,-16)
AND C <= Ref(C,-17)
AND C <= Ref(C,-18)
AND C <= Ref(C,-19)
AND C <= Ref(C,-20)
 ;
Buybuy = ExRem(mua, ban);
Sellsell = ExRem(ban, mua);
PlotShapes(IIf(Buybuy,shapeUpArrow,shapeNone),colorGreen,0,Low,Offset=-40);
PlotShapes(IIf(Sellsell,shapeDownArrow,shapeNone),colorRed,0,High,Offset=-40);
Covercover= 
C > 1.02*Ref(H,-1) 
AND C>=Ref(H,-2)
AND (V >= 1.3*MA(V,50) OR V >= 1.3*MA(V,15))  
AND C >= (H + L)/ 2 
AND C > O
AND C*V>=1000000
AND Ref(C,-1)<=1.04*Ref(C,-2)
AND Ref(C,-2)<=1.04*Ref(C,-3)
AND Ref(V,-1) <=1.3*MA(V,15)
AND C>=5
AND C>MA(C,30)
AND C >= Ref(C,-2)
AND C >= Ref(C,-3)
AND C >= Ref(C,-4) 
AND C >= Ref(C,-5)
;
PlotShapes(IIf(Covercover, shapeUpArrow,shapeNone),ColorRGB(255,128,192),0,Low,Offset=-40);

muitenbuy= WriteIf(Buybuy,"Buy","");
muitencover=WriteIf(Covercover,"Cover","");
muitensell=WriteIf(Sellsell,"Sell","");

/////Theo Minervini
buyfiter=
C>MA(C,150)
AND C>MA(C,200)
AND MA(C,150)>MA(C,200)
AND MA(C,200) >1.01*LLV(MA(C,200),20)
AND MA(C,50)>MA(C,150)
AND MA(C,50)>MA(C,200)
AND C>1.25*LLV(C,260)
AND C>0.75*HHV(C,260)
AND C >EMA(C,50)
AND C*V>3000000;

BuyMinervini1= 
C>=5
AND C>=O
AND C>=1.02*Ref(C,-1)
AND V>=0.8*Ref(V,-1)
AND V>=Ref(V,-2)
AND V>=Ref(V,-3)
AND V>=Ref(V,-4)
AND V>=Ref(V,-5)
AND V >= MA(V,30) 
AND C>= HHV(C,10)
AND C>= 0.8*HHV(C,20)
AND C>= 0.8*HHV(C,60)
AND C>= 0.8*HHV(C,120)
AND (C- LLV(L,60))/LLV(L,60)>= 0.1
AND (C- LLV(L,120))/LLV(L,120)>= 0.1
AND HHV(C,5) <1.1* LLV(C,5)
AND HHV(C,10) <1.1* LLV(C,10)
AND (C- LLV(L,10))/LLV(L,10)<= 0.1;
BuyMinervini2=BuyMinervini1 AND buyfiter;
BuyMinervinistatus1=WriteIf(BuyMinervini1,"| B-Miner-M","");
BuyMinervinistatus2=WriteIf(BuyMinervini2,"| B-Miner-S","");




GfxSetOverlayMode(0);
GfxSelectFont("Arial",10, 500);
GfxSetBkMode(0); // transparent
GfxSetTextColor( colorViolet );
GfxTextOut("Mui Ten: " , 5, 410);
GfxSetTextColor( colorGreen );
GfxTextOut("" + muitenbuy, 85, 410);
GfxSetTextColor( colorRed );
GfxTextOut("" + muitensell, 85, 410);
GfxSetTextColor( colorCustom12 );
GfxTextOut("" + muitencover, 130, 410);
GfxSetTextColor( colorBlack );
GfxTextOut("" + BuyMinervinistatus1+BuyMinervinistatus2, 200, 410);
  
  _SECTION_END();
///////////////////
_SECTION_BEGIN("hotrokhangcu");
Version(5.20);
 xx=BarIndex();x=xx;Lx=LastValue(x);
 nbar=Param(" Bars",3,2,30,1); 
 npiv=Param(" lookback period",1,1,30,1);
 PivotSymmetry=ParamToggle("Symmetric ","Off|On",0);
 CleanPivots=ParamToggle("Clean","Off|On",1);
 srStyle=ParamToggle("S/R Style","Off|On",0);
 if (PivotSymmetry)
 {
    fc=1;
    pk=H>Ref(HHV(H,nbar*fc),-1) AND Ref(HHV(H,nbar),nbar)<=H;
    pk=pk AND Lx-ValueWhen(pk,x)>nbar*fc;
    tr=L<Ref(LLV(L,nbar*fc),-1) AND Ref(LLV(L,nbar),nbar)>=L;
    tr=tr AND Lx-ValueWhen(tr,x)>nbar*fc;
}
else
{
    fc=2;
    pk=H>Ref(HHV(H,nbar*fc),-1) AND Ref(HHV(H,nbar),nbar)<=H;
    pk=pk AND Lx-ValueWhen(pk,x)>nbar*fc;
    tr=L<Ref(LLV(L,nbar*fc),-1) AND Ref(LLV(L,nbar),nbar)>=L;
    tr=tr AND Lx-ValueWhen(tr,x)>nbar*fc;   
 }
px0=ValueWhen(pk,x,0); tx0=ValueWhen(tr,x,0);
px1=ValueWhen(pk,x,1); tx1=ValueWhen(tr,x,1);
px2=ValueWhen(pk,x,2); tx2=ValueWhen(tr,x,2);
px3=ValueWhen(pk,x,3); tx3=ValueWhen(tr,x,3);
ph0=ValueWhen(pk,H,0); tl0=ValueWhen(tr,L,0);
ph1=ValueWhen(pk,H,1); tl1=ValueWhen(tr,L,1);
ph2=ValueWhen(pk,H,2); tl2=ValueWhen(tr,L,2);
ph3=ValueWhen(pk,H,3); tl3=ValueWhen(tr,L,3);
if (CleanPivots)
 {
    pk=IIf(pk AND px0<tx0 AND ph0>ph1,False,pk);
    tr=IIf(tr AND px0>tx0 AND tl0<tl1,False,tr);
    pk=IIf(pk AND px2>tx1 AND ph1<=ph2,False,pk);
    tr=IIf(tr AND tx2>px1 AND tl1>=tl2,False,tr);
  px0=ValueWhen(pk,x,0); tx0=ValueWhen(tr,x,0);
    px1=ValueWhen(pk,x,1); tx1=ValueWhen(tr,x,1);
    px2=ValueWhen(pk,x,2); tx2=ValueWhen(tr,x,2);
    px3=ValueWhen(pk,x,3); tx3=ValueWhen(tr,x,3);
    ph0=ValueWhen(pk,H,0); tl0=ValueWhen(tr,L,0);
    ph1=ValueWhen(pk,H,1); tl1=ValueWhen(tr,L,1);
    ph2=ValueWhen(pk,H,2); tl2=ValueWhen(tr,L,2);
    ph3=ValueWhen(pk,H,3); tl3=ValueWhen(tr,L,3);      
}
  if(srstyle)
 {
 miny=Status("axisminy");
 maxy=Status("axismaxy");
 for (i=1;i<=npiv;i++)
 {
     rr=Ref(ValueWhen(pk,H,i),-nbar);
     rr=IIf(rr>maxy OR rr<miny,Null,rr);
     ss=Ref(ValueWhen(tr,L,i),-nbar);
     ss=IIf(ss>maxy OR ss<miny,Null,ss);
     Plot(ss,"",colorRed,styleNoLine|styleDots,0,0,0);
}
 }
 else
 {
    rr=ValueWhen(pk,H); 
    rr1=IIf(rr AND BarsSince(pk)>nbar,rr,Null);
    rr2=IIf(rr AND BarsSince(pk)<=nbar,rr,Null);
    ss=ValueWhen(tr,L); 
    ss1=IIf(ss AND BarsSince(tr)>nbar,ss,Null);
    ss2=IIf(ss AND BarsSince(tr)<=nbar,ss,Null);
    Plot(rr1,"",colorRed,1);
    Plot(rr2,"",colorLightGrey,styleDots|styleNoLine);
    Plot(ss1,"",colorGreen,1);
    Plot(ss2,"",colorLightGrey,styleDots | styleNoLine);
 }
 _SECTION_END();

//_SECTION_BEGIN("Parameters"); //Xu Huong
kk = Optimize( "mult", Param( "mult", 1.25, 0.25, 8, 0.25 ), 1, 8, 0.25 );
Per = Optimize( "period", Param( "period", 10, 1, 300, 1 ), 5, 300, 1 );
nm = ( H - L );
j = ( O + H + L + C ) / 4;
rfsctor = WMA( nm, Per );
revers = kk * rfsctor;
Trend = 1;
NW[0] = 0;

for ( i = 1;i < BarCount;i++ )
{
if ( Trend[i-1] == 1 )
{
if ( j[i] < NW[i-1] )
{
Trend[i] = -1;
NW[i] = j[i] + Revers[i];
}
else
{
Trend[i] = 1;

if ( ( j[i] - Revers[i] ) > NW[i-1] )
{
NW[i] = j[i] - Revers[i];
}
else
{
NW[i] = NW[i-1];
}
}
}

if ( Trend[i-1] == -1 )
{
if ( j[i] > NW[i-1] )
{
Trend[i] = 1;
NW[i] = j[i] - Revers[i];
}
else
{
Trend[i] = -1;

if ( ( j[i] + Revers[i] ) < NW[i-1] )
{
NW[i] = j[i] + Revers[i];
}
else
{
NW[i] = NW[i-1];
}
}
}
}
Length = 14;
Price = EMA(Close, Length);
// Keltner 
kLength = Length;
kN = 1.5;
kATR = ATR(kLength);
kUpper = Price + kN * kATR;
kLower = Price - kN * kATR;
// Bollinger
bbLength = Length;
bbN = 2;
bbStDevValues = StDev(Close, bbLength);
bbUpper = Price + bbN * bbStDevValues;
bbLower = Price - bbN * bbStDevValues;
IsBBSqueeze = bbUpper <= kUpper AND bbLower >= kLower;
//////////////////////


GLN24W = C > HHV(Ref(C,-1),120);//120= 120 ngay giao dich/6W=24Tuan=6thang
GNN24W = C < LLV(Ref(C,-1),120);
GLN12W=C > HHV(Ref(C,-1),60);//60= 60 ngay giao dich/12W=12Tuan=3 thang
GNN12W=C < LLV(Ref(C,-1),60);
GLN8W=C > HHV(Ref(C,-1),40);//40= 40 ngay giao dich/8W=8Tuan=2 thang
GNN8W=C < LLV(Ref(C,-1),40);
GLN4W = C > HHV(Ref(C,-1),20);//20= 20 ngay giao dich/4W=4Tuan=1thang
GNN4W = C < LLV(Ref(C,-1),20);
GLN52W = C > HHV(Ref(C,-1),260);//260= 260 ngay giao dich/52W=12 thang
GNN52W = C < LLV(Ref(C,-1),260);
dinh1m=GLN4W AND NOT(GLN8W OR GLN12W OR GLN24W OR GLN52W);
dinh2m=GLN4W AND GLN8W AND NOT (GLN12W OR GLN24W OR GLN52W);
dinh3m=GLN4W AND GLN8W AND GLN12W AND NOT (GLN24W OR GLN52W);
dinh6m=GLN4W AND GLN8W AND GLN12W AND GLN24W AND NOT GLN52W;
dinh1y=GLN4W AND GLN8W AND GLN12W AND GLN24W AND GLN52W;
dinhstatus=WriteIf(dinh1m ,"Dinh 1M",WriteIf(dinh2m,"Dinh 2M",WriteIf(dinh3m,"Dinh 3M",WriteIf(dinh6m,"Dinh 6M",WriteIf(dinh1y,"Dinh 1Y","")))));
///////
day1m=GNN4W AND NOT (GNN8W OR GNN12W OR GNN24W OR GNN52W);
day2m=GNN4W AND GNN8W AND NOT (GNN12W OR GNN24W OR GNN52W);
day3m=GNN4W AND GNN8W AND GNN12W AND NOT(GNN24W OR GNN52W);
day6m=GNN4W AND GNN8W AND GNN12W AND GNN24W AND NOT GNN52W;
day1y=GNN4W AND GNN8W AND GNN12W AND GNN24W AND GNN52W;
daystatus=WriteIf(day1m,"Day 1M",WriteIf(day2m,"Day 2M",WriteIf(day3m,"Day 3M",WriteIf(day6m,"Day 6M",WriteIf(day1y,"Day 1Y","")))));
//////////////
TichLuy_lxt = WriteIf( IsBBSqueeze  and Ref ( IsBBSqueeze, -1) and Ref ( IsBBSqueeze, -2)  and Ref ( IsBBSqueeze, -3 ) and Ref ( IsBBSqueeze, -4 ) and Ref ( IsBBSqueeze, -5 ) and Ref ( IsBBSqueeze, -6 ) and Ref ( IsBBSqueeze, -7 ) and Ref ( IsBBSqueeze, -8 ) and Ref ( IsBBSqueeze, -9 ) and Ref ( IsBBSqueeze, -10 ) ," > 10 Phien ",  WriteIf( IsBBSqueeze  and Ref ( IsBBSqueeze, -1) and Ref ( IsBBSqueeze, -2)  and Ref ( IsBBSqueeze, -3 ) and Ref ( IsBBSqueeze, -4 ) and Ref ( IsBBSqueeze, -5 ) and Ref ( IsBBSqueeze, -6 ) and Ref ( IsBBSqueeze, -7 ) and Ref ( IsBBSqueeze, -8 ) and Ref ( IsBBSqueeze, -9 ) ," 10 Phien ",  
WriteIf( IsBBSqueeze  and Ref ( IsBBSqueeze, -1) and Ref ( IsBBSqueeze, -2)  and Ref ( IsBBSqueeze, -3 ) and Ref ( IsBBSqueeze, -4 ) and Ref ( IsBBSqueeze, -5 ) and Ref ( IsBBSqueeze, -6 ) and Ref ( IsBBSqueeze, -7 ) and Ref ( IsBBSqueeze, -8 ) ," 9 Phien ",  
WriteIf( IsBBSqueeze  and Ref ( IsBBSqueeze, -1) and Ref ( IsBBSqueeze, -2)  and Ref ( IsBBSqueeze, -3 ) and Ref ( IsBBSqueeze, -4 ) and Ref ( IsBBSqueeze, -5 ) and Ref ( IsBBSqueeze, -6 ) and Ref ( IsBBSqueeze, -7 ) ," 8 Phien ",  
WriteIf( IsBBSqueeze  and Ref ( IsBBSqueeze, -1) and Ref ( IsBBSqueeze, -2)  and Ref ( IsBBSqueeze, -3 ) and Ref ( IsBBSqueeze, -4 ) and Ref ( IsBBSqueeze, -5 ) and Ref ( IsBBSqueeze, -6 ) ," 7 Phien ", 
WriteIf( IsBBSqueeze  and Ref ( IsBBSqueeze, -1) and Ref ( IsBBSqueeze, -2)  and Ref ( IsBBSqueeze, -3 ) and Ref ( IsBBSqueeze, -4 ) and Ref ( IsBBSqueeze, -5 ) ," 6 Phien ", 
WriteIf( IsBBSqueeze  and Ref ( IsBBSqueeze, -1) and Ref ( IsBBSqueeze, -2)  and Ref ( IsBBSqueeze, -3 ) and Ref ( IsBBSqueeze, -4 ) ," 5 Phien ", 
WriteIf( IsBBSqueeze  and Ref ( IsBBSqueeze, -1) and Ref ( IsBBSqueeze, -2)  and Ref ( IsBBSqueeze, -3 ) ," 4 Phien ", 
WriteIf( IsBBSqueeze  and Ref ( IsBBSqueeze, -1) and Ref ( IsBBSqueeze, -2) ," 3 Phien ", 
WriteIf( IsBBSqueeze  and Ref ( IsBBSqueeze, -1) ," 2 Phien ", 
WriteIf( IsBBSqueeze ," 1 Phien ", "" )))))))))));



//Dieu Kien qua mua ban
rsiquaban=RSI( 14 ) < 30;
rsiquamua=RSI( 14 ) > 70;
rsina=RSI( 14 ) > 30 AND RSI( 14 ) < 70;
rsistatus_xt=WriteIf(rsiquaban,"R-QB",WriteIf(rsiquamua,"R-QM",WriteIf(rsina,"Range","")));
////////////////
mfiquaban=MFI(14) < 20;
mfina=MFI(14) > 20 AND MFI(14) < 80;
mfiquamua=MFI(14) > 80;
mfistatus_xt=WriteIf(mfiquaban,"M-QB",WriteIf(mfiquamua,"M-QM",WriteIf(mfina,"Range","")));
////////////
dkquamua=rsiquamua+mfiquamua;
dkquaban=rsiquaban+mfiquaban;
tinhieuquamuaban=dkquamua*100/(dkquamua+dkquaban);
tinhieuquamuabanstatus=WriteIf(dkquamua>dkquaban,"OverBought",WriteIf(dkquamua<dkquaban,"OverSold","Range"));


/////////////////////////////
GfxSetOverlayMode(0);
GfxSelectPen( colorGrey40, 0 ); // data tooltip round border color
GfxSelectSolidBrush( colorLavender ); // data tooltip color
GfxRoundRect( 0, 470 , 55 , 487 , 10, 10 ); // data tooltip size
GfxRoundRect( 55, 470 , 110 , 487 , 10, 10 ); // data tooltip size
GfxRoundRect( 110, 470 , 200 , 487 , 10, 10 ); // data tooltip size
GfxSetOverlayMode(0);
GfxSelectFont("Arial",10, 500);
GfxSetBkMode(0); // transparent
GfxSetTextColor( colorDarkOliveGreen );
GfxTextOut(""+rsistatus_xt, 9,470);
GfxTextOut(""+mfistatus_xt, 60,470);
GfxTextOut(""+dkquamua+"/"+dkquaban+":", 120, 470);
GfxTextOut(""+tinhieuquamuabanstatus, 150, 470);
////////
Buyema=EMA(C,13)>EMA(EMA(C,13),9) AND Cross (C,Peak(C,5,1));
Sellema=Cross (EMA(EMA(C,13),9),EMA(C,13));
kckj65=ax11 AND tls>0;
kckj129=ax12 AND tls>0;
htkj65=ay11 AND tls<0;
htkj129=ay12 AND tls<0;
/////////Dieu kien mua
dieukienmua1= C>O;
dieukienmua2= C>bbt;
dieukienmua3= buyCond + lowVolTest2 +lowVolTest + lowVolTest1 + strengthDown1 + strengthDown + noSupplyBar;
dieukienmua4= src1x + src2y;
dieukienmua5= diffsucmanh>0;
dieukienmua6= Buymapk+Buymahpk+HistPosDivergence+MACDPosDivergence+BUY_MACD+MBxt;
dieukienmua7= Buyrsi1+Buypk1+Buypk2+RSI_BUY+Ibuyxt;//+Buyr2+Buyrsi150+Buyrsi130;
dieukienmua8= StrongBuy+MediumBuy+WeakBuy+StrongBuy1+MediumBuy1+WeakBuy1;
dieukienmua9= nt>6;
dieukienmua10= ndc>6;
dieukienmua11= Cross(C,KJ65) OR (C>KJ65 and htkj65);
dieukienmua12= Cross(C,KJ129) OR (C>KJ129 and htkj129);
dieukienmua13= BV>SV;
dieukienmua14=tongbv>tongsv;
dieukienmua15=brma20voltang1+brma20voltang2+tgkd1+tenis;
dieukienmua16= giacatma20up+giacatma50up +giacatma200up +ma20ma65up;
dieukienmua17=dkbuymom+ DynamicRSIbuy;
dieukienmua18=(x==xb1+1);
dieukienmua19=(x==xb2+1);
dieukienmua20=istrough;
dieukienmua21=Buysarxx + Cond1xx + Cond3xx;
dieukienmua22=Bullcandles;
dieukienmua23=BUY_ADX+adxBuyxt;
dieukienmua24=BUY_STOCH+StochBuyxt+Buy1ph+Oversoldxt;
dieukienmua25=OBV_BUY;
dieukienmua26=GAP_UP;
dieukienmua27=intra_buyph;
dieukienmua28=TMBuyxt+POSDIVph+POSDIV1ph;
dieukienmua29=wuxt+wrxtquaban+POSDIV2ph+quabancci+rocquaban;
dieukienmua30=select+Buyswing+Buyema;
dieukienmua31=TinTuong+TheoDoiTrongPhien+BatDay+MuoiGioToi;
dieukienmua32=Covercover+Buybuy+BuyMinervini1+BuyMinervini2;
tinhieumua=dieukienmua1+dieukienmua2+dieukienmua3+dieukienmua4+dieukienmua5+dieukienmua6+dieukienmua7+dieukienmua8+dieukienmua9+dieukienmua10+
			dieukienmua11+dieukienmua12+dieukienmua13+dieukienmua14+dieukienmua15+dieukienmua16+dieukienmua17+dieukienmua18+dieukienmua19+dieukienmua20+
			dieukienmua21+dieukienmua22+dieukienmua23+dieukienmua24+dieukienmua25+dieukienmua26+dieukienmua27+dieukienmua28+dieukienmua29+dieukienmua30+dieukienmua31+dieukienmua32;
///////////Dieu kien ban
dieukienban1= C<O;
dieukienban2= C<bbb;
dieukienban3= trendChange + upThrustBar + noDemandBar;
dieukienban4= src2x + src1y;
dieukienban5= Sellmapk+Sellmahpk+HistNegDivergence+MACDNegDivergence+SELL_MACD+ MSxt;
dieukienban6= Sellrsi1+Sellpk1+Sellpk2+RSI_SELL+Isellxt;//+Sellr2+Sellrsi150+Sellrsi130;
dieukienban7= StrongSell+MediumSell+ WeakSell+StrongSell1+MediumSell1+ WeakSell1;
dieukienban8= nt<4;
dieukienban9= ndc<4;
dieukienban10= diffsucmanh<0;
dieukienban11= Cross(KJ65,C) OR (C<KJ65 AND kckj65);
dieukienban12= Cross(KJ129,C) OR (C<KJ129 AND kckj129);
dieukienban13=BV<SV;
dieukienban14=tongbv<tongsv;
dieukienban15=badaythaphon AND giadongcua1;
dieukienban16=giacatma20dw+giacatma50dw+giacatma200dw+ ma20ma65dw;
dieukienban17=dkSellmom+DynamicRSIsell;
dieukienban18=(x==xp1+1);
dieukienban19=(x==xp2+1);
dieukienban20=Sellsarxx + Cond2xx + Cond4xx;
dieukienban21=Bearcandles;
dieukienban22=SELL_ADX+adxSellxt;
dieukienban23=SELL_STOCH+StochSellxt+Sell1ph+Overboughtxt;
dieukienban24=OBV_SELL;
dieukienban25=GAP_DW;
dieukienban26=intra_sellph;
dieukienban27=TMSellxt+NEGDIVph+NEGDIV1ph;
dieukienban28=wdxt+wrxtquamua + NEGDIV2ph+quamuacci+rocquamua;
dieukienban29=Caution+Sellswing+Sellema;
dieukienban30=Sellsell;
tinhieuban=dieukienban1+dieukienban2+dieukienban3+dieukienban4+dieukienban5+dieukienban6+dieukienban7+dieukienban8+dieukienban9+dieukienban10+
			dieukienban11+dieukienban12+dieukienban13+dieukienban14+dieukienban15+dieukienban16+dieukienban17+dieukienban18+dieukienban19+dieukienban20+
			dieukienban21+dieukienban22+dieukienban23+dieukienban24+dieukienban25+dieukienban26+dieukienban27+dieukienban28+dieukienban29+dieukienban30;
khanangthanhcong=tinhieumua*100/(tinhieumua+tinhieuban);
////////////////////
GfxSetOverlayMode(0);
GfxSelectFont("Arial",10, 500);
GfxSetBkMode(0); // transparent
GfxSetTextColor( colorBlue );
GfxTextOut("Tin hieu mua / ban: ", 5, 22);
GfxSetTextColor( colorBlue );
GfxTextOut("/", 160, 22);
GfxSetTextColor( colorGreen );
GfxTextOut("" +tinhieumua, 140, 22);
GfxSetTextColor( colorRed );
GfxTextOut("" +tinhieuban, 175, 22);
GfxSetTextColor( colorViolet);
GfxTextOut("Xac suat thanh cong : ", 4, 44);
GfxSetTextColor( colorBlack );
GfxTextOut("" +WriteVal(khanangthanhcong,1.2)+" %", 150, 44);
///////////
TinTuongstatus=WriteIf(TinTuong,"*Tiem Nang","");
TheoDoiTrongPhienstatus=WriteIf(TheoDoiTrongPhien,"  *TD","");
BatDaystatus=WriteIf(BatDay,"  *BD","");
MuoiGioToistatus=WriteIf(MuoiGioToi,"  *22H","");
GfxSetTextColor( colorBlue);
GfxTextOut("Thong tin : ", 5, 450);
GfxSetTextColor( colorGreen);
GfxTextOut(""+TinTuongstatus, 80, 450);
GfxSetTextColor( colorBrown);
GfxTextOut(""+TheoDoiTrongPhienstatus, 160, 450);
GfxSetTextColor( colorBlack);
GfxTextOut(""+BatDaystatus, 190, 450);
GfxSetTextColor( colorDarkTeal);
GfxTextOut(""+MuoiGioToistatus, 215, 450);
GfxSetTextColor( colorBlue);
GfxTextOut("Tich Luy   :", 205, 44);
GfxSetTextColor( colorBlack);
GfxTextOut(""+TichLuy_lxt, 300, 44);
GfxSetTextColor( colorBlue);
GfxTextOut("Dinh-Day :", 205, 66);
GfxSetTextColor( colorBlack);
GfxTextOut(""+dinhstatus+daystatus, 300, 66);

///////////////////////////////////////
MACD_XT=MACD(12,26);Signal_XT=Signal(12,26,9);
macdcatSignal=Cross(MACD_XT,Signal_XT);
macdcatSignaldown=Cross(Signal_XT,MACD_XT);
dkmuaRSI=RSI(14)>30 AND Ref(RSI(14),-1)<30 AND Ref(RSI(14),-2)<30;
dkbanRSI=RSI(14)<70 AND Ref(RSI(14),-1)>70 AND Ref(RSI(14),-2)>70;
//////////Mua phan ky
tinhieumuaphanky= Buymapk  OR Buymahpk  OR HistPosDivergence OR MACDPosDivergence OR  Buyrsi1  OR Buyrsi150   OR Buyr2  OR Buypk1  OR Buypk2 OR Buyrsi130;
tinhieubanphanky= Sellmapk OR Sellmahpk OR HistNegDivergence OR MACDNegDivergence OR  Sellrsi1 OR  Sellrsi150 OR Sellr2 OR Sellpk1 OR Sellpk2 OR Sellrsi130;

dkpk_w=khanangthanhcong>=50 AND tinhieumuaphanky AND diffsucmanh> Ref(diffsucmanh,-1); //DIEU KIEN MUA PHAN KY WEAK
dkpk_wstatus=WriteIf(dkpk_w,"Buy W","");
dkpk_m=( dkpk_w AND C > O) 
	OR (khanangthanhcong>=50 AND Ref(tinhieumuaphanky,-1) AND C > O AND diffsucmanh> Ref(diffsucmanh,-1))
	OR (dkpk_w AND C >O  AND Ref(khanangthanhcong,-1)>=50)
	OR  (khanangthanhcong>=50 AND (Ref(tinhieumuaphanky,-1) OR Ref(tinhieumuaphanky,-2) OR Ref(tinhieumuaphanky,-3) OR Ref(tinhieumuaphanky,-4) OR Ref(tinhieumuaphanky,-5)) AND C > O AND diffsucmanh> Ref(diffsucmanh,-1))
	OR (dkpk_w AND C >O  AND (Ref(tinhieumuaphanky,-1) OR Ref(tinhieumuaphanky,-2) OR Ref(tinhieumuaphanky,-3) OR Ref(tinhieumuaphanky,-4) OR Ref(tinhieumuaphanky,-5)) AND Ref(khanangthanhcong,-1)>=50);//DIEU KIEN MUA PHAN KY Medium
dkpk_mstatus=WriteIf(dkpk_m,"-Buy M","");
dkpk_s1=(dkpk_m AND NOT rsiquamua AND dkmuaRSI ) 
	OR (dkpk_m AND (macdcatSignal OR MACD_XT>Signal_XT));//DIEU KIEN MUA PHAN KY STRONG 1
dkpk_s1status=WriteIf(dkpk_s1,"-Buy S1","");
dkpk_s2=dkpk_m AND NOT rsiquamua AND dkmuaRSI AND (macdcatSignal OR MACD_XT>Signal_XT); //DIEU KIEN MUA PHAN KY STRONG 2
dkpk_s2status=WriteIf(dkpk_s2,"-Buy S2","");
dkpk_s3=dkpk_s2 AND diffsucmanh>0 AND diffsucmanh> Ref(diffsucmanh,-1);//DIEU KIEN MUA PHAN KY STRONG 3
dkpk_s3status=WriteIf(dkpk_s3,"-Buy S3","");
//////////Ban phan ky
dkbpk_w=khanangthanhcong<50 AND tinhieubanphanky AND diffsucmanh< Ref(diffsucmanh,-1); //DIEU KIEN MUA PHAN KY WEAK
dkbpk_wstatus=WriteIf(dkbpk_w,"Sell W","");
dkbpk_m=( dkbpk_w AND C < O AND diffsucmanh< Ref(diffsucmanh,-1)) 
	OR (khanangthanhcong<50 AND Ref(tinhieubanphanky,-1) AND C < O AND diffsucmanh< Ref(diffsucmanh,-1))
	OR (dkbpk_w AND C <O  AND Ref(khanangthanhcong,-1)<50)
	OR  (khanangthanhcong<50 AND (Ref(tinhieubanphanky,-1) OR Ref(tinhieubanphanky,-2) OR Ref(tinhieubanphanky,-3) OR Ref(tinhieubanphanky,-4) OR Ref(tinhieubanphanky,-5)) AND C < O AND diffsucmanh< Ref(diffsucmanh,-1))
	OR (dkbpk_w AND C <O  AND (Ref(tinhieubanphanky,-1) OR Ref(tinhieubanphanky,-2) OR Ref(tinhieubanphanky,-3) OR Ref(tinhieubanphanky,-4) OR Ref(tinhieubanphanky,-5)) AND Ref(khanangthanhcong,-1)<50);//DIEU KIEN MUA PHAN KY Medium
dkbpk_mstatus=WriteIf(dkbpk_m,"-Sell M","");
dkbpk_s1=(dkbpk_m AND NOT rsiquaban AND dkbanRSI) 
	OR (dkbpk_m AND (macdcatSignaldown OR MACD_XT<Signal_XT));//DIEU KIEN MUA PHAN KY STRONG 1
dkbpk_s1status=WriteIf(dkbpk_s1,"-Sell S1","");
dkbpk_s2=dkbpk_m AND NOT rsiquaban AND dkbanRSI AND (macdcatSignaldown OR MACD_XT<Signal_XT); //DIEU KIEN MUA PHAN KY STRONG 2
dkbpk_s2status=WriteIf(dkbpk_s2,"-Sell S2","");
dkbpk_s3=dkbpk_s2 AND diffsucmanh<0 AND diffsucmanh< Ref(diffsucmanh,-1);//DIEU KIEN MUA PHAN KY STRONG 3
dkbpk_s3status=WriteIf(dkbpk_s3,"-Sell S3","");

////////////////Mua ichimuku
tinhieumuaichi= StrongBuy OR MediumBuy OR WeakBuy OR StrongBuy1 OR MediumBuy1 OR WeakBuy1;
tinhieubanichi= StrongSell OR MediumSell OR  WeakSell OR StrongSell1 OR MediumSell1 OR WeakSell1;
dkichi_w=khanangthanhcong>=50 AND tinhieumuaichi AND diffsucmanh> Ref(diffsucmanh,-1); //DIEU KIEN MUA  WEAK
dkichi_wstatus=WriteIf(dkichi_w,"Buy W","");
dkichi_m=( dkichi_w AND C > O AND diffsucmanh> Ref(diffsucmanh,-1)) 
	OR (khanangthanhcong>=50 AND Ref(tinhieumuaichi,-1) AND C > O AND diffsucmanh> Ref(diffsucmanh,-1))
	OR (dkichi_w AND C >O  AND Ref(khanangthanhcong,-1)>=50)
	OR  (khanangthanhcong>=50 AND Ref(tinhieumuaichi,-1) AND C > O AND diffsucmanh> Ref(diffsucmanh,-1))
	OR (dkichi_w AND C >O  AND Ref(tinhieumuaichi,-1) AND Ref(khanangthanhcong,-1)>=50);//DIEU KIEN MUA  Medium
dkichi_mstatus=WriteIf(dkichi_m,"-Buy M","");
dkichi_s1=(dkichi_m AND NOT rsiquamua AND dkmuaRSI) 
	OR (dkichi_m AND (macdcatSignal OR MACD_XT>Signal_XT));//DIEU KIEN MUA  STRONG 1
dkichi_s1status=WriteIf(dkichi_s1,"-Buy S1","");
dkichi_s2=dkichi_m AND NOT rsiquamua AND dkmuaRSI AND (macdcatSignal OR MACD_XT>Signal_XT) AND diffsucmanh>0 AND diffsucmanh> Ref(diffsucmanh,-1); //DIEU KIEN MUA  STRONG 2
dkichi_s2status=WriteIf(dkichi_s2,"-Buy S2","");
dkichi_s3=dkichi_s2 AND dieukienmua11 AND dieukienmua12  ;//DIEU KIEN MUA  STRONG 3
dkichi_s3status=WriteIf(dkichi_s3,"-Buy S3","");
////////////////BAN ICHI
dkbichi_w=khanangthanhcong<50 AND tinhieubanichi AND diffsucmanh< Ref(diffsucmanh,-1); //DIEU KIEN BAN  WEAK
dkbichi_wstatus=WriteIf(dkbichi_w,"Sell W","");
dkbichi_m=( dkbichi_w AND C < O) 
	OR (khanangthanhcong<50 AND Ref(tinhieubanichi,-1) AND C < O AND diffsucmanh< Ref(diffsucmanh,-1))
	OR (dkbichi_w AND C <O  AND Ref(khanangthanhcong,-1)<50)
	OR  (khanangthanhcong<50 AND Ref(tinhieubanichi,-1) AND C < O AND diffsucmanh< Ref(diffsucmanh,-1))
	OR (dkbichi_w AND C <O  AND Ref(tinhieubanichi,-1) AND Ref(khanangthanhcong,-1)<50);//DIEU KIEN BAN  Medium
dkbichi_mstatus=WriteIf(dkbichi_m,"-Sell M","");
dkbichi_s1=(dkbichi_m AND NOT rsiquaban AND dkbanRSI ) 
	OR (dkbichi_m AND (macdcatSignaldown OR MACD_XT<Signal_XT));//DIEU KIEN BAN  STRONG 1
dkbichi_s1status=WriteIf(dkbichi_s1,"-Sell S1","");
dkbichi_s2=dkbichi_m AND NOT rsiquaban AND dkbanRSI AND (macdcatSignaldown OR MACD_XT<Signal_XT) AND diffsucmanh<0 AND diffsucmanh< Ref(diffsucmanh,-1); //DIEU KIEN BAN  STRONG 2
dkbichi_s2status=WriteIf(dkbichi_s2,"-Sell S2","");
dkbichi_s3=dkbichi_s2 AND dieukienban11 AND dieukienban12  ;//DIEU KIEN BAN  STRONG 3
dkbichi_s3status=WriteIf(dkbichi_s3,"-Sell S3","");
////////////////////
////////////mua ban theo dieu kien

dkmua_xt=TinTuong OR TheoDoiTrongPhien OR BatDay OR MuoiGioToi OR Covercover OR Buybuy OR BuyMinervini1 OR BuyMinervini2 OR Buyswing;
dkban_xt=Sellsell OR Sellswing;

dkbuy_w=khanangthanhcong>=50 AND dkmua_xt AND diffsucmanh> Ref(diffsucmanh,-1); //DIEU KIEN MUA  WEAK
dkbuy_wstatus=WriteIf(dkbuy_w,"Buy W","");

dkbuy_m=( dkbuy_w AND C > O AND diffsucmanh> Ref(diffsucmanh,-1)) 
	OR (khanangthanhcong>=50 AND Ref(dkmua_xt,-1) AND C > O AND diffsucmanh> Ref(diffsucmanh,-1))
	OR (dkbuy_w AND C >O  AND Ref(khanangthanhcong,-1)>=50)
	OR  (dkbuy_w AND Ref(dkmua_xt,-1) AND C > O)
	OR (dkbuy_w AND C >O  AND Ref(dkmua_xt,-1) AND Ref(khanangthanhcong,-1)>=50);//DIEU KIEN MUA  Medium
dkbuy_mstatus=WriteIf(dkbuy_m,"-Buy M","");

dkbuy_s1=(dkbuy_m AND NOT rsiquamua AND dkmuaRSI AND diffsucmanh> Ref(diffsucmanh,-1)) 
	OR (dkbuy_m AND (macdcatSignal OR MACD_XT>Signal_XT));//DIEU KIEN MUA  STRONG 1
dkbuy_s1status=WriteIf(dkbuy_s1,"-Buy S1","");

dkbuy_s2=dkbuy_m AND NOT rsiquamua AND dkmuaRSI AND (macdcatSignal OR MACD_XT>Signal_XT) AND diffsucmanh>0 AND diffsucmanh> Ref(diffsucmanh,-1); //DIEU KIEN MUA  STRONG 2
dkbuy_s2status=WriteIf(dkbuy_s2,"-Buy S2","");

dkbuy_s3=dkbuy_s2 AND dieukienmua11 AND dieukienmua12  ;//DIEU KIEN MUA  STRONG 3
dkbuy_s3status=WriteIf(dkbuy_s3,"-Buy S3","");
//////////////
dksell_w=khanangthanhcong<50 AND dkban_xt AND diffsucmanh< Ref(diffsucmanh,-1); //DIEU KIEN BAN  WEAK
dksell_wstatus=WriteIf(dksell_w,"Sell W","");

dksell_m=( dksell_w AND C < O AND diffsucmanh< Ref(diffsucmanh,-1)) 
	OR (khanangthanhcong<50 AND Ref(dkban_xt,-1) AND C < O AND diffsucmanh< Ref(diffsucmanh,-1))
	OR (dksell_w AND C <O  AND Ref(khanangthanhcong,-1)<50)
	OR  (dksell_w AND Ref(dkban_xt,-1) AND C < O)
	OR (dksell_w AND C <O  AND Ref(dkban_xt,-1) AND Ref(khanangthanhcong,-1)<50);//DIEU KIEN BAN  Medium
dksell_mstatus=WriteIf(dksell_m,"-Sell M","");

dksell_s1=(dksell_m AND NOT rsiquaban AND dkbanRSI) 
	OR (dksell_m AND (macdcatSignaldown OR MACD_XT<Signal_XT));//DIEU KIEN BAN  STRONG 1
dksell_s1status=WriteIf(dksell_s1,"-Sell S1","");

dksell_s2=dksell_m AND NOT rsiquaban AND dkbanRSI AND (macdcatSignaldown OR MACD_XT<Signal_XT) AND diffsucmanh<0 AND diffsucmanh< Ref(diffsucmanh,-1); //DIEU KIEN BAN  STRONG 2
dksell_s2status=WriteIf(dksell_s2,"-Sell S2","");

dksell_s3=dksell_s2 AND dieukienban11 AND dieukienban12  ;//DIEU KIEN BAN STRONG 3
dksell_s3status=WriteIf(dksell_s3,"-Sell S3","");
////////////////////////
//////////////////////////////

strong_dk1b=C>MA(C,20) OR C>MA(C,50) OR C>MA(C,200) OR C>KJ65 OR C>KJ129;
strong_dk2b=BV>1.2*SV;
strong_dk3b=(C-L)>0.75*(H-L) AND C >= Ref(C,-1) AND C>=MA(C,30) AND C>1.01*Ref(C,-1) AND Ref(C,-1)<1.04*Ref(C,-2) AND C>O;
strong_dk4b=brma20voltang1 OR brma20voltang1 OR tgkd1 OR tenis;
strong_dk3s= C <= Ref(L,-1) AND C <= Ref(L,-2) AND C <= Ref(L,-3) AND C <= Ref(L,-4) AND C<O AND (O-C)>0.75*(H-L);
strong_dk2s=BV*1.2<SV;
strong_dk1s=C<MA(C,20) OR C<MA(C,50) OR C<MA(C,200) OR C<KJ65 OR C<KJ129;
strong_dk4s=badaythaphon AND giadongcua1;

strongbuy_dks= (dkpk_s3 OR  dkichi_s3 OR dkbuy_s3) AND NOT(TheoDoiTrongPhien OR BatDay OR MuoiGioToi);
strongbuy_dkm= (dkpk_s2 OR  dkichi_s2 OR dkbuy_s2) AND NOT(TheoDoiTrongPhien OR BatDay OR MuoiGioToi);
strongbuy_dkw= (dkpk_s1 OR  dkichi_s1 OR dkbuy_s1) AND NOT(TheoDoiTrongPhien OR BatDay OR MuoiGioToi);
strongsell_dks=dkbpk_s3 OR dkbichi_s3 OR dksell_s3;
strongsell_dkm=dkbpk_s2 OR dkbichi_s2 OR dksell_s2;
strongsell_dkw=dkbpk_s1 OR dkbichi_s1 OR dksell_s1;
sbuyw_lxt=strongbuy_dkw AND strong_dk1b AND strong_dk2b OR strong_dk3b OR strong_dk4b;
sbuym_lxt=strongbuy_dkm AND strong_dk1b AND strong_dk2b OR strong_dk3b AND strong_dk4b;
sbuys_lxt=strongbuy_dks AND strong_dk1b AND strong_dk2b AND strong_dk3b AND strong_dk4b;
sbuyW_lxt_status=WriteIf(sbuyw_lxt,"SBuy-W ","");
sbuyM_lxt_status=WriteIf(sbuym_lxt," |  SBuy-M ","");
sbuyS_lxt_status=WriteIf(sbuys_lxt," |  SBuy-S ","");
ssellw_lxt=strongsell_dkw AND strong_dk1s AND strong_dk2s OR strong_dk3s OR strong_dk4s;
ssellm_lxt=strongsell_dkm AND strong_dk1s AND strong_dk2s OR strong_dk3s AND strong_dk4s;
ssells_lxt=strongsell_dks AND strong_dk1s AND strong_dk2s AND strong_dk3s AND strong_dk4s;
ssellW_lxt_status=WriteIf(ssellw_lxt,"SSell-W ","");
ssellM_lxt_status=WriteIf(ssellm_lxt," |  SSell-M ","");
ssellS_lxt_status=WriteIf(ssells_lxt," |  SSell-S ","");
//PlotShapes( IIf(Buy, shapeUpArrow, shapeNone), colorOrange, layer = 0, L, offset = -50);
//PlotShapes( IIf(Sell, shapedownArrow, shapeNone), colorOrange, layer = 0, H, offset = -50);


/////////////////////////////
GfxSetOverlayMode(0);
GfxSelectFont("Arial",8.5, 500);
GfxSetBkMode(0); // transparent
GfxSetTextColor( colorBlue );
GfxTextOut("Phan Ky:", 05, 85);
GfxSetTextColor( colorDarkGreen );
GfxTextOut("" +dkpk_wstatus+dkpk_mstatus+dkpk_s1status+dkpk_s2status+dkpk_s3status, 80, 85);
GfxSetTextColor( colorRed );
GfxTextOut("" +dkbpk_wstatus+dkbpk_mstatus+dkbpk_s1status+dkbpk_s2status+dkbpk_s3status, 80, 85);
GfxSetTextColor( colorBrown );
GfxTextOut("Ichimoku:", 5, 100);
GfxSetTextColor( colorDarkGreen );
GfxTextOut("" +dkichi_wstatus+dkichi_mstatus+dkichi_s1status+dkichi_s2status+dkichi_s3status, 80, 110);
GfxSetTextColor( colorRed );
GfxTextOut("" +dkbichi_wstatus+dkbichi_mstatus+dkbichi_s1status+dkbichi_s2status+dkbichi_s3status, 80, 110);
GfxSetTextColor( colorBlack );
GfxTextOut("Dieu Kien:", 5, 115);
GfxSetTextColor( colorDarkGreen );
GfxTextOut("" +dkbuy_wstatus+dkbuy_mstatus+dkbuy_s1status+dkbuy_s2status+dkbuy_s3status, 80, 115);
GfxSetTextColor( colorRed );
GfxTextOut("" +dksell_wstatus+dksell_mstatus+dksell_s1status+dksell_s2status+dksell_s3status, 80, 115);
GfxSetTextColor( colorGrey40 );
GfxTextOut("------------------------------------------------", 5, 125);
GfxSetOverlayMode(0);
GfxSelectFont("Arial",9, 700);
GfxSetBkMode(0); // transparent
GfxSetTextColor( colorDarkGreen );
GfxTextOut("" +sbuyW_lxt_status+sbuyM_lxt_status+sbuyS_lxt_status, 80, 140);
GfxSetTextColor( colorRed );
GfxTextOut("" +ssellW_lxt_status+ssellM_lxt_status+ssellS_lxt_status, 80, 140);


/////**************PLOT LINE NGANG QUA GIA DONG CUA///////////////////

StartBar=SelectedValue(BarIndex()-200);
FinishBar = EndValue( BarIndex() );
Line_c  = SelectedValue(C);
lineclose= LineArray(startbar, Line_c, finishbar, Line_c, 0, 1);
Colcl   = ParamColor("Color line close", colorCustom16);
Plot(lineclose,"", Colcl,styleDashed,Null,Null,0,0,1);
/////**************END///////////////////

Plot(MA( C, 20 ),"MA20",colorGreen,styleLine|styleLine);


n1 = Param("9 1",9,1,200,1); 
n2 = Param("26:  2",26,1,400,1); 
n3 = Param("26:  3",52,1,600,1); 
 
TenkanSen   =(HHV(H,n1)+LLV(L,n1))/2;             
KijunSen    =(HHV(H,n2)+LLV(L,n2))/2;            
ChinkouSpan =Ref(C,-n2);                          
Cks         = Close;                             
SenkouSpanA =Ref((KijunSen+TenkanSen)/2,-n2);    
SpA         =(KijunSen+TenkanSen)/2;             
SenkouSpanB =Ref((HHV(H,n3)+LLV(L,n3))/2,-n2);    
SpB         =(HHV(H,n3)+LLV(L,n3))/2;            
DL = Ref( C, 25 );
 
 
 _SECTION_BEGIN("Breakout");
 Buyperiods=Param("Breakout periods best is usually 18",5,1,100,1,1);
 Sellperiods=Param("Exit Breakout",5,1,100,1,1);

 HaClose =EMA((O+H+L+C)/4,3); // Woodie 
 //HaClose =(O+H+L+C)/4; 
 HaOpen = AMA( Ref( HaClose, -1 ), 0.5 ); 
 HaHigh = Max( H, Max( HaClose, HaOpen ) ); 
 HaLow = Min( L, Min( HaClose, HaOpen ) ); 
 Buy= C>Ref(HHV(High,Buyperiods),-1) ;
 Sell= C<Ref(LLV(Low,Sellperiods),-1);

 /* exrem is one method to remove surplus strade signals. It removes excessive signals of arrow */
 Buy = ExRem(Buy, Sell);
 Sell = ExRem(Sell, Buy);

 PlotShapes( IIf( Buy, shapeUpTriangle, shapeNone ), colorGreen, layer = 0,yposition = HaLow, offset = -30);
 //PlotShapes( IIf( Buy, shapeSmallCircle, shapeNone ), colorWhite, layer = 0,yposition = HaLow, offset = -8);

 PlotShapes( IIf( Sell, shapeDownTriangle, shapeNone ), colorRed, layer = 0, yposition = HaHigh, offset = -30);
 //PlotShapes( IIf( Sell, shapeSmallCircle, shapeNone ), colorRed, layer = 0, yposition = HaHigh, offset = -8);

 _SECTION_END();

